<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    
    <!-- 1. META DATI PER CATALOGAZIONE -->
    <title>Mappe & Distorsioni: Mercatore</title>
    <meta name="description" content="Laboratorio interattivo sulle proiezioni cartografiche. Analizza visivamente la distorsione delle aree (Groenlandia vs Africa) nella proiezione di Mercatore spostando le nazioni sulla griglia.">
    <meta name="keywords" content="Matematica, Geografia, Proiezioni, Mercatore, Coordinate, Scala, 1EL, 2EL, Mat:Geometria, Mat:Modellizzazione, EU:STEM, Lab">
    <meta name="date" content="2025-12-08">

    <!-- 2. FIX MOBILE -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>Distorsione Mappa Interattiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* 3. CSS FULLSCREEN ROBUSTO */
        html, body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 950 */
            color: #f8fafc;
            width: 100vw; height: 100dvh; /* Altezza dinamica */
            margin: 0; padding: 0;
            overflow: hidden; /* Blocca scroll pagina */
            position: fixed;
            display: flex; flex-direction: column;
        }

        /* Header e Controlli */
        header {
            padding: 1rem;
            background-color: #1e293b; /* Slate 800 */
            border-bottom: 1px solid #334155;
            z-index: 10;
            flex-shrink: 0;
        }

        /* Area Mappa */
        #map-container {
            flex-grow: 1;
            position: relative;
            background-color: #cbd5e1; /* Oceano Grigio/Azzurro spento */
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        svg {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            /* Bordo mappa rimosso per look "infinito" o gestito dal container */
        }

        /* Stili Mappa */
        .graticule {
            fill: none;
            stroke: #64748b; /* Slate 500 */
            stroke-width: 0.5px;
            stroke-opacity: 0.5;
        }
        
        .country {
            fill: #f8fafc; /* Slate 50 */
            stroke: #475569; /* Slate 600 */
            stroke-width: 0.5px;
            cursor: grab;
            transition: fill 0.2s;
        }
        .country:hover { fill: #e2e8f0; }
        .country:active { cursor: grabbing; }

        .selected-country {
            fill: #f43f5e; /* Rose 500 */
            fill-opacity: 0.8;
            stroke: #881337; /* Rose 900 */
            stroke-width: 1.5px;
            filter: drop-shadow(0 0 8px rgba(244, 63, 94, 0.6));
        }

        /* Pannello Info Flottante */
        #info-panel {
            position: absolute;
            bottom: 1rem; left: 1rem; right: 1rem;
            background-color: rgba(15, 23, 42, 0.9); /* Slate 950 glass */
            backdrop-filter: blur(8px);
            border: 1px solid #334155;
            padding: 1rem;
            border-radius: 1rem;
            pointer-events: none; /* Lascia cliccare attraverso se non c'√® interazione */
            transition: all 0.3s;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Rendiamo i pulsanti cliccabili */
        #info-panel button, #info-panel a { pointer-events: auto; }

        /* Data Display */
        .data-value { font-family: 'JetBrains Mono', monospace; color: #facc15; font-weight: bold; }

    </style>
</head>
<body>

    <header class="flex justify-between items-center shadow-lg">
        <div>
            <h1 class="text-lg md:text-xl font-bold text-white flex items-center gap-2">
                <span>üåç</span> Proiezione di Mercatore
            </h1>
            <p class="text-xs text-slate-400 hidden sm:block">Laboratorio di Distorsione Cartografica</p>
        </div>
        <a href="../index.html" class="text-xs font-bold text-slate-400 hover:text-white border border-slate-600 px-3 py-1.5 rounded transition">ESCI</a>
    </header>

    <div id="map-container">
        <svg id="world-map"></svg>
    </div>

    <!-- Pannello Informativo Sovrapposto -->
    <div id="info-panel">
        <div id="tutorial-text">
            <h2 class="text-sm font-bold text-white mb-1 uppercase tracking-wider text-center sm:text-left">Istruzioni</h2>
            <p class="text-xs text-slate-300 leading-relaxed text-center sm:text-left">
                Tocca una nazione e <strong>trascinala</strong> verso i poli o l'equatore.
                Osserva come la sua area cambia per mantenere la scala locale corretta della proiezione.
                <br><span class="text-slate-500 italic">(La Groenlandia sembra enorme al Polo, ma √® piccola all'Equatore!)</span>
            </p>
        </div>

        <div id="stats-display" class="hidden mt-3 pt-3 border-t border-slate-700">
            <div class="grid grid-cols-2 gap-4 text-xs">
                <div>
                    <span class="block text-slate-500 uppercase text-[10px]">Latitudine Orig.</span>
                    <span id="lat-orig" class="data-value">0¬∞</span>
                </div>
                <div>
                    <span class="block text-slate-500 uppercase text-[10px]">Latitudine Attuale</span>
                    <span id="lat-curr" class="data-value">0¬∞</span>
                </div>
                <div class="col-span-2">
                    <span class="block text-slate-500 uppercase text-[10px]">Distorsione Area (Scala Apparente)</span>
                    <div class="w-full bg-slate-700 h-2 rounded-full mt-1 overflow-hidden">
                        <div id="dist-bar" class="bg-rose-500 h-full transition-all duration-100" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between mt-1">
                        <span class="text-[10px] text-slate-500">Reale (100%)</span>
                        <span id="dist-val" class="data-value text-rose-400">100%</span>
                    </div>
                </div>
            </div>
            <div class="mt-3 text-center">
                <button id="reset-button" class="bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-2 px-6 rounded-full transition shadow-lg border border-slate-600">
                    ‚Ü∫ Ripristina Posizione
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script>
        window.onload = function() {
            const container = document.getElementById('map-container');
            const infoPanel = document.getElementById('info-panel');
            const statsDisplay = document.getElementById('stats-display');
            const tutorialText = document.getElementById('tutorial-text');
            
            // Elementi Dati
            const elLatOrig = document.getElementById('lat-orig');
            const elLatCurr = document.getElementById('lat-curr');
            const elDistVal = document.getElementById('dist-val');
            const elDistBar = document.getElementById('dist-bar');

            let width, height, scale;
            let svg, projection, path, graticule;
            let selectedCountry = null;
            let originalCentroid = null;
            let originalLatRad = 0;

            function initMap() {
                // Calcola dimensioni basate sul container flessibile
                width = container.clientWidth;
                height = container.clientHeight;
                
                // Scala Mercatore standard: width / 2PI, ma adattiamola per riempire
                // Limitiamo l'altezza visibile per evitare poli infiniti di Mercatore
                const mapHeight = Math.min(height, width * 0.8); 
                scale = width / (2 * Math.PI); // Scala base per larghezza mondo = width
                
                // Centratura verticale sicura
                const translateY = height / 2;

                d3.select("#world-map").selectAll("*").remove(); // Pulisci
                
                svg = d3.select("#world-map")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", `0 0 ${width} ${height}`);

                projection = d3.geoMercator()
                    .scale(scale)
                    .translate([width / 2, translateY])
                    .center([0, 0]);

                path = d3.geoPath().projection(projection);

                graticule = d3.geoGraticule();

                // Griglia
                svg.append("path")
                    .datum(graticule)
                    .attr("class", "graticule")
                    .attr("d", path);

                // Carica Dati
                d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json").then(data => {
                    const countries = topojson.feature(data, data.objects.countries).features;

                    svg.selectAll(".country")
                        .data(countries)
                        .enter().append("path")
                        .attr("class", "country")
                        .attr("d", path)
                        .on("click", handleCountryClick)
                        .on("touchstart", handleCountryClick); // Supporto touch esplicito
                });
            }

            function getCentroid(d) {
                return path.centroid(d);
            }

            // DRAG BEHAVIOR
            const drag = d3.drag()
                .on("start", function(event, d) {
                    d3.select(this).raise().attr("class", "country selected-country");
                    // Mostra pannello statistiche
                    statsDisplay.classList.remove('hidden');
                    tutorialText.classList.add('hidden'); // Nascondi tutorial per spazio
                })
                .on("drag", function(event, d) {
                    if (selectedCountry && selectedCountry.id === d.id) {
                        // Limiti canvas
                        const x = Math.max(0, Math.min(width, event.x));
                        const y = Math.max(0, Math.min(height, event.y));

                        const newCoords = projection.invert([x, y]);
                        if (!newCoords) return;

                        // Clamp Latitudine per evitare infinito Mercatore (>85¬∞)
                        const latDeg = Math.max(-85, Math.min(85, newCoords[1]));
                        const newLatRad = latDeg * (Math.PI / 180);

                        // Fattore Scala Mercatore: k = 1 / cos(lat)
                        // Scala Relativa = k_nuovo / k_originale = cos(lat_orig) / cos(lat_nuova)
                        const relativeScale = Math.cos(originalLatRad) / Math.cos(newLatRad);

                        // Traslazione per centrare
                        const translateX = x - originalCentroid[0] * relativeScale;
                        const translateY = y - originalCentroid[1] * relativeScale;

                        d3.select(this)
                            .attr("transform", `translate(${translateX}, ${translateY}) scale(${relativeScale})`);

                        updateStats(relativeScale, latDeg);
                    }
                });

            function handleCountryClick(event, d) {
                // Reset precedente
                if (selectedCountry) {
                    svg.selectAll(".country")
                       .attr("class", "country")
                       .attr("transform", "");
                }

                selectedCountry = d;
                const el = d3.select(this);
                
                originalCentroid = getCentroid(d);
                const coords = projection.invert(originalCentroid);
                originalLatRad = coords[1] * (Math.PI / 180);

                el.call(drag);
                
                // Init Stats
                const latDeg = coords[1];
                elLatOrig.innerText = latDeg.toFixed(1) + "¬∞";
                updateStats(1, latDeg);
                
                statsDisplay.classList.remove('hidden');
                tutorialText.classList.add('hidden');
            }

            function updateStats(scale, lat) {
                const percent = (scale * 100);
                
                elLatCurr.innerText = lat.toFixed(1) + "¬∞";
                elDistVal.innerText = percent.toFixed(0) + "%";
                
                // Visual bar (clamped visualmente)
                const barW = Math.min(100, (scale / 5) * 100); // 500% = full bar
                elDistBar.style.width = barW + "%";
                
                // Colore barra in base alla distorsione
                if(scale > 1.5) elDistBar.className = "h-full transition-all duration-75 bg-rose-500";
                else if(scale < 0.8) elDistBar.className = "h-full transition-all duration-75 bg-blue-500";
                else elDistBar.className = "h-full transition-all duration-75 bg-green-500";
            }

            document.getElementById('reset-button').addEventListener('click', () => {
                if (selectedCountry) {
                    svg.selectAll(".country")
                       .filter(d => d.id === selectedCountry.id)
                       .attr("class", "country")
                       .attr("transform", "");
                    selectedCountry = null;
                }
                statsDisplay.classList.add('hidden');
                tutorialText.classList.remove('hidden');
            });

            // Avvio
            initMap();
            
            // Resize fluido
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(initMap, 200);
            });
        };
    </script>
</body>
</html>