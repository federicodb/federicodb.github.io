<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    
    <!-- 1. META DATI PER CATALOGAZIONE (BUILDER) -->
    <title>Laboratorio Frazioni: Operazioni Visive</title>
    <meta name="description" content="Simulatore interattivo per comprendere le operazioni tra frazioni (Somma, Prodotto, Potenza) attraverso modelli visivi (Torte) e retta numerica.">
    <meta name="keywords" content="Matematica, Aritmetica, Frazioni, Numeri Razionali, 1EL, 2EL, Mat:Calcolo, Mat:Modellizzazione, EU:STEM, Lab">
    <meta name="date" content="2025-12-08">

    <!-- 2. FIX MOBILE & VIEWPORT -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        /* 3. CSS FULLSCREEN ROBUSTO */
        html, body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Nero Assoluto AMOLED */
            color: #e5e5e5;
            margin: 0; padding: 0;
            width: 100vw;
            min-height: 100dvh; /* Dynamic Viewport Height */
            overflow-x: hidden; /* Evita scroll orizzontale */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Nascondiamo controlli nativi input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
        
        /* Animazioni fluide */
        .visual-enter { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .marker-transition { transition: cx 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            PieChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Minus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        };

        // --- Utility Functions ---
        const gcd = (a, b) => (!b ? a : gcd(b, a % b));
        const lcm = (a, b) => (a * b) / gcd(a, b);
        const simplify = (n, d) => {
            if (d === 0) return { n: 0, d: 1, err: "Divisione per zero" };
            const divisor = gcd(Math.abs(n), Math.abs(d));
            return { n: n / divisor, d: d / divisor };
        };

        // --- Components ---

        const LaTeX = ({ formula, block = false }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && window.katex) {
                    try {
                        window.katex.render(formula, containerRef.current, { throwOnError: false, displayMode: block });
                    } catch (e) { console.error(e); }
                }
            }, [formula, block]);
            return <span ref={containerRef} className={block ? "block my-2" : ""} />;
        };

        const NumberLine = ({ valA, valB, valRes }) => {
            const values = [valA, valRes];
            if (valB !== null) values.push(valB);
            
            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const start = Math.floor(minVal) - 1;
            const end = Math.ceil(maxVal) + 1;
            const totalRange = end - start;
            const width = 600;
            const height = 100;
            const padding = 40;
            
            const scale = (val) => {
                const effectiveWidth = width - (padding * 2);
                const percent = (val - start) / totalRange; 
                return padding + (percent * effectiveWidth);
            };

            const ticks = [];
            for (let i = start; i <= end; i++) {
                ticks.push(i);
            }

            const Marker = ({ val, color, label, yPos, showLabel }) => {
                if (val < start || val > end) return null; 
                const x = scale(val);
                return (
                    <g className="marker-transition" transform={`translate(${x}, 0)`}>
                        <line x1="0" y1="50" x2="0" y2={yPos} stroke={color} strokeWidth="2" strokeDasharray="4" />
                        <circle cx="0" cy={yPos} r="6" fill={color} stroke="#000000" strokeWidth="2" />
                        {showLabel && (
                            <text x="0" y={yPos - 12} textAnchor="middle" fill={color} fontSize="10" fontWeight="bold" fontFamily="monospace">
                                {label}
                            </text>
                        )}
                    </g>
                );
            };

            return (
                <div className="w-full bg-neutral-900 rounded-xl border border-neutral-800 p-4 mt-6 overflow-x-auto">
                    <div className="flex items-center gap-2 mb-2 text-sm font-bold text-neutral-400">
                        <Icons.Activity /> Retta Numerica
                    </div>
                    {/* FIXED: Commento HTML rimosso per compatibilità JSX */}
                    <div className="min-w-[400px]"> 
                        <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto">
                            <line x1={padding} y1="50" x2={width - padding} y2="50" stroke="#525252" strokeWidth="2" />
                            <polygon points={`${width-padding+5},50 ${width-padding-5},45 ${width-padding-5},55`} fill="#525252" />
                            <polygon points={`${padding-5},50 ${padding+5},45 ${padding+5},55`} fill="#525252" />
                            {ticks.map(t => (
                                <g key={t} transform={`translate(${scale(t)}, 50)`}>
                                    <line x1="0" y1="-5" x2="0" y2="5" stroke="#737373" strokeWidth="2" />
                                    <text x="0" y="20" textAnchor="middle" fill="#737373" fontSize="10">{t}</text>
                                </g>
                            ))}
                            <Marker val={valA} color="#3b82f6" label="A" yPos={30} showLabel={true} />
                            {valB !== null && <Marker val={valB} color="#10b981" label="B" yPos={30} showLabel={true} />}
                            <Marker val={valRes} color="#f59e0b" label="Risultato" yPos={70} showLabel={true} />
                        </svg>
                    </div>
                    <div className="text-xs text-center text-neutral-500 mt-1">Scala visualizzata: da {start} a {end}</div>
                </div>
            );
        };

        const FractionVisualizer = ({ num, den, color = "text-blue-500", bg = "bg-blue-500", label, parts = null }) => {
            const safeDen = den === 0 ? 1 : den;
            const value = num / safeDen;
            const absValue = Math.abs(value);
            const wholeParts = Math.floor(absValue);
            const remainder = absValue - wholeParts; 
            
            const totalCircles = wholeParts + (remainder > 0.0001 ? 1 : 0);
            const displayCircles = totalCircles > 0 ? Array.from({length: totalCircles}, (_, i) => i) : [0];
            const effectiveParts = parts || [{ n: num, color: color, bg: bg }];

            const getCoordinatesForPercent = (percent) => {
                const x = Math.cos(2 * Math.PI * percent);
                const y = Math.sin(2 * Math.PI * percent);
                return [x, y];
            };

            const DrawWedge = ({ startIdx, count, colorClass }) => {
                const startPercent = startIdx / safeDen;
                const endPercent = (startIdx + count) / safeDen;
                
                if (count >= safeDen && Math.abs(count - safeDen) < 0.1) {
                    return <circle cx="0" cy="0" r="1" className={`${colorClass} fill-current opacity-90`} stroke="white" strokeWidth="0.05" />;
                }

                const [startX, startY] = getCoordinatesForPercent(startPercent);
                const [endX, endY] = getCoordinatesForPercent(endPercent);
                const largeArcFlag = (endPercent - startPercent) > 0.5 ? 1 : 0;
                
                const d = `M 0 0 L ${startX} ${startY} A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY} Z`;
                return <path d={d} className={`${colorClass} fill-current opacity-90`} stroke="white" strokeWidth="0.05" />;
            };

            const RenderCircle = ({ circleIndex }) => {
                const startUnit = circleIndex * safeDen;
                const endUnit = (circleIndex + 1) * safeDen;
                const slices = [];
                let currentUnit = 0; 
                
                effectiveParts.forEach(part => {
                    const partStart = currentUnit;
                    const partEnd = currentUnit + part.n;
                    const overlapStart = Math.max(startUnit, partStart);
                    const overlapEnd = Math.min(endUnit, partEnd);
                    
                    if (overlapEnd > overlapStart) {
                        const localStart = overlapStart - startUnit;
                        const localCount = overlapEnd - overlapStart;
                        slices.push(
                            <DrawWedge key={`${circleIndex}-${part.color}`} startIdx={localStart} count={localCount} colorClass={part.color} />
                        );
                    }
                    currentUnit += part.n;
                });

                return (
                    <div className="flex flex-col items-center mx-1 transition-all duration-500 transform hover:scale-110">
                        <svg viewBox="-1.2 -1.2 2.4 2.4" className="w-16 h-16 transform -rotate-90">
                            <circle cx="0" cy="0" r="1" fill="transparent" stroke="#404040" strokeWidth="0.1" />
                            {safeDen <= 24 && Array.from({ length: safeDen }).map((_, i) => {
                                const angle = (i / safeDen) * 360;
                                return <line key={`g-${i}`} x1="0" y1="0" x2="1" y2="0" transform={`rotate(${angle})`} stroke="#404040" strokeWidth="0.02" opacity="0.3" />;
                            })}
                            {slices}
                        </svg>
                    </div>
                );
            };

            return (
                <div className="flex flex-col items-center p-4 bg-neutral-900/50 rounded-xl border border-neutral-800 shadow-lg relative overflow-hidden">
                    <h3 className="text-neutral-400 text-xs uppercase font-bold mb-2 tracking-wider flex items-center gap-2">{label}</h3>
                    <div className="mb-2 text-xl font-bold h-10 flex items-center text-white">
                        <LaTeX formula={`\\frac{${num}}{${den}}`} />
                    </div>
                    
                    <div className="flex flex-wrap justify-center mb-4 gap-2 min-h-[4rem]">
                        {displayCircles.map((c) => <RenderCircle key={c} circleIndex={c} />)}
                    </div>

                    <div className="text-xs font-mono text-neutral-500 mt-2">
                         Valore: {(value * 100).toFixed(1)}%
                    </div>
                    
                    {value < 0 && (
                        <div className="absolute top-2 right-2 text-xs bg-red-900/30 text-red-400 border border-red-800/50 px-2 py-1 rounded">Negativo</div>
                    )}
                </div>
            );
        };

        const FractionInput = ({ val, setVal }) => {
            const updateN = (delta) => setVal({...val, n: (val.n + delta)});
            const updateD = (delta) => {
                const nextD = val.d + delta;
                if (nextD === 0) return; 
                setVal({...val, d: nextD});
            };

            return (
                <div className="flex items-center justify-center w-32 h-24 bg-neutral-900 rounded-xl border border-neutral-800 shadow-inner p-1">
                    <div className="flex flex-col w-full h-full">
                        {/* Numeratore Row */}
                        <div className="flex items-center justify-between flex-1">
                            <button onClick={() => updateN(-1)} className="p-2 text-neutral-500 hover:text-white hover:bg-neutral-800 rounded transition-colors active:scale-95" aria-label="Diminuisci numeratore">
                                <Icons.Minus />
                            </button>
                            <input 
                                type="number" 
                                value={val.n} 
                                onChange={(e) => setVal({...val, n: parseInt(e.target.value)||0})} 
                                className="w-full text-center bg-transparent text-white text-xl font-bold p-0 leading-none focus:outline-none focus:text-blue-400 transition-colors" 
                            />
                            <button onClick={() => updateN(1)} className="p-2 text-neutral-500 hover:text-white hover:bg-neutral-800 rounded transition-colors active:scale-95" aria-label="Aumenta numeratore">
                                <Icons.Plus />
                            </button>
                        </div>
                        
                        {/* Separator Line */}
                        <div className="w-full h-0.5 bg-neutral-600 my-0.5 rounded-full opacity-50"></div>
                        
                        {/* Denominatore Row */}
                        <div className="flex items-center justify-between flex-1">
                            <button onClick={() => updateD(-1)} className="p-2 text-neutral-500 hover:text-white hover:bg-neutral-800 rounded transition-colors active:scale-95" aria-label="Diminuisci denominatore">
                                <Icons.Minus />
                            </button>
                            <input 
                                type="number" 
                                value={val.d} 
                                onChange={(e) => setVal({...val, d: parseInt(e.target.value)||1})} 
                                className="w-full text-center bg-transparent text-white text-xl font-bold p-0 leading-none focus:outline-none focus:text-blue-400 transition-colors" 
                            />
                            <button onClick={() => updateD(1)} className="p-2 text-neutral-500 hover:text-white hover:bg-neutral-800 rounded transition-colors active:scale-95" aria-label="Aumenta denominatore">
                                <Icons.Plus />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ControlPanel = ({ f1, setF1, f2, setF2, op, setOp, exp, setExp }) => {
            return (
                <div className="grid grid-cols-1 md:grid-cols-12 gap-6 items-center bg-neutral-900 p-6 rounded-2xl shadow-xl border border-neutral-800">
                    
                    {/* Frazione A */}
                    <div className="col-span-12 md:col-span-3 flex flex-col items-center gap-3">
                        <label className="text-blue-400 font-bold text-sm tracking-wide">FRAZIONE A</label>
                        <FractionInput val={f1} setVal={setF1} />
                    </div>

                    {/* Operatore */}
                    <div className="col-span-12 md:col-span-2 flex justify-center">
                        <div className="flex flex-col gap-2 w-full max-w-[100px]">
                            <label className="text-neutral-500 text-[10px] text-center uppercase font-bold tracking-widest">Operazione</label>
                            <div className="relative group">
                                <select value={op} onChange={(e) => setOp(e.target.value)} 
                                    className="w-full bg-neutral-800 text-white py-3 px-2 rounded-lg text-2xl font-bold text-center appearance-none border border-neutral-700 group-hover:border-neutral-500 focus:border-blue-500 outline-none transition-all cursor-pointer shadow-lg">
                                    <option value="sum">+</option>
                                    <option value="sub">−</option>
                                    <option value="mul">×</option>
                                    <option value="div">÷</option>
                                    <option value="pow">xⁿ</option>
                                </select>
                                <div className="absolute inset-y-0 right-1 flex items-center pointer-events-none text-neutral-500">
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Frazione B o Esponente */}
                    <div className="col-span-12 md:col-span-3 flex flex-col items-center gap-3">
                        {op === 'pow' ? (
                            <>
                                <label className="text-purple-400 font-bold text-sm tracking-wide">ESPONENTE (n)</label>
                                <div className="flex flex-col items-center justify-center w-full h-24 px-4 bg-neutral-900 rounded-xl border border-neutral-800 shadow-inner">
                                     <input type="range" min="-3" max="3" step="1" value={exp} onChange={(e) => setExp(parseInt(e.target.value))}
                                        className="w-full accent-purple-500 cursor-pointer h-1 bg-neutral-700 rounded-lg appearance-none" />
                                     <div className="flex justify-between w-full text-xs text-neutral-500 font-mono mt-4">
                                        <span>-3</span>
                                        <span className="text-white text-2xl font-bold -mt-3">{exp}</span>
                                        <span>3</span>
                                     </div>
                                </div>
                            </>
                        ) : (
                            <>
                                <label className="text-green-400 font-bold text-sm tracking-wide">FRAZIONE B</label>
                                <FractionInput val={f2} setVal={setF2} />
                            </>
                        )}
                    </div>
                    
                    {/* Descrizione rapida */}
                    <div className="col-span-12 md:col-span-4 bg-neutral-950 p-4 rounded-lg text-sm text-neutral-400 border border-neutral-800 h-24 flex items-center justify-center text-center italic leading-tight">
                        {op === 'sum' && "Trova un denominatore comune per sommare le parti."}
                        {op === 'sub' && "Trova un denominatore comune per sottrarre le parti."}
                        {op === 'mul' && "Moltiplica i numeratori e i denominatori. È come calcolare un'area."}
                        {op === 'div' && "Moltiplicare per l'inverso. Quante volte B sta in A?"}
                        {op === 'pow' && "Moltiplica la frazione per se stessa n volte. Negativo = Inverti."}
                    </div>
                </div>
            );
        };

        const SolutionStep = ({ title, latex, description }) => (
            <div className="mb-6 last:mb-0 border-l-2 border-indigo-500 pl-4 py-1 animate-in fade-in slide-in-from-left-4 duration-500">
                <h4 className="text-indigo-400 font-bold text-sm uppercase mb-1">{title}</h4>
                <p className="text-neutral-300 text-sm mb-2">{description}</p>
                <div className="bg-black p-3 rounded border border-neutral-800 overflow-x-auto shadow-inner text-neutral-200">
                    <LaTeX formula={latex} block={true} />
                </div>
            </div>
        );

        const App = () => {
            const [f1, setF1] = useState({ n: 1, d: 2 });
            const [f2, setF2] = useState({ n: 1, d: 3 });
            const [op, setOp] = useState('sum');
            const [exp, setExp] = useState(2);

            const result = useMemo(() => {
                let resN, resD, steps = [];
                let parts = null; 
                
                if (f1.d === 0 || (op !== 'pow' && f2.d === 0)) {
                    return { n: 0, d: 1, error: "Impossibile dividere per zero", steps: [], parts: null };
                }

                switch (op) {
                    case 'sum':
                        const l = lcm(f1.d, f2.d);
                        const m1 = l / f1.d;
                        const m2 = l / f2.d;
                        const partA = f1.n * m1;
                        const partB = f2.n * m2;
                        resN = partA + partB;
                        resD = l;
                        
                        parts = [
                            { n: partA, color: 'text-blue-500', bg: 'bg-blue-500' },
                            { n: partB, color: 'text-emerald-500', bg: 'bg-emerald-500' }
                        ];

                        steps.push({
                            title: "Minimo Comune Multiplo (mcm)",
                            desc: `Il denominatore comune tra ${f1.d} e ${f2.d} è ${l}.`,
                            latex: `\\text{mcm}(${f1.d}, ${f2.d}) = ${l}`
                        });
                        steps.push({
                            title: "Equivalenza",
                            desc: "Portiamo entrambe le frazioni allo stesso denominatore.",
                            latex: `\\frac{${f1.n}\\cdot${m1}}{${f1.d}\\cdot${m1}} + \\frac{${f2.n}\\cdot${m2}}{${f2.d}\\cdot${m2}} = \\frac{${f1.n * m1}}{${l}} + \\frac{${f2.n * m2}}{${l}}`
                        });
                        steps.push({
                            title: "Somma",
                            desc: "Ora sommiamo i numeratori.",
                            latex: `\\frac{${f1.n * m1} + ${f2.n * m2}}{${l}} = \\frac{${resN}}{${resD}}`
                        });
                        break;
                    case 'sub':
                        const ls = lcm(f1.d, f2.d);
                        const ms1 = ls / f1.d;
                        const ms2 = ls / f2.d;
                        resN = (f1.n * ms1) - (f2.n * ms2);
                        resD = ls;
                        steps.push({ title: "MCM", desc: `Il denominatore comune è ${ls}.`, latex: `\\text{mcm}(${f1.d}, ${f2.d}) = ${ls}` });
                        steps.push({ title: "Sottrazione", desc: "Sottraiamo i numeratori convertiti.", latex: `\\frac{${f1.n * ms1} - ${f2.n * ms2}}{${ls}} = \\frac{${resN}}{${resD}}` });
                        break;
                    case 'mul':
                        resN = f1.n * f2.n;
                        resD = f1.d * f2.d;
                        steps.push({ title: "Moltiplicazione", desc: "Numeratore × Numeratore, Denominatore × Denominatore.", latex: `\\frac{${f1.n}}{${f1.d}} \\cdot \\frac{${f2.n}}{${f2.d}} = \\frac{${resN}}{${resD}}` });
                        break;
                    case 'div':
                        if (f2.n === 0) return { n:0, d:1, error: "Impossibile dividere per zero", steps: [] };
                        resN = f1.n * f2.d;
                        resD = f1.d * f2.n;
                        steps.push({ title: "Reciproco", desc: `Moltiplichiamo per l'inverso della seconda frazione.`, latex: `\\frac{${f1.n}}{${f1.d}} \\cdot \\frac{${f2.d}}{${f2.n}} = \\frac{${resN}}{${resD}}` });
                        break;
                    case 'pow':
                        if (exp === 0) {
                            resN = 1; resD = 1;
                            steps.push({ title: "Esponente Zero", desc: "Qualsiasi numero elevato a 0 fa 1.", latex: `\\left(\\frac{${f1.n}}{${f1.d}}\\right)^{\\scriptscriptstyle 0} = 1` });
                        } else if (exp > 0) {
                            resN = Math.pow(f1.n, exp);
                            resD = Math.pow(f1.d, exp);
                            steps.push({ title: "Potenza Positiva", desc: `Moltiplichiamo la frazione per se stessa ${exp} volte.`, latex: `\\left(\\frac{${f1.n}}{${f1.d}}\\right)^{\\scriptscriptstyle ${exp}} = \\frac{${f1.n}^${exp}}{${f1.d}^${exp}} = \\frac{${resN}}{${resD}}` });
                        } else {
                            const absExp = Math.abs(exp);
                            if (f1.n === 0) return { n:0, d:1, error: "Err: 0^-n", steps: [] };
                            resN = Math.pow(f1.d, absExp);
                            resD = Math.pow(f1.n, absExp);
                            steps.push({ title: "Esponente Negativo", desc: "Invertiamo la base e usiamo l'esponente positivo.", latex: `\\left(\\frac{${f1.n}}{${f1.d}}\\right)^{\\scriptscriptstyle ${exp}} = \\left(\\frac{${f1.d}}{${f1.n}}\\right)^{\\scriptscriptstyle ${absExp}} = \\frac{${resN}}{${resD}}` });
                        }
                        break;
                }

                const simp = simplify(resN, resD);
                if (simp.n !== resN || simp.d !== resD) {
                    steps.push({ title: "Semplificazione", desc: "Riduciamo ai minimi termini.", latex: `\\frac{${resN}}{${resD}} = \\frac{${simp.n}}{${simp.d}}` });
                }

                return { n: simp.n, d: simp.d, rawN: resN, rawD: resD, steps, error: null, parts };
            }, [f1, f2, op, exp]);

            return (
                <div className="min-h-[100dvh] bg-black text-neutral-200 p-4 md:p-8 font-sans">
                    <div className="max-w-6xl mx-auto space-y-8 pb-10">
                        <header className="text-center space-y-2 mb-8">
                            <h1 className="text-4xl md:text-5xl font-black text-white tracking-tight">Fractions Lab</h1>
                            <p className="text-neutral-500 max-w-lg mx-auto">Esplora la matematica visiva: cambia i valori e osserva come le operazioni trasformano le quantità.</p>
                        </header>

                        <ControlPanel f1={f1} setF1={setF1} f2={f2} setF2={setF2} op={op} setOp={setOp} exp={exp} setExp={setExp} />

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            {/* Visualizzazione */}
                            <div className="space-y-6">
                                <div className="bg-neutral-900 rounded-2xl p-6 border border-neutral-800 shadow-xl">
                                    <h2 className="text-xl font-bold mb-6 flex items-center gap-2 text-white"><Icons.PieChart /> Modello Visivo</h2>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 relative">
                                        <FractionVisualizer num={f1.n} den={f1.d} color="text-blue-500" bg="bg-blue-500" label="A" />
                                        {op !== 'pow' && <FractionVisualizer num={f2.n} den={f2.d} color="text-emerald-500" bg="bg-emerald-500" label="B" />}
                                        
                                        <div className="relative">
                                            <div className="hidden md:block absolute top-1/2 -left-4 transform -translate-y-1/2 text-neutral-600"><Icons.ChevronRight /></div>
                                            <FractionVisualizer 
                                                num={result.parts ? result.rawN : result.n} 
                                                den={result.parts ? result.rawD : result.d} 
                                                color="text-amber-500" 
                                                bg="bg-amber-500" 
                                                label="Risultato" 
                                                parts={result.parts} 
                                            />
                                        </div>
                                    </div>

                                    {/* NUOVA SEZIONE: Retta Numerica */}
                                    <NumberLine 
                                        valA={f1.n/f1.d} 
                                        valB={op !== 'pow' ? f2.n/f2.d : null} 
                                        valRes={result.n/result.d}
                                    />

                                    <div className="mt-8 pt-6 border-t border-neutral-800 text-center">
                                        <p className="text-xs text-neutral-500 uppercase tracking-widest mb-3 font-bold">Equazione Completa</p>
                                        <div className="text-2xl md:text-3xl font-bold text-white bg-black inline-block px-8 py-4 rounded-xl shadow-inner border border-neutral-800 min-w-[200px]">
                                            {result.error ? <span className="text-red-400 text-base flex items-center gap-2 justify-center"><Icons.X /> {result.error}</span> : 
                                            <LaTeX formula={op === 'pow' 
                                                ? `\\left(\\frac{${f1.n}}{${f1.d}}\\right)^{\\scriptscriptstyle ${exp}} = \\frac{${result.n}}{${result.d}}`
                                                : `\\frac{${f1.n}}{${f1.d}} ${op==='sum' ? '+' : op==='sub' ? '-' : op==='mul' ? '\\cdot' : '\\div'} \\frac{${f2.n}}{${f2.d}} = \\frac{${result.n}}{${result.d}}`} />}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Spiegazione */}
                            <div className="bg-neutral-900 rounded-2xl p-6 border border-neutral-800 shadow-xl h-full flex flex-col">
                                <h2 className="text-xl font-bold mb-6 flex items-center gap-2 text-white">Procedimento & Logica</h2>
                                <div className="space-y-4 flex-grow">
                                    {result.steps.length === 0 && !result.error && <p className="text-neutral-500 italic text-center py-10">Modifica i valori per vedere i passaggi di calcolo.</p>}
                                    {result.steps.map((step, idx) => <SolutionStep key={idx} title={step.title} description={step.desc} latex={step.latex} />)}
                                </div>
                                <div className="mt-8 bg-indigo-900/10 border border-indigo-500/20 p-4 rounded-lg">
                                    <h4 className="text-indigo-400 font-bold mb-2 flex items-center gap-2 text-sm uppercase tracking-wide"><Icons.Info /> Concetto Chiave</h4>
                                    <p className="text-sm text-neutral-400 leading-relaxed">
                                        {op === 'sum' || op === 'sub' ? "Per sommare o sottrarre, dobbiamo trovare una 'taglia' di fetta comune (MCM). Solo quando le fette sono uguali possiamo contarle." :
                                        op === 'mul' ? "Moltiplicare è come calcolare l'area di un rettangolo con lati dati dalle due frazioni." :
                                        op === 'div' ? "Dividere significa 'quante volte il secondo numero sta nel primo?'. Dividere per 1/2 è come raddoppiare." :
                                        "L'esponente negativo inverte numeratore e denominatore, come una retromarcia."}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
