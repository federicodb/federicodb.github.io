<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Invaders 2.5 - Retro Lab</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Pixel, Mono & Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Press+Start+2P&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        arcade: {
                            bg: '#000000',
                            panel: '#111111',
                            accent: '#22c55e',
                            danger: '#ef4444'
                        },
                        blueprint: {
                            bg: '#f0f9ff',
                            panel: '#ffffff',
                            accent: '#0284c7',
                            danger: '#dc2626'
                        }
                    },
                    fontFamily: {
                        pixel: ['"Press Start 2P"', 'cursive'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* CRT & Scanline Effects */
        body { overflow-x: hidden; touch-action: manipulation; }
        
        .scanlines {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none;
        }

        /* Animations */
        @keyframes pulse-border { 0% { border-color: rgba(34, 197, 94, 0.5); } 50% { border-color: rgba(34, 197, 94, 1); } 100% { border-color: rgba(34, 197, 94, 0.5); } }
        .pulse-active { animation: pulse-border 2s infinite; }

        /* Custom UI */
        .pixel-btn {
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
            transition: all 0.1s;
        }
        .pixel-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }
        
        /* Theme Transition */
        .theme-trans { transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        
        /* Light/Blueprint Mode Overrides */
        .light-mode .scanlines { opacity: 0.3; }
        .light-mode .pixelated { image-rendering: auto; } /* Cleaner lines for blueprint */
    </style>
</head>
<body class="bg-arcade-bg text-slate-100 theme-trans font-sans selection:bg-green-500 selection:text-black">

    <div class="app-container max-w-5xl mx-auto p-2 md:p-6 min-h-screen flex flex-col relative">
        
        <!-- CRT Overlay -->
        <div class="fixed inset-0 scanlines z-50 pointer-events-none h-screen w-screen"></div>

        <!-- Top Bar: Settings & Player -->
        <nav class="flex justify-between items-center mb-6 z-40 bg-slate-900/80 backdrop-blur p-2 rounded border border-slate-700 light-override">
            <div class="flex items-center gap-4">
                <h1 class="font-pixel text-green-400 text-xs md:text-sm hidden md:block">MATH<span class="text-white">INVADERS</span> <span class="text-[8px] text-yellow-400">2.5D</span></h1>
                
                <!-- Toggle Theme -->
                <button onclick="toggleTheme()" class="p-2 rounded hover:bg-slate-700 text-xs md:text-sm" title="Switch Theme">
                    <span id="theme-icon">‚òÄ</span>
                </button>
                
                <!-- Toggle Sound -->
                <button onclick="toggleSound()" class="p-2 rounded hover:bg-slate-700 text-xs md:text-sm relative" title="Sound FX">
                    <span id="sound-icon">üîá</span>
                </button>
            </div>

            <div class="flex items-center gap-4 font-mono text-xs">
                <div class="flex flex-col items-end">
                    <span class="text-slate-400 text-[10px]">PLAYER</span>
                    <input type="text" id="playerName" class="bg-transparent text-right w-24 font-bold focus:outline-none uppercase text-green-400" value="CADET" onchange="S.player=this.value; saveConf();">
                </div>
                <div class="h-8 w-px bg-slate-700"></div>
                <div class="flex flex-col items-end">
                    <span class="text-slate-400 text-[10px]">SCORE</span>
                    <span id="scoreDisplay" class="text-yellow-400 font-bold text-lg">0000</span>
                </div>
            </div>
        </nav>

        <!-- MAIN MENU VIEW -->
        <main id="view-menu" class="flex-1 flex items-center justify-center animate-fade-in relative z-40">
            <div class="w-full max-w-3xl grid md:grid-cols-2 gap-6 p-4">
                
                <!-- Game Config -->
                <div class="bg-arcade-panel border-4 border-slate-700 p-6 rounded shadow-2xl space-y-6 theme-panel">
                    <div>
                        <h2 class="font-pixel text-xs text-blue-400 mb-2 uppercase">1. Protocollo</h2>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setMode('mcm')" id="btn-mode-mcm" class="pixel-btn bg-slate-700 p-3 rounded text-left border-2 border-slate-600 selected-mode">
                                <div class="font-bold text-xs">üöÄ Sincronia</div>
                                <div class="text-[9px] text-slate-400">m.c.m. & Tempo</div>
                            </button>
                            <button onclick="setMode('mcd')" id="btn-mode-mcd" class="pixel-btn bg-slate-700 p-3 rounded text-left border-2 border-slate-600">
                                <div class="font-bold text-xs">üì¶ Ottimizza</div>
                                <div class="text-[9px] text-slate-400">M.C.D. & Spazio</div>
                            </button>
                        </div>
                    </div>

                    <div>
                        <h2 class="font-pixel text-xs text-purple-400 mb-2 uppercase">2. Ambiente</h2>
                        <div id="mcm-scenarios" class="space-y-2">
                            <button onclick="setScenario('retro')" id="scen-retro" class="w-full pixel-btn bg-slate-800 p-2 rounded flex items-center gap-3 border border-slate-600 hover:bg-slate-700 selected-scen">
                                <span class="text-lg">üëæ</span>
                                <div class="text-left">
                                    <div class="font-bold text-[10px]">CLASSIC ARCADE</div>
                                    <div class="text-[8px] text-green-400">2D Pixel Art</div>
                                </div>
                            </button>
                            <button onclick="setScenario('tron')" id="scen-tron" class="w-full pixel-btn bg-slate-800 p-2 rounded flex items-center gap-3 border border-slate-600 hover:bg-slate-700">
                                <span class="text-lg">üèçÔ∏è</span>
                                <div class="text-left">
                                    <div class="font-bold text-[10px]">NEON HIGHWAY</div>
                                    <div class="text-[8px] text-pink-400">2.5D Perspective</div>
                                </div>
                            </button>
                        </div>
                        <div id="mcd-scenarios" class="hidden space-y-2">
                            <button onclick="setScenario('pizza')" id="scen-pizza" class="w-full pixel-btn bg-slate-800 p-2 rounded flex items-center gap-3 border border-slate-600 hover:bg-slate-700 selected-scen">
                                <span class="text-lg">üçï</span>
                                <div class="text-left">
                                    <div class="font-bold text-[10px]">PIZZA SLICER</div>
                                    <div class="text-[8px] text-yellow-400">2D Geometry</div>
                                </div>
                            </button>
                            <button onclick="setScenario('iso')" id="scen-iso" class="w-full pixel-btn bg-slate-800 p-2 rounded flex items-center gap-3 border border-slate-600 hover:bg-slate-700">
                                <span class="text-lg">üèóÔ∏è</span>
                                <div class="text-left">
                                    <div class="font-bold text-[10px]">ISOMETRIC BUILDER</div>
                                    <div class="text-[8px] text-blue-400">2.5D Construction</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Launch Pad -->
                <div class="flex flex-col gap-4">
                    <div class="bg-arcade-panel border-4 border-slate-700 p-6 rounded shadow-2xl flex-1 theme-panel">
                        <h2 class="font-pixel text-xs text-yellow-400 mb-2 uppercase">3. Difficolt√†</h2>
                        <div class="space-y-2 mb-6">
                            <button onclick="setLevel(0)" id="lvl-0" class="w-full text-left text-xs font-mono p-2 hover:bg-slate-700 rounded border border-transparent selected-lvl">üü¢ BASE (x1.0)</button>
                            <button onclick="setLevel(1)" id="lvl-1" class="w-full text-left text-xs font-mono p-2 hover:bg-slate-700 rounded border border-transparent">üü° MID (x1.5)</button>
                            <button onclick="setLevel(2)" id="lvl-2" class="w-full text-left text-xs font-mono p-2 hover:bg-slate-700 rounded border border-transparent">üî¥ PRO (x2.5)</button>
                        </div>
                        
                        <button onclick="initGame()" class="pixel-btn w-full bg-green-600 hover:bg-green-500 text-white font-pixel py-4 rounded text-sm md:text-base border-b-4 border-green-800 flex items-center justify-center gap-2 group">
                            <span>INSERT COIN</span>
                            <span class="animate-pulse">‚ñ∂</span>
                        </button>
                    </div>

                    <div class="bg-black/30 p-2 rounded text-center">
                        <button onclick="toggleView('leaderboard')" class="text-[10px] font-mono text-slate-400 hover:text-white underline">VIEW HIGH SCORES</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- GAME VIEW -->
        <div id="view-game" class="hidden flex-col flex-1 relative z-40 max-w-4xl mx-auto w-full">
            
            <!-- HUD -->
            <div class="flex justify-between items-end mb-2 px-1 font-mono text-xs font-bold text-slate-400">
                <div class="flex gap-2">
                    <span id="hud-level" class="bg-slate-700 text-white px-2 py-1 rounded">LVL 1</span>
                    <span id="hud-mode" class="bg-slate-700 text-blue-300 px-2 py-1 rounded">MCM</span>
                </div>
                <button onclick="abortGame()" class="hover:text-red-400 transition-colors">‚ö† ABORT</button>
            </div>

            <!-- Game Frame -->
            <div class="bg-black rounded-lg border-4 border-slate-700 shadow-2xl relative overflow-hidden flex flex-col flex-1 theme-border">
                
                <!-- Tools / Input -->
                <div class="bg-slate-900 border-b border-slate-800 p-2 md:p-3 flex gap-4 items-center justify-between theme-bg-sec">
                    <!-- Numbers Display -->
                    <div class="flex-1">
                        <div class="text-[9px] text-slate-400 font-pixel mb-1" id="problem-label">TARGETS:</div>
                        <div id="problem-numbers" class="flex flex-wrap gap-2 text-white font-mono text-sm md:text-lg"></div>
                    </div>
                    
                    <!-- Timer Bar (Visual) -->
                    <div class="absolute top-0 left-0 h-1 bg-green-500 transition-all duration-1000 ease-linear z-50" id="time-bar" style="width: 100%"></div>

                    <!-- Input -->
                    <div class="flex items-center gap-2">
                        <button onclick="toggleLab()" class="hidden md:block bg-slate-800 text-indigo-300 px-2 py-2 rounded border border-slate-600 hover:bg-slate-700 text-xs" title="Open Factor Lab">üß™</button>
                        <input type="number" id="game-input" class="bg-black border-2 border-slate-500 text-green-400 font-pixel text-sm w-20 py-2 px-2 text-center focus:border-green-500 focus:outline-none" placeholder="?">
                        <button id="action-btn" class="pixel-btn bg-slate-700 hover:bg-slate-600 text-white font-bold px-3 py-2 rounded border-b-4 border-slate-900 active:border-b-0 text-xs font-pixel">
                            FIRE
                        </button>
                    </div>
                </div>

                <!-- Canvas Area -->
                <div class="relative w-full aspect-[4/3] md:aspect-[16/9] bg-black cursor-crosshair">
                    <canvas id="gameCanvas" class="w-full h-full block"></canvas>
                    
                    <!-- Freeze Overlay (MCM) -->
                    <button id="freeze-btn" onclick="triggerFreeze()" class="hidden absolute bottom-4 left-4 font-pixel text-[10px] bg-cyan-900/80 text-cyan-200 border border-cyan-500 px-3 py-2 rounded hover:bg-cyan-800 z-20">
                        ‚ùÑ FREEZE
                    </button>

                    <!-- Feedback Overlay -->
                    <div id="overlay-feedback" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-black/90 backdrop-blur-sm z-30 p-6 text-center">
                        <div id="fb-emoji" class="text-6xl mb-4 animate-bounce">üèÜ</div>
                        <h3 id="fb-title" class="font-pixel text-xl md:text-2xl text-white mb-2">OTTIMO!</h3>
                        <div class="font-mono text-sm text-slate-300 mb-6 space-y-1">
                            <p>Risultato: <span id="fb-ans" class="text-white font-bold"></span></p>
                            <p>Tempo: <span id="fb-time" class="text-yellow-400"></span>s <span class="text-xs text-slate-500">(Bonus: +<span id="fb-bonus">0</span>)</span></p>
                            <p>Totale: <span id="fb-score" class="text-green-400 text-lg font-bold"></span> pts</p>
                        </div>
                        <button onclick="nextLevel()" class="pixel-btn bg-white text-black font-pixel text-xs px-6 py-3 rounded hover:scale-105">
                            NEXT WAVE ‚ñ∂
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Factor Lab Overlay (Draggable-ish via absolute pos) -->
            <div id="factor-lab" class="hidden absolute top-20 left-2 z-50 bg-slate-900/95 border-2 border-indigo-500 p-3 rounded shadow-xl w-48 font-mono">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-[10px] text-indigo-400">LABORATORIO</span>
                    <button onclick="toggleLab()" class="text-slate-500 hover:text-white">‚úï</button>
                </div>
                <div class="grid grid-cols-4 gap-1 mb-2">
                    <button onclick="labMult(2)" class="bg-slate-800 hover:bg-indigo-600 text-white text-xs py-1">2</button>
                    <button onclick="labMult(3)" class="bg-slate-800 hover:bg-indigo-600 text-white text-xs py-1">3</button>
                    <button onclick="labMult(5)" class="bg-slate-800 hover:bg-indigo-600 text-white text-xs py-1">5</button>
                    <button onclick="labMult(7)" class="bg-slate-800 hover:bg-indigo-600 text-white text-xs py-1">7</button>
                </div>
                <div class="bg-black p-2 border border-slate-700 text-right">
                    <div id="lab-hist" class="text-[9px] text-slate-500 h-4 overflow-hidden"></div>
                    <div class="flex justify-between items-end">
                        <button onclick="labReset()" class="text-[9px] text-red-500">C</button>
                        <span id="lab-res" class="text-green-400 font-bold">1</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD VIEW -->
        <div id="view-leaderboard" class="hidden absolute inset-0 bg-slate-900/95 z-50 flex items-center justify-center p-4">
            <div class="bg-slate-800 border-2 border-slate-600 p-6 rounded max-w-md w-full relative">
                <button onclick="toggleView('menu')" class="absolute top-2 right-2 text-slate-400 hover:text-white">‚úï</button>
                <h2 class="font-pixel text-yellow-400 text-center mb-4">TOP AGENTS</h2>
                <div id="lb-list" class="font-mono text-sm space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
        </div>

    </div>

    <script>
        /** * AUDIO ENGINE (8-bit Synth)
         * Generate sounds on the fly using Web Audio API to keep it single-file.
         */
        var AudioEngine = {
            ctx: null,
            enabled: false,
            init: function() {
                if(!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            play: function(type) {
                if (!this.enabled || !this.ctx) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;
                
                switch (type) {
                    case 'select': // High blip
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(440, now);
                        osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.1);
                        osc.start(now);
                        osc.stop(now + 0.1);
                        break;
                    case 'shoot': // Laser
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(800, now);
                        osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.2);
                        osc.start(now);
                        osc.stop(now + 0.2);
                        break;
                    case 'error': // Low buzz
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, now);
                        osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                        gain.gain.setValueAtTime(0.2, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.3);
                        osc.start(now);
                        osc.stop(now + 0.3);
                        break;
                    case 'win': // Arpeggio
                        this.playTone(523.25, 0, 0.1);
                        this.playTone(659.25, 0.1, 0.1);
                        this.playTone(783.99, 0.2, 0.2);
                        this.playTone(1046.50, 0.4, 0.4);
                        break;
                }
            },
            playTone: function(freq, delay, dur) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.type = 'square';
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime + delay);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + delay + dur);
                osc.start(this.ctx.currentTime + delay);
                osc.stop(this.ctx.currentTime + delay + dur);
            }
        };

        /**
         * GAME STATE & CONFIG
         */
        var S = {
            player: 'CADET',
            score: 0,
            mode: 'mcm', // 'mcm' | 'mcd'
            scenario: 'retro', // 'retro'|'tron' (MCM), 'pizza'|'iso' (MCD)
            difficulty: 0,
            levels: [
                { id:0, name:"BASE", nums:3, max:10, time: 60, mult:1.0 },
                { id:1, name:"MID",  nums:3, max:20, time: 45, mult:1.5 },
                { id:2, name:"PRO",  nums:4, max:30, time: 30, mult:2.5 }
            ],
            // Runtime
            currentNums: [],
            target: 0,
            userVal: 0,
            startTime: 0,
            frozen: false,
            animFrame: null,
            lab: { val: 1, hist: [] },
            particles: [],
            theme: 'dark' // dark | light
        };

        // --- MATH UTILS ---
        var gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
        var lcm = (a, b) => (a * b) / gcd(a, b);
        var arrLcm = arr => arr.reduce(lcm);
        var arrGcd = arr => arr.reduce(gcd);
        var primes = [2, 3, 5, 7, 11, 13, 17, 19];

        // --- INIT ---
        window.onload = () => {
            // Load Settings
            if(localStorage.getItem('mi2_player')) S.player = localStorage.getItem('mi2_player');
            if(localStorage.getItem('mi2_score')) S.score = parseInt(localStorage.getItem('mi2_score'));
            document.getElementById('playerName').value = S.player;
            document.getElementById('scoreDisplay').innerText = S.score.toString().padStart(4,'0');
            
            // Setup Canvas
            const cvs = document.getElementById('gameCanvas');
            
            // Set Defaults
            setMode('mcm');
            setLevel(0);
            updateThemeUI();
        };

        function saveConf() {
            localStorage.setItem('mi2_player', S.player);
        }

        // --- UI HANDLERS ---
        function toggleTheme() {
            S.theme = S.theme === 'dark' ? 'light' : 'dark';
            updateThemeUI();
        }

        function updateThemeUI() {
            const body = document.body;
            const btn = document.getElementById('theme-icon');
            
            if(S.theme === 'light') {
                body.classList.remove('bg-arcade-bg', 'text-slate-100');
                body.classList.add('bg-blueprint-bg', 'text-slate-800', 'light-mode');
                
                // Panel overrides
                document.querySelectorAll('.theme-panel').forEach(el => {
                    el.classList.remove('bg-arcade-panel', 'border-slate-700', 'text-white');
                    el.classList.add('bg-white', 'border-slate-300', 'text-slate-800');
                });
                
                btn.innerText = 'üåô';
            } else {
                body.classList.add('bg-arcade-bg', 'text-slate-100');
                body.classList.remove('bg-blueprint-bg', 'text-slate-800', 'light-mode');
                
                document.querySelectorAll('.theme-panel').forEach(el => {
                    el.classList.add('bg-arcade-panel', 'border-slate-700', 'text-white');
                    el.classList.remove('bg-white', 'border-slate-300', 'text-slate-800');
                });
                
                btn.innerText = '‚òÄ';
            }
        }

        function toggleSound() {
            AudioEngine.init();
            AudioEngine.enabled = !AudioEngine.enabled;
            document.getElementById('sound-icon').innerText = AudioEngine.enabled ? 'üîä' : 'üîá';
            if(AudioEngine.enabled) AudioEngine.play('select');
        }

        function toggleView(view) {
            ['menu', 'game', 'leaderboard'].forEach(v => {
                document.getElementById('view-'+v).classList.add('hidden');
                if(v === 'game') document.getElementById('view-'+v).classList.remove('flex');
            });
            const el = document.getElementById('view-'+view);
            el.classList.remove('hidden');
            if(view === 'game') el.classList.add('flex');
            
            if(view === 'leaderboard') renderLeaderboard();
        }

        function setMode(m) {
            S.mode = m;
            document.querySelectorAll('#btn-mode-mcm, #btn-mode-mcd').forEach(e => e.classList.remove('selected-mode', 'border-green-500'));
            document.getElementById('btn-mode-'+m).classList.add('selected-mode', 'border-green-500');
            
            // Swap Scenarios
            document.getElementById('mcm-scenarios').classList.toggle('hidden', m !== 'mcm');
            document.getElementById('mcd-scenarios').classList.toggle('hidden', m !== 'mcd');
            
            setScenario(m === 'mcm' ? 'retro' : 'pizza');
            AudioEngine.play('select');
        }

        function setScenario(s) {
            S.scenario = s;
            document.querySelectorAll('#mcm-scenarios button, #mcd-scenarios button').forEach(e => {
                e.classList.remove('border-green-500', 'bg-slate-600');
                e.classList.add('border-slate-600', 'bg-slate-800');
            });
            document.getElementById('scen-'+s).classList.remove('border-slate-600', 'bg-slate-800');
            document.getElementById('scen-'+s).classList.add('border-green-500', 'bg-slate-600');
            AudioEngine.play('select');
        }

        function setLevel(l) {
            S.difficulty = l;
            document.querySelectorAll('[id^=lvl-]').forEach(e => e.classList.remove('bg-slate-600', 'font-bold'));
            document.getElementById('lvl-'+l).classList.add('bg-slate-600', 'font-bold');
            AudioEngine.play('select');
        }

        // --- GAME LOGIC ---

        function initGame() {
            AudioEngine.init(); // Ensure ctx is created on user gesture
            const lvl = S.levels[S.difficulty];
            
            // 1. Generate Numbers
            S.currentNums = [];
            while(S.currentNums.length < lvl.nums) {
                let n = 1;
                // Generate based on primes to ensure clean MCM/MCD
                let count = Math.random() > 0.5 ? 2 : 1;
                for(let i=0; i<count; i++) {
                    let p = primes[Math.floor(Math.random() * 6)]; // Limit primes size
                    n *= p;
                }
                if(n > 1 && n <= 50 && !S.currentNums.includes(n)) S.currentNums.push(n);
            }
            S.currentNums.sort((a,b)=>a-b);

            // 2. Calc Target
            if(S.mode === 'mcm') {
                S.target = arrLcm(S.currentNums);
                document.getElementById('problem-label').innerText = "PERIODI (Trova sincornia):";
            } else {
                // For MCD, ensure numbers share factors sometimes
                if(Math.random()>0.3) {
                    const factor = primes[Math.floor(Math.random()*3)];
                    S.currentNums = S.currentNums.map(x => x*factor);
                }
                S.target = arrGcd(S.currentNums);
                document.getElementById('problem-label').innerText = "DIMENSIONI (Ottimizza spazio):";
            }

            // 3. UI Setup
            const numContainer = document.getElementById('problem-numbers');
            numContainer.innerHTML = '';
            S.currentNums.forEach(n => {
                let d = document.createElement('div');
                d.className = "bg-slate-800 px-2 py-1 rounded border border-slate-600 cursor-help hover:text-green-400";
                d.innerText = n;
                d.onclick = () => { d.innerText = getFactors(n); }; // Didattica: Factor check on click
                numContainer.appendChild(d);
            });

            document.getElementById('hud-level').innerText = lvl.name;
            document.getElementById('hud-mode').innerText = S.mode.toUpperCase();
            document.getElementById('game-input').value = '';
            document.getElementById('overlay-feedback').classList.add('hidden');
            
            // 4. Start Loop
            S.startTime = Date.now();
            S.userVal = 0;
            S.frozen = false;
            
            // Bind Action
            document.getElementById('action-btn').onclick = checkAnswer;
            
            toggleView('game');
            loop();
        }

        function checkAnswer() {
            const val = parseInt(document.getElementById('game-input').value);
            if(!val) return;
            
            S.userVal = val;
            
            if(val === S.target) {
                // WIN
                AudioEngine.play('win');
                const timeTaken = (Date.now() - S.startTime)/1000;
                const maxTime = S.levels[S.difficulty].time;
                
                // Score Algorithm: (Base 100 + TimeBonus) * Multiplier
                const timeBonus = Math.max(0, Math.floor((maxTime - timeTaken) * 10));
                const points = Math.floor((100 + timeBonus) * S.levels[S.difficulty].mult);
                
                S.score += points;
                localStorage.setItem('mi2_score', S.score);
                document.getElementById('scoreDisplay').innerText = S.score.toString().padStart(4,'0');
                
                showFeedback(true, val, timeTaken.toFixed(1), timeBonus, points);
                
                // Save to leaderboard
                let lb = JSON.parse(localStorage.getItem('mi2_lb')||'[]');
                lb.push({ n: S.player, s: S.score });
                lb.sort((a,b)=>b.s - a.s);
                localStorage.setItem('mi2_lb', JSON.stringify(lb.slice(0,10)));
                
            } else {
                // FAIL / TRY AGAIN
                AudioEngine.play('error');
                // Trigger shake effect
                document.getElementById('gameCanvas').classList.add('translate-x-1');
                setTimeout(()=>document.getElementById('gameCanvas').classList.remove('translate-x-1'), 100);
            }
        }

        function showFeedback(win, ans, time, bonus, pts) {
            const ol = document.getElementById('overlay-feedback');
            ol.classList.remove('hidden');
            document.getElementById('fb-ans').innerText = ans;
            document.getElementById('fb-time').innerText = time;
            document.getElementById('fb-bonus').innerText = bonus;
            document.getElementById('fb-score').innerText = pts;
        }

        function abortGame() {
            cancelAnimationFrame(S.animFrame);
            toggleView('menu');
        }
        
        function nextLevel() {
            initGame();
        }

        // --- HELPER MATH ---
        function getFactors(n) {
            let factors = [];
            let d = 2;
            let temp = n;
            while(d * d <= temp) {
                while(temp % d === 0) { factors.push(d); temp /= d; }
                d++;
            }
            if(temp > 1) factors.push(temp);
            return factors.join('¬∑');
        }

        // --- FACTOR LAB ---
        function toggleLab() { document.getElementById('factor-lab').classList.toggle('hidden'); }
        function labMult(n) { 
            S.lab.val *= n; 
            S.lab.hist.push(n);
            updateLabUI();
        }
        function labReset() {
            S.lab.val = 1;
            S.lab.hist = [];
            updateLabUI();
        }
        function updateLabUI() {
            document.getElementById('lab-res').innerText = S.lab.val;
            document.getElementById('lab-hist').innerText = S.lab.hist.join('¬∑');
            // Auto copy to input
            document.getElementById('game-input').value = S.lab.val;
        }
        function triggerFreeze() {
             if(S.mode === 'mcm') S.frozen = !S.frozen;
        }

        // --- RENDER LOOP ---
        function loop() {
            const cvs = document.getElementById('gameCanvas');
            const ctx = cvs.getContext('2d');
            
            // Resize if needed
            if(cvs.width !== cvs.clientWidth) {
                cvs.width = cvs.clientWidth;
                cvs.height = cvs.clientHeight;
            }
            
            const w = cvs.width;
            const h = cvs.height;
            const time = (Date.now() - S.startTime) / 1000;
            const maxTime = S.levels[S.difficulty].time;
            
            // Clear Background (Theme aware)
            ctx.fillStyle = S.theme === 'light' ? '#f0f9ff' : '#000000';
            ctx.fillRect(0,0,w,h);
            
            // Draw Specific Game Mode
            if(S.mode === 'mcm') {
                if(S.scenario === 'retro') drawMCM_Retro(ctx, w, h, time);
                else drawMCM_Tron(ctx, w, h, time); // 2.5D
            } else {
                if(S.scenario === 'pizza') drawMCD_Pizza(ctx, w, h);
                else drawMCD_Iso(ctx, w, h); // 2.5D
            }
            
            // Update Timer Bar
            const remainingPct = Math.max(0, (maxTime - time) / maxTime) * 100;
            const bar = document.getElementById('time-bar');
            bar.style.width = remainingPct + "%";
            if(remainingPct < 20) bar.className = "absolute top-0 left-0 h-1 bg-red-500 animate-pulse z-50";
            else bar.className = "absolute top-0 left-0 h-1 bg-green-500 z-50";

            if(!S.frozen) S.animFrame = requestAnimationFrame(loop);
            else requestAnimationFrame(loop); // Keep drawing but don't advance physics if frozen logic existed
        }

        // --- RENDERERS ---

        /**
         * MCM: RETRO
         * Classic Space Invaders style. Aliens drop down.
         */
        function drawMCM_Retro(ctx, w, h, t) {
            const colors = S.theme === 'light' ? ['#ef4444', '#f59e0b', '#10b981'] : ['#ef4444', '#f59e0b', '#22c55e'];
            const cy = h/2;
            
            S.currentNums.forEach((n, i) => {
                const speed = 20 + (i*10);
                const progress = (t * speed) % w;
                
                // Draw Line
                ctx.strokeStyle = S.theme === 'light' ? '#cbd5e1' : '#334155';
                ctx.beginPath(); ctx.moveTo(0, 50 + i*60); ctx.lineTo(w, 50 + i*60); ctx.stroke();
                
                // Draw Invader
                const x = (t * (w/n) * 20) % w; // Speed relative to number magnitude
                
                ctx.fillStyle = colors[i % 3];
                // Simple Invader Shape
                ctx.fillRect(x, 40 + i*60, 20, 20);
                // Eyes
                ctx.fillStyle = S.theme === 'light' ? '#fff' : '#000';
                ctx.fillRect(x+4, 45 + i*60, 4, 4);
                ctx.fillRect(x+12, 45 + i*60, 4, 4);
                
                // Draw Period Markers
                if(S.userVal > 0) {
                     // Visualize user guess
                     const gx = (t * (w/S.userVal) * 20) % w;
                     ctx.fillStyle = S.theme === 'light' ? '#3b82f6' : '#fff';
                     ctx.fillRect(gx, h-20, 4, 20);
                }
            });
        }

        /**
         * MCM: TRON (2.5D)
         * Perspective highway. Lines come towards camera.
         */
        function drawMCM_Tron(ctx, w, h, t) {
            const cx = w/2;
            const cy = h/2;
            
            // Horizon
            ctx.fillStyle = S.theme === 'light' ? '#e2e8f0' : '#1e293b';
            ctx.fillRect(0, cy, w, h/2);
            
            // Grid Lines (Perspective)
            ctx.strokeStyle = S.theme === 'light' ? '#94a3b8' : '#ec4899';
            ctx.lineWidth = 2;
            
            // Lanes
            S.currentNums.forEach((n, i) => {
                // Determine lane x
                const laneW = w / (S.currentNums.length + 1);
                const lx = (i+1) * laneW;
                
                // Draw vanishing lines
                ctx.beginPath();
                ctx.moveTo(cx, cy); // Horizon center
                ctx.lineTo(lx, h);
                ctx.stroke();
                
                // Draw moving bars (The multiples)
                // z goes from 100 (far) to 0 (close)
                // period determines freq
                
                const speed = 20; // global speed
                const dist = (t * speed);
                
                for(let k=0; k<10; k++) {
                    // Logic: Multiples are markers on the track
                    // We simulate z-depth
                    let markerPos = (dist + k*20) % (n * 10); 
                    // This is rough visual approximation of rhythm, not exact sim
                    
                    let z = (markerPos / (n*10)); // 0 to 1
                    // Invert z for rendering (0 is far, 1 is close)
                    let pz = 1 - z;
                    
                    if(pz > 0 && pz < 1) {
                        let y = cy + (pz * (h/2));
                        // x expands from center
                        let x_center = cx + (lx - cx) * pz;
                        let width = 10 + (40 * pz);
                        
                        ctx.fillStyle = i%2==0 ? '#22c55e' : '#3b82f6';
                        ctx.fillRect(x_center - width/2, y, width, 4 * pz);
                    }
                }
            });
        }

        /**
         * MCD: PIZZA (2D)
         * Circles being sliced.
         */
        function drawMCD_Pizza(ctx, w, h) {
            const cx = w/2;
            const cy = h/2;
            const r = Math.min(w,h)/3;
            
            ctx.strokeStyle = S.theme === 'light' ? '#334155' : '#fff';
            ctx.lineWidth = 2;
            
            // Draw Slices based on User Input (or target ghost)
            const val = S.userVal || S.target;
            const slices = Math.floor(360 / (360/val)); // Just visual logic
            
            // Draw 2 or 3 Pizzas depending on num count
            S.currentNums.forEach((n, i) => {
                const offX = (i - (S.currentNums.length-1)/2) * (r*1.2);
                
                ctx.beginPath();
                ctx.arc(cx + offX, cy, r/2, 0, Math.PI*2);
                ctx.fillStyle = S.theme === 'light' ? '#fed7aa' : '#c2410c';
                ctx.fill();
                ctx.stroke();
                
                // Visualize "n" as area? simpler: visualize N as number of pepperoins?
                // Visualizing MCD is dividing the circle.
                // Let's draw radial lines representing the factor.
                
                if(S.userVal > 0) {
                     const step = (Math.PI*2) / (n / S.userVal);
                     ctx.beginPath();
                     for(let a=0; a<Math.PI*2; a+=step) {
                         ctx.moveTo(cx+offX, cy);
                         ctx.lineTo(cx+offX + Math.cos(a)*r/2, cy + Math.sin(a)*r/2);
                     }
                     ctx.strokeStyle = S.theme === 'light' ? '#000' : '#ffff00';
                     ctx.stroke();
                }
                
                // Label
                ctx.fillStyle = S.theme === 'light' ? '#000' : '#fff';
                ctx.font = "16px monospace";
                ctx.fillText(n, cx+offX-5, cy + r/2 + 20);
            });
        }

        /**
         * MCD: ISOMETRIC (2.5D)
         * Stacking cubes or "Container" filling.
         */
        function drawMCD_Iso(ctx, w, h) {
            const cx = w/2;
            const cy = h/2;
            
            // Simple Isometric Projection Helper
            const toIso = (x, y, z) => {
                return {
                    x: cx + (x - y) * Math.cos(0.523),
                    y: cy + (x + y) * Math.sin(0.523) - z
                };
            };
            
            const drawCube = (x, y, z, sz, color) => {
                const p1 = toIso(x,y,z);
                const p2 = toIso(x+sz,y,z);
                const p3 = toIso(x+sz,y+sz,z);
                const p4 = toIso(x,y+sz,z);
                const p5 = toIso(x,y,z+sz);
                const p6 = toIso(x+sz,y,z+sz);
                const p7 = toIso(x+sz,y+sz,z+sz);
                const p8 = toIso(x,y+sz,z+sz);
                
                ctx.lineWidth = 1;
                ctx.strokeStyle = S.theme === 'light' ? '#1e293b' : '#cbd5e1';
                
                // Top
                ctx.fillStyle = color;
                ctx.beginPath(); ctx.moveTo(p5.x,p5.y); ctx.lineTo(p6.x,p6.y); ctx.lineTo(p7.x,p7.y); ctx.lineTo(p8.x,p8.y); ctx.closePath(); ctx.fill(); ctx.stroke();
                // Right
                ctx.filter = 'brightness(80%)';
                ctx.beginPath(); ctx.moveTo(p6.x,p6.y); ctx.lineTo(p7.x,p7.y); ctx.lineTo(p3.x,p3.y); ctx.lineTo(p2.x,p2.y); ctx.closePath(); ctx.fill(); ctx.stroke();
                // Left
                ctx.filter = 'brightness(60%)';
                ctx.beginPath(); ctx.moveTo(p5.x,p5.y); ctx.lineTo(p8.x,p8.y); ctx.lineTo(p4.x,p4.y); ctx.lineTo(p1.x,p1.y); ctx.closePath(); ctx.fill(); ctx.stroke();
                ctx.filter = 'none';
            };

            // Visualize the numbers as heights of buildings
            const baseSz = 30;
            const gap = 40;
            
            S.currentNums.forEach((n, i) => {
                const offsetX = (i - (S.currentNums.length-1)/2) * gap;
                const hVal = n * 2; // Scale height
                
                // Draw Base "Building"
                drawCube(offsetX, 0, 0, baseSz, S.theme === 'light' ? '#94a3b8' : '#475569');
                
                // If user entered a value, try to stack "modules" (MCD logic)
                if(S.userVal > 0) {
                    const modH = S.userVal * 2;
                    const count = Math.floor(hVal / modH);
                    
                    for(let k=0; k<count; k++) {
                        drawCube(offsetX, 0, k*modH, baseSz*0.9, S.theme === 'light' ? '#38bdf8' : '#0ea5e9');
                    }
                    
                    // Remainder?
                    if(hVal % modH !== 0) {
                        drawCube(offsetX, 0, count*modH, baseSz*0.5, '#ef4444');
                    }
                } else {
                    // Just a monolithic block representing the number
                    // Draw multiple stacked small cubes to represent 'N'
                    // For perf, just draw one tall one
                     const p1 = toIso(offsetX,0,0);
                     const pTop = toIso(offsetX, 0, hVal);
                     ctx.fillStyle = S.theme === 'light' ? '#cbd5e1' : '#fff';
                     ctx.fillText(`H: ${n}`, pTop.x - 10, pTop.y - 10);
                }
            });
        }
        
        // --- LEADERBOARD RENDER ---
        function renderLeaderboard() {
            const list = document.getElementById('lb-list');
            const data = JSON.parse(localStorage.getItem('mi2_lb')||'[]');
            if(!data.length) list.innerHTML = '<div class="text-center text-slate-500">NO DATA</div>';
            else {
                list.innerHTML = data.map((d,i) => `
                    <div class="flex justify-between border-b border-slate-700 pb-1">
                        <span><span class="text-yellow-500">${i+1}.</span> ${d.n}</span>
                        <span class="text-green-400 font-bold">${d.s}</span>
                    </div>
                `).join('');
            }
        }

    </script>
</body>
</html>
