<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>PIP-MATH 3000: Career Edition</title>
    <meta name="description" content="Terminale RobCo Industries. Simulatore avanzato con profili utente, difficolt√† adattiva e classifiche.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font VT323 -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            --pip-green: #14f514;
            --pip-dim: #0f8f0f;
            --pip-bg: #050a05;
            --pip-amber: #ffb700;
            --pip-red: #ff3333;
        }

        body { 
            font-family: 'VT323', monospace; 
            background-color: var(--pip-bg);
            color: var(--pip-green);
            height: 100dvh; width: 100vw;
            overflow: hidden;
            position: fixed;
            -webkit-font-smoothing: antialiased;
            /* DENSIT√Ä PIXEL: Text shadow per dare corpo al testo senza sfocare */
            text-shadow: 0 0 1px rgba(20, 245, 20, 0.6);
        }

        /* Scanlines RIMOSSE come richiesto */
        
        .screen-glow {
            box-shadow: inset 0 0 80px rgba(20, 245, 20, 0.1);
            position: fixed; inset: 0; z-index: 49; pointer-events: none;
        }
        
        /* UI Components */
        .pip-panel {
            border: 2px solid var(--pip-green);
            border-radius: 4px;
            background: rgba(0, 15, 0, 0.96); /* Pi√π opaco per leggibilit√† */
            box-shadow: 0 0 15px var(--pip-dim), inset 0 0 30px rgba(0,0,0,0.9);
            position: relative;
        }
        .pip-panel::before { content:''; position: absolute; top:-2px; left:-2px; width:8px; height:8px; border-top:2px solid var(--pip-green); border-left:2px solid var(--pip-green); }
        .pip-panel::after { content:''; position: absolute; bottom:-2px; right:-2px; width:8px; height:8px; border-bottom:2px solid var(--pip-green); border-right:2px solid var(--pip-green); }

        .pip-btn {
            background: rgba(0, 20, 0, 0.9); 
            border: 1px solid var(--pip-green); 
            color: var(--pip-green);
            text-transform: uppercase; 
            letter-spacing: 1px; 
            transition: all 0.1s;
            text-shadow: 0 0 2px var(--pip-green);
            cursor: pointer;
            user-select: none;
            font-weight: bold; /* Pi√π densit√† */
        }
        .pip-btn:hover:not(:disabled) { background: var(--pip-green); color: black; box-shadow: 0 0 15px var(--pip-green); text-shadow: none; }
        .pip-btn:active:not(:disabled) { transform: translateY(2px); }
        .pip-btn.active { background: var(--pip-green); color: black; box-shadow: 0 0 8px var(--pip-green); font-weight: 900; text-shadow: none; }
        .pip-btn:disabled { border-color: #333; color: #555; cursor: not-allowed; text-shadow: none; }
        
        .pip-input {
            background: #020502; 
            border: 1px solid var(--pip-dim); 
            color: var(--pip-green); 
            font-family: 'VT323', monospace; 
            text-align: center;
            outline: none;
            font-weight: bold;
            text-shadow: 0 0 2px var(--pip-green);
        }
        .pip-input:focus { border-color: var(--pip-green); box-shadow: 0 0 10px var(--pip-dim); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--pip-dim); border: 1px solid var(--pip-green); }
        ::-webkit-scrollbar-thumb:hover { background: var(--pip-green); }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- Overlay FX (Solo Glow, no scanlines) -->
    <div class="screen-glow"></div>

    <!-- 1. INTRO SCREEN (LOGIN) -->
    <div id="view-intro" class="h-full w-full flex items-center justify-center p-4 relative z-20">
        <div class="pip-panel p-8 max-w-md w-full text-center space-y-6 fade-in">
            <h1 class="text-6xl font-black tracking-widest mb-2" style="text-shadow: 0 0 10px var(--pip-green);">PIP-MATH</h1>
            <div class="text-xl text-[#ffb700] tracking-[0.2em] border-b border-[#ffb700] pb-2 mb-4 font-bold">TERMINAL ACCESS v3.1</div>
            
            <div class="space-y-2">
                <label class="block text-sm opacity-70 font-bold">IDENTIFICATIVO AGENTE</label>
                <input type="text" id="login-name" class="pip-input w-full text-3xl py-2 uppercase tracking-wider" placeholder="NOME..." onkeydown="if(event.key==='Enter') APP.login()">
            </div>

            <button onclick="APP.login()" class="pip-btn w-full py-4 text-2xl font-black mt-4">
                INIZIALIZZA SISTEMA
            </button>
            
            <div class="text-xs text-gray-500 mt-4">
                * Dati salvati in locale su questo terminale.
            </div>
        </div>
    </div>

    <!-- 2. GAME SCREEN -->
    <div id="view-game" class="h-full flex flex-col max-w-7xl mx-auto p-2 md:p-4 gap-3 relative z-10 hidden">
        
        <!-- HEADER -->
        <header class="pip-panel p-2 md:p-3 flex flex-wrap justify-between items-center shrink-0 gap-2">
            <div class="flex items-center gap-3">
                <div class="w-4 h-4 bg-[#14f514] rounded-full animate-pulse shadow-[0_0_10px_#14f514]"></div>
                <div>
                    <h1 class="text-2xl font-black tracking-widest leading-none">PIP-MATH</h1>
                    <div class="text-xs text-[#ffb700] font-bold" id="player-display">AGENTE: ???</div>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="flex items-center gap-4 text-sm md:text-lg font-mono">
                <div class="bg-black/50 px-3 py-1 rounded border border-green-900">
                    <span class="text-gray-400 text-xs mr-2">ROUND</span>
                    <span id="q-counter" class="text-white font-bold text-xl">1/5</span>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-500">XP ATTUALI</div>
                    <div id="xp-display" class="text-[#ffb700] font-bold leading-none text-xl">0</div>
                </div>
                <button onclick="APP.showLeaderboard()" class="pip-btn px-3 py-1 text-xs md:text-sm">üèÜ TOP</button>
                <button onclick="APP.logout()" class="pip-btn px-3 py-1 text-xs md:text-sm text-red-400 border-red-500 hover:bg-red-900 hover:text-white">ESCI</button>
            </div>
        </header>

        <!-- SETTINGS BAR -->
        <div class="flex flex-wrap gap-2 shrink-0 justify-between bg-black/60 p-2 rounded border border-green-900 items-center">
            <!-- Navigation -->
            <div class="flex gap-2 flex-1">
                <button onclick="APP.setGameMode('game1')" class="pip-btn flex-1 py-1 text-sm font-bold active" id="btn-mode-game1">ANALISI (m,q)</button>
                <button onclick="APP.setGameMode('game2')" class="pip-btn flex-1 py-1 text-sm font-bold" id="btn-mode-game2">2 PUNTI</button>
            </div>
            
            <!-- Difficulty & Scaffold -->
            <div class="flex gap-2 items-center pl-2 md:border-l border-green-900 ml-2">
                <select id="diff-select" onchange="APP.setDifficulty(this.value)" class="bg-black text-[#14f514] border border-[#14f514] text-xs py-1 px-2 uppercase outline-none cursor-pointer font-bold">
                    <option value="easy">RECLUTA (x0.5)</option>
                    <option value="normal" selected>VETERANO (x1.0)</option>
                    <option value="hard">SOPRAVVISSUTO (x2.0)</option>
                </select>
                
                <button id="btn-scaffold" onclick="APP.toggleScaffold()" class="pip-btn px-3 py-1 text-xs active font-bold" title="Aiuti visivi">
                    LAB: <span id="scaffold-status">ON</span>
                </button>
            </div>
        </div>

        <!-- MAIN AREA -->
        <main class="flex-grow flex flex-col md:flex-row gap-4 overflow-hidden relative">
            
            <!-- CANVAS -->
            <div class="flex-grow pip-panel relative overflow-hidden h-[45vh] md:h-auto bg-black" id="canvas-container">
                <!-- Status Overlay -->
                <div id="status-overlay" class="hidden absolute inset-0 flex items-center justify-center bg-black/80 z-20">
                    <h2 id="status-text" class="text-4xl md:text-5xl font-black border-4 px-10 py-6 transform -rotate-3 border-green-500 text-green-500 shadow-[0_0_30px_rgba(20,245,20,0.3)]">
                        ALLINEAMENTO OK
                    </h2>
                </div>
                
                <canvas id="main-canvas" class="w-full h-full block"></canvas>
                
                <!-- Overlays -->
                <div id="coords-overlay" class="absolute top-2 left-2 flex flex-col gap-1 pointer-events-none hidden transition-opacity duration-300"></div>
                <div id="scaffold-overlay" class="absolute bottom-2 left-2 text-xs text-[#14f514]/70 pointer-events-none font-mono max-w-[200px] font-bold bg-black/50 p-1"></div>
            </div>

            <!-- CONTROLS -->
            <div class="md:w-80 shrink-0 flex flex-col gap-4">
                <div class="pip-panel p-4 flex flex-col gap-4 bg-black/80">
                    <div class="flex justify-between items-end border-b border-green-800 pb-1">
                        <h3 class="text-xl font-black text-[#ffb700]">INPUT DATI</h3>
                        <span id="multiplier-display" class="text-sm font-bold text-gray-400">x1.0</span>
                    </div>
                    
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-green-400">PENDENZA (m)</label>
                        <input type="text" inputmode="decimal" id="input-m" class="pip-input w-full text-3xl py-2" placeholder="0" oninput="APP.handleInput()" onkeydown="if(event.key==='Enter') document.getElementById('input-q').focus()">
                        <div class="text-[10px] text-gray-500 text-right font-mono font-bold" id="hint-m">y = mx + q</div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-xs font-bold text-green-400">INTERCETTA (q)</label>
                        <input type="text" inputmode="decimal" id="input-q" class="pip-input w-full text-3xl py-2" placeholder="0" oninput="APP.handleInput()" onkeydown="if(event.key==='Enter') APP.checkSolution()">
                        <div class="text-[10px] text-gray-500 text-right font-mono font-bold" id="hint-q">Punto (0, q)</div>
                    </div>

                    <button onclick="APP.checkSolution()" class="pip-btn w-full py-4 text-2xl font-black mt-2 hover:animate-pulse">
                        ESEGUI CALCOLO
                    </button>
                </div>
                
                <div class="text-xs text-gray-400 p-3 font-mono border border-green-900 rounded bg-black/60 min-h-[60px] font-bold">
                    <span class="text-[#ffb700]">>>></span> <span id="system-log">In attesa di input...</span>
                </div>
            </div>
        </main>
    </div>

    <!-- 3. ROUND SUMMARY MODAL -->
    <div id="view-summary" class="fixed inset-0 z-50 flex items-center justify-center bg-black/95 p-4 hidden">
        <div class="pip-panel p-8 max-w-md w-full text-center relative fade-in border-4 border-[#ffb700] shadow-[0_0_30px_rgba(255,183,0,0.2)]">
            <h2 class="text-4xl font-black text-[#ffb700] mb-2 tracking-widest">MISSIONE COMPIUTA</h2>
            <div class="h-1 bg-[#ffb700] w-full mb-6"></div>
            
            <div class="mb-8">
                <div class="text-sm text-gray-400 font-bold uppercase tracking-wider">XP Totali Round</div>
                <div id="summary-xp" class="text-6xl font-black text-white my-2 text-shadow">0</div>
                <div class="text-xs text-green-500 font-bold">DATI TRASMESSI AL DATABASE</div>
            </div>

            <div class="space-y-3">
                <button onclick="APP.nextRound()" class="pip-btn w-full py-3 text-xl font-bold">PROSSIMO ROUND</button>
                <button onclick="APP.showLeaderboard()" class="pip-btn w-full py-3 text-lg border-gray-600 text-gray-400 hover:text-white">CLASSIFICA</button>
            </div>
        </div>
    </div>

    <!-- 4. LEADERBOARD MODAL -->
    <div id="view-lb" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4 hidden">
        <div class="pip-panel p-6 max-w-2xl w-full max-h-[90vh] flex flex-col relative fade-in">
            <button onclick="APP.closeLeaderboard()" class="absolute top-4 right-4 text-red-500 hover:text-white font-bold text-xl">X</button>
            <h2 class="text-3xl font-black text-[#ffb700] mb-4 text-center border-b-2 border-green-800 pb-2 tracking-widest">ARCHIVIO MISSIONI</h2>
            
            <div class="overflow-y-auto flex-grow pr-2 custom-scroll">
                <table class="w-full text-left font-mono">
                    <thead class="text-xs text-gray-500 border-b border-gray-800 sticky top-0 bg-[#050a05] font-bold">
                        <tr>
                            <th class="py-2">AGENTE</th>
                            <th>MODO</th>
                            <th>LVL</th>
                            <th class="text-right">XP</th>
                            <th class="text-right">DATA</th>
                        </tr>
                    </thead>
                    <tbody id="lb-body" class="text-sm font-bold">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 pt-4 border-t border-green-800 flex justify-between">
                <button onclick="APP.clearLeaderboard()" class="text-xs text-red-500 hover:underline font-bold">PURGE DATA</button>
                <button onclick="APP.closeLeaderboard()" class="pip-btn px-6 py-2">CHIUDI</button>
            </div>
        </div>
    </div>

    <!-- LOGICA APPLICAZIONE -->
    <script>
        // --- UTILS ---
        const Utils = {
            parse: (s) => {
                if(!s) return 0;
                s = String(s).replace(/\s/g,'').replace(',','.');
                if(s === '-' || s === '+') return 0; 
                if(s.includes('/')) { 
                    const [n,d] = s.split('/'); 
                    return d!=='0' && d ? parseFloat(n)/parseFloat(d) : 0; 
                }
                return parseFloat(s) || 0;
            },
            randomInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
            randomFloat: (min, max) => (Math.random() * (max - min) + min).toFixed(1)
        };

        // --- GAME ENGINE ---
        const APP = {
            // State
            player: '',
            sessionXP: 0,
            roundXP: 0,
            qCount: 1,
            maxQ: 5,
            
            mode: 'game1', // game1 | game2
            difficulty: 'normal', // easy | normal | hard
            scaffold: true,
            
            // Problem Data
            target: { m: 1, q: 0, points: [] },
            user: { m: '', q: '' },
            
            // System
            canvas: null,
            ctx: null,
            lbKey: 'pip_leaderboard_v3',

            // --- INIT & AUTH ---
            init: function() {
                this.canvas = document.getElementById('main-canvas');
                this.ctx = this.canvas.getContext('2d');
                
                // Restore User
                const savedUser = localStorage.getItem('pip_user');
                if(savedUser) {
                    this.player = savedUser;
                    document.getElementById('login-name').value = this.player;
                    this.showGame();
                }

                // Listeners
                window.addEventListener('resize', () => this.draw());
            },

            login: function() {
                const name = document.getElementById('login-name').value.trim().toUpperCase();
                if(name.length > 0) {
                    this.player = name;
                    localStorage.setItem('pip_user', name);
                    this.sessionXP = 0;
                    this.qCount = 1;
                    this.showGame();
                }
            },

            logout: function() {
                localStorage.removeItem('pip_user');
                location.reload();
            },

            showGame: function() {
                document.getElementById('view-intro').classList.add('hidden');
                document.getElementById('view-game').classList.remove('hidden');
                document.getElementById('view-game').classList.add('fade-in');
                document.getElementById('player-display').innerText = `AGENTE: ${this.player}`;
                this.generateProblem();
            },

            // --- SETTINGS ---
            setGameMode: function(m) {
                this.mode = m;
                document.getElementById('btn-mode-game1').classList.toggle('active', m === 'game1');
                document.getElementById('btn-mode-game2').classList.toggle('active', m === 'game2');
                
                // Reset round on mode change
                this.qCount = 1;
                this.roundXP = 0;
                this.updateRoundUI();
                
                this.log(m === 'game1' ? "MODULO: ANALISI COEFFICIENTI" : "MODULO: INTERCETTAZIONE PUNTI");
                this.generateProblem();
            },

            setDifficulty: function(d) {
                this.difficulty = d;
                this.updateMultiplierDisplay();
                this.log(`DIFFICOLT√Ä SETTATA: ${d.toUpperCase()}`);
                this.generateProblem();
            },

            toggleScaffold: function() {
                this.scaffold = !this.scaffold;
                const btn = document.getElementById('btn-scaffold');
                const status = document.getElementById('scaffold-status');
                
                if(this.scaffold) {
                    btn.classList.add('active');
                    status.innerText = "ON";
                    status.className = "text-green-400";
                } else {
                    btn.classList.remove('active');
                    status.innerText = "OFF";
                    status.className = "text-red-400";
                }
                
                this.updateMultiplierDisplay();
                this.draw();
            },

            getMultiplier: function() {
                let m = 1.0;
                if(this.difficulty === 'easy') m = 0.5;
                if(this.difficulty === 'hard') m = 2.0;
                
                // Bonus No-Scaffold
                if(!this.scaffold) m += 0.5;
                return m;
            },

            updateMultiplierDisplay: function() {
                document.getElementById('multiplier-display').innerText = `x${this.getMultiplier().toFixed(1)}`;
            },

            updateRoundUI: function() {
                document.getElementById('q-counter').innerText = `${this.qCount}/${this.maxQ}`;
                document.getElementById('xp-display').innerText = this.sessionXP;
            },

            // --- GAMEPLAY ---
            generateProblem: function() {
                // Reset inputs
                document.getElementById('input-m').value = '';
                document.getElementById('input-q').value = '';
                this.user = { m: '', q: '' };
                this.hideStatus();
                this.updateRoundUI();

                // Logic based on Difficulty
                let m, q, x1, y1, x2, y2;
                
                if(this.difficulty === 'easy') {
                    // Solo interi piccoli
                    const mPool = [-1, 0, 1, 2];
                    m = mPool[Utils.randomInt(0, mPool.length-1)];
                    q = Utils.randomInt(-3, 3);
                    x1 = Utils.randomInt(-3, 3); x2 = Utils.randomInt(-3, 3);
                } else if(this.difficulty === 'normal') {
                    // Interi e frazioni semplici (0.5)
                    const mPool = [-2, -1, -0.5, 0.5, 1, 2, 3];
                    m = mPool[Utils.randomInt(0, mPool.length-1)];
                    q = Utils.randomInt(-5, 5);
                    x1 = Utils.randomInt(-5, 5); x2 = Utils.randomInt(-5, 5);
                } else {
                    // Hard: Decimali e range ampio
                    m = parseFloat(Utils.randomFloat(-3, 3));
                    q = parseFloat(Utils.randomFloat(-5, 5));
                    x1 = Utils.randomFloat(-6, 6); x2 = Utils.randomFloat(-6, 6);
                }

                if(this.mode === 'game1') {
                    this.target = { m, q, points: [] };
                    this.log(`TARGET #${this.qCount}: ANALIZZARE SEGNALE`);
                } else {
                    // Ensure points distinct
                    while(Math.abs(x1 - x2) < 1) { 
                        if(this.difficulty === 'hard') x2 = Utils.randomFloat(-6, 6);
                        else x2 = Utils.randomInt(-5, 5);
                    }
                    
                    // Force clean integer coords for Easy/Normal modes if possible
                    if(this.difficulty !== 'hard') {
                        y1 = Utils.randomInt(-5, 5);
                        y2 = Utils.randomInt(-5, 5);
                        // Calculate m, q derived
                        m = (y2 - y1) / (x2 - x1);
                        q = y1 - m * x1;
                    } else {
                        // Hard mode: calculate Y based on X and M,Q
                        y1 = m * x1 + q;
                        y2 = m * x2 + q;
                    }

                    this.target = { m, q, points: [{x:Number(x1), y:Number(y1)}, {x:Number(x2), y:Number(y2)}] };
                    this.log(`TARGET #${this.qCount}: PUNTI RILEVATI`);
                }

                this.updateOverlays();
                this.draw();
            },

            handleInput: function() {
                this.user.m = document.getElementById('input-m').value;
                this.user.q = document.getElementById('input-q').value;
                this.draw();
            },

            checkSolution: function() {
                const um = Utils.parse(this.user.m);
                const uq = Utils.parse(this.user.q);
                
                // Tolerance based on difficulty
                const tolerance = this.difficulty === 'hard' ? 0.1 : 0.05;
                
                const mOk = Math.abs(um - this.target.m) < tolerance;
                const qOk = Math.abs(uq - this.target.q) < tolerance;

                if(mOk && qOk) {
                    const basePoints = this.mode === 'game1' ? 100 : 150;
                    const finalPoints = Math.round(basePoints * this.getMultiplier());
                    
                    this.sessionXP += finalPoints;
                    this.roundXP += finalPoints;
                    
                    this.showStatus('success', `TARGET COLPITO (+${finalPoints})`);
                    this.log(`SUCCESSO! XP TOTALE: ${this.sessionXP}`);
                    
                    setTimeout(() => {
                        this.qCount++;
                        if(this.qCount > this.maxQ) {
                            this.endRound();
                        } else {
                            this.generateProblem();
                        }
                    }, 1500);
                } else {
                    this.showStatus('error', 'ERRORE CALCOLO');
                    this.log("ERRORE: I parametri non combaciano.");
                    setTimeout(() => this.hideStatus(), 1500);
                }
            },

            endRound: function() {
                // Show Summary
                document.getElementById('summary-xp').innerText = this.roundXP;
                document.getElementById('view-summary').classList.remove('hidden');
                document.getElementById('view-summary').classList.add('fade-in');
                
                // Save to Leaderboard
                this.saveToLeaderboard(this.roundXP);
            },

            nextRound: function() {
                document.getElementById('view-summary').classList.add('hidden');
                this.qCount = 1;
                this.roundXP = 0;
                this.generateProblem();
            },

            log: function(msg) {
                document.getElementById('system-log').innerText = msg;
            },

            // --- LEADERBOARD SYSTEM ---
            saveToLeaderboard: function(score) {
                let lb = JSON.parse(localStorage.getItem(this.lbKey) || '[]');
                lb.push({
                    name: this.player,
                    mode: this.mode === 'game1' ? 'RETTE' : '2PUNTI',
                    diff: this.difficulty.toUpperCase(),
                    xp: score,
                    date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });
                // Keep last 50
                if(lb.length > 50) lb = lb.slice(-50);
                localStorage.setItem(this.lbKey, JSON.stringify(lb));
            },

            showLeaderboard: function() {
                const lb = JSON.parse(localStorage.getItem(this.lbKey) || '[]');
                const tbody = document.getElementById('lb-body');
                tbody.innerHTML = '';
                
                // Sort by XP desc
                lb.sort((a,b) => b.xp - a.xp);

                if(lb.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">NESSUN DATO</td></tr>';
                } else {
                    lb.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-gray-800 hover:bg-green-900/20";
                        tr.innerHTML = `
                            <td class="py-1 font-bold text-[#ffb700]">${row.name}</td>
                            <td class="text-xs">${row.mode}</td>
                            <td class="text-xs">${row.diff}</td>
                            <td class="text-right font-bold text-green-400">${row.xp}</td>
                            <td class="text-right text-xs text-gray-500">${row.date}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                
                // Hide summary if open, show LB
                document.getElementById('view-summary').classList.add('hidden');
                document.getElementById('view-lb').classList.remove('hidden');
            },

            closeLeaderboard: function() {
                document.getElementById('view-lb').classList.add('hidden');
                // If we were in summary screen (qCount > maxQ), reopen summary
                if(this.qCount > this.maxQ) {
                    document.getElementById('view-summary').classList.remove('hidden');
                }
            },

            clearLeaderboard: function() {
                if(confirm("Cancellare tutti i dati salvati?")) {
                    localStorage.removeItem(this.lbKey);
                    this.showLeaderboard();
                }
            },

            // --- VISUALS ---
            updateOverlays: function() {
                // 1. Coords Overlay (Game 2)
                const cOverlay = document.getElementById('coords-overlay');
                if(this.mode === 'game2' && this.scaffold) {
                    cOverlay.classList.remove('hidden');
                    cOverlay.innerHTML = this.target.points.map((p, i) => `
                        <div class="bg-black/80 text-[#ffb700] px-2 py-1 border border-[#ffb700] text-xs font-bold shadow-lg">
                            ${i===0?'A':'B'}: (${parseFloat(p.x.toFixed(2))}, ${parseFloat(p.y.toFixed(2))})
                        </div>
                    `).join('');
                } else {
                    cOverlay.classList.add('hidden');
                }

                // 2. Scaffold Hints
                const sOverlay = document.getElementById('scaffold-overlay');
                if(this.scaffold) {
                    sOverlay.classList.remove('hidden');
                    if(this.mode === 'game1') {
                        sOverlay.innerHTML = `Target: m=${this.target.m}, q=${this.target.q}`;
                    } else {
                        sOverlay.innerHTML = "Usa: m = (yB-yA)/(xB-xA)";
                    }
                } else {
                    sOverlay.classList.add('hidden');
                }
            },

            showStatus: function(type, msg) {
                const el = document.getElementById('status-overlay');
                const txt = document.getElementById('status-text');
                el.classList.remove('hidden');
                
                if(type === 'success') {
                    txt.className = "text-3xl md:text-5xl font-black border-8 px-10 py-6 transform -rotate-3 border-green-500 text-green-500 animate-pulse bg-black shadow-[0_0_50px_rgba(20,245,20,0.5)]";
                } else {
                    txt.className = "text-3xl md:text-5xl font-black border-8 px-10 py-6 transform -rotate-3 border-red-500 text-red-500 animate-pulse bg-black shadow-[0_0_50px_rgba(255,50,50,0.5)]";
                }
                txt.innerText = msg;
            },

            hideStatus: function() {
                document.getElementById('status-overlay').classList.add('hidden');
            },

            // --- DRAWING ---
            draw: function() {
                const container = this.canvas.parentElement;
                const rect = container.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                if (this.canvas.width !== rect.width * dpr || this.canvas.height !== rect.height * dpr) {
                    this.canvas.style.width = `${rect.width}px`;
                    this.canvas.style.height = `${rect.height}px`;
                    this.canvas.width = rect.width * dpr;
                    this.canvas.height = rect.height * dpr;
                }
                
                const ctx = this.ctx;
                const lw = rect.width;
                const lh = rect.height;
                
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.scale(dpr, dpr);

                // Background
                ctx.fillStyle = "#020402";
                ctx.fillRect(0, 0, lw, lh);

                // Grid Config
                let range = 8;
                if(this.difficulty === 'easy') range = 5;
                if(this.difficulty === 'hard') range = 12;

                const minDim = Math.min(lw, lh);
                const padding = 40;
                const scale = (minDim - padding * 2) / (range * 2);
                const cx = lw / 2;
                const cy = lh / 2;

                const toPx = (x) => cx + x * scale;
                const toPy = (y) => cy - y * scale;

                // Draw Grid
                ctx.lineWidth = 0.5;
                ctx.strokeStyle = "#0f3f0f";
                ctx.beginPath();
                
                const xMin = Math.floor(-cx / scale) - 1;
                const xMax = Math.ceil((lw - cx) / scale) + 1;
                const yMin = Math.floor(-(lh - cy) / scale) - 1;
                const yMax = Math.ceil(cy / scale) + 1;

                for(let i = xMin; i <= xMax; i++) { const x = toPx(i); ctx.moveTo(x, 0); ctx.lineTo(x, lh); }
                for(let i = yMin; i <= yMax; i++) { const y = toPy(i); ctx.moveTo(0, y); ctx.lineTo(lw, y); }
                ctx.stroke();

                // Draw Axes
                ctx.lineWidth = 2;
                ctx.strokeStyle = "#14f514";
                ctx.beginPath();
                ctx.moveTo(cx, 0); ctx.lineTo(cx, lh);
                ctx.moveTo(0, cy); ctx.lineTo(lw, cy);
                ctx.stroke();

                // Numbers
                ctx.font = "bold 14px 'VT323', monospace";
                ctx.fillStyle = "#4ade80";
                ctx.textAlign = "center"; ctx.textBaseline = "top";
                const step = range > 8 ? 2 : 1;
                for(let i = xMin; i <= xMax; i+=step) {
                    if(i===0) continue;
                    ctx.fillText(i, toPx(i), cy + 6);
                    ctx.fillRect(toPx(i)-0.5, cy-3, 1, 6);
                }
                ctx.textAlign = "right"; ctx.textBaseline = "middle";
                for(let i = yMin; i <= yMax; i+=step) {
                    if(i===0) continue;
                    ctx.fillText(i, cx - 6, toPy(i));
                    ctx.fillRect(cx-3, toPy(i)-0.5, 6, 1);
                }

                // DRAW TARGETS
                const xStart = -20, xEnd = 20;

                if(this.mode === 'game1') {
                    // Ghost Line (Show only if scaffold is ON)
                    if(this.scaffold) {
                        ctx.setLineDash([5, 5]);
                        ctx.strokeStyle = "rgba(20, 245, 20, 0.4)";
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(toPx(xStart), toPy(this.target.m * xStart + this.target.q));
                        ctx.lineTo(toPx(xEnd), toPy(this.target.m * xEnd + this.target.q));
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                } else {
                    // Points
                    this.target.points.forEach((p, i) => {
                        ctx.fillStyle = "rgba(255, 183, 0, 0.3)";
                        ctx.beginPath(); ctx.arc(toPx(p.x), toPy(p.y), 10, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = "#ffb700";
                        ctx.beginPath(); ctx.arc(toPx(p.x), toPy(p.y), 4, 0, Math.PI*2); ctx.fill();
                        ctx.font = "bold 14px monospace";
                        ctx.fillStyle = "white";
                        ctx.fillText(i===0?"A":"B", toPx(p.x)+12, toPy(p.y)-12);
                    });
                }

                // USER LINE
                if(this.user.m !== "" || this.user.q !== "") {
                    const um = Utils.parse(this.user.m);
                    const uq = Utils.parse(this.user.q);
                    
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = "#ffb700";
                    ctx.strokeStyle = "#ffb700";
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(toPx(xStart), toPy(um * xStart + uq));
                    ctx.lineTo(toPx(xEnd), toPy(um * xEnd + uq));
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                }
            }
        };

        // Start
        window.onload = () => APP.init();

    </script>
</body>
</html>