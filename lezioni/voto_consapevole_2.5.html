<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    
    <!-- 1. META DATI PER CATALOGAZIONE -->
    <title>Voto Consapevole: Simulatore Nash</title>
    <!-- FIX: Rimosso apostrofo in "sull'Equilibrio" per evitare troncamenti -->
    <meta name="description" content="Simulazione interattiva su Equilibrio di Nash applicato ai voti scolastici. Esplora il conflitto tra interesse individuale (voto alto) e bene comune.">
    <meta name="keywords" content="Ed. Civica, Matematica, Teoria dei Giochi, Equilibrio di Nash, Cittadinanza, 3EL, 4EL, 5EL, Civ:Costituzione, EU:Cittadinanza, Mat:Modellizzazione, Mat:Dati">
    <meta name="date" content="2025-10-01">

    <!-- 2. FIX MOBILE -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>Voto Consapevole - Simulatore </title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* 3. CSS FULLSCREEN ROBUSTO */
        html, body {
            margin: 0; padding: 0;
            font-family: 'Space Grotesk', sans-serif;
            background-color: #000000; /* AMOLED Black */
            color: #e2e8f0;
            width: 100vw; height: 100dvh; /* Dynamic Viewport Height */
            overflow: hidden; /* Blocca scroll pagina */
            position: fixed; /* Inchioda su iOS */
        }

        /* Contenitore scrollabile interno */
        #app-scroller {
            height: 100%;
            width: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 80px; /* Spazio per scroll */
        }

        /* Animazioni */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-element { animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both; }

        /* Slider Custom */
        input[type=range] { -webkit-appearance: none; background: transparent; height: 24px; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #38bdf8; cursor: pointer; margin-top: -10px;
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.5); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(17, 17, 17, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        .theory-card {
            background: rgba(20, 20, 20, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: all 0.2s;
        }
        .theory-card:active { transform: scale(0.98); background: rgba(30, 30, 30, 0.8); }
    </style>
</head>

<body class="antialiased selection:bg-sky-500/30" x-data="gameLogic()" x-init="initSim()">

    <!-- Wrapper Scrollabile -->
    <div id="app-scroller">

        <!-- Navbar -->
        <nav class="w-full p-4 md:p-6 flex flex-col md:flex-row justify-between items-center glass-panel sticky top-0 z-40 mb-6 border-b border-neutral-800/50 gap-4">
            <div class="flex items-center gap-3">
                <span class="text-3xl filter drop-shadow-lg">üé≤</span>
                <div>
                    <h1 class="font-bold text-lg md:text-xl leading-none text-white tracking-tight">Voto Consapevole <span class="text-sky-400">2.5</span></h1>
                    <p class="text-[10px] md:text-xs text-slate-400 font-medium">Laboratorio di Teoria dei Giochi</p>
                </div>
            </div>

            <div class="flex flex-wrap justify-center gap-2">
                <button @click="showMission = true" class="text-xs md:text-sm bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-full transition shadow-lg shadow-indigo-500/20 border border-indigo-400/30 flex items-center gap-2 font-bold animate-pulse">
                    <span>üöÄ</span> Missione
                </button>
                <button @click="showTheory = true" class="text-xs md:text-sm bg-teal-700 hover:bg-teal-600 text-white px-4 py-2 rounded-full transition shadow-lg shadow-teal-500/20 border border-teal-400/30 flex items-center gap-2 font-bold">
                    <span>üß†</span> Teoria
                </button>
                <button @click="showRules = true" class="text-xs md:text-sm bg-slate-800 hover:bg-slate-700 text-slate-200 px-4 py-2 rounded-full transition border border-slate-600 hover:border-slate-500 flex items-center gap-2">
                    <span>üìö</span> Regole
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 max-w-[1800px] space-y-6">

            <!-- SETUP PANEL -->
            <section class="glass-panel p-6 rounded-3xl shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-32 bg-sky-500/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                <div class="flex flex-col md:flex-row justify-between items-center gap-6 relative z-10">
                    <div class="w-full md:w-1/2">
                        <label class="block text-slate-400 text-xs font-bold mb-2 uppercase tracking-wider flex items-center gap-2">
                            <span>üë•</span> Studenti in Classe \( (N) \)
                        </label>
                        <div class="flex items-center gap-4">
                            <input type="number" x-model.number="totalStudents" @input="reinitClass" min="5" max="100" class="bg-slate-900/80 border-2 border-slate-600 text-white text-2xl font-bold rounded-xl p-3 w-28 focus:outline-none focus:border-sky-500 text-center transition shadow-inner">
                            <div class="text-xs text-slate-400 leading-tight max-w-[150px]">Modifica N per ricalcolare la soglia critica.</div>
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 flex flex-col items-end">
                        <div class="text-right">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Soglia Critica \( (\lfloor N/3 \rfloor) \)</div>
                            <div class="flex items-baseline justify-end gap-2">
                                <span class="text-5xl font-bold text-sky-400 filter drop-shadow-md" x-text="threshold"></span>
                                <span class="text-xl text-slate-600 font-light">/ <span x-text="totalStudents"></span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- GRID LAYOUT -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 items-start pb-10">

                <!-- CONTROLLI STUDENTE (3/12) -->
                <div class="xl:col-span-3 space-y-4 xl:sticky xl:top-28">
                    <div class="glass-panel p-5 rounded-3xl border-l-4 transition-colors duration-500" :class="isMyRequestSus ? 'border-amber-400 bg-amber-900/10' : 'border-emerald-400 bg-emerald-900/10'">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-lg font-bold flex items-center gap-2 text-white"><span class="text-xl">üë§</span> Il Tuo Avatar</h2>
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide border" :class="isMyRequestSus ? 'bg-amber-500/20 text-amber-300 border-amber-500/50' : 'bg-emerald-500/20 text-emerald-300 border-emerald-500/50'" x-text="isMyRequestSus ? 'Richiesta Ambigua' : 'Richiesta Onesta'"></span>
                        </div>

                        <!-- P_i Input -->
                        <div class="mb-6">
                            <label class="flex justify-between text-xs font-bold mb-2 text-slate-300">
                                <span>Merito Reale \( (P_i) \)</span>
                                <span class="text-sky-400 text-base font-bold bg-slate-800 px-2 rounded" x-text="myPi"></span>
                            </label>
                            <div class="grid grid-cols-9 gap-1 bg-slate-800/50 p-1 rounded-xl">
                                <template x-for="val in 9">
                                    <button @click="setPi(val)" class="aspect-square rounded text-xs font-bold transition-all relative" :class="myPi === val ? 'bg-sky-500 text-white shadow-lg scale-110 z-10' : 'text-slate-500 hover:bg-slate-700 hover:text-slate-200'">
                                        <span x-text="val" class="absolute inset-0 flex items-center justify-center"></span>
                                    </button>
                                </template>
                            </div>
                        </div>

                        <!-- R_i Input -->
                        <div class="mb-2">
                            <label class="flex justify-between text-xs font-bold mb-3 text-slate-300">
                                <span>Voto Richiesto \( (R_i) \)</span>
                                <span class="text-base font-bold bg-slate-800 px-2 rounded" :class="isMyRequestSus ? 'text-amber-400' : 'text-emerald-400'" x-text="myRi"></span>
                            </label>
                            <input type="range" x-model.number="myRi" :min="myPi" max="10" step="1" class="w-full accent-emerald-500" @input="updateChart">
                        </div>
                    </div>
                </div>

                <!-- VISUALIZZAZIONE & DATI (5/12) -->
                <div class="xl:col-span-5 space-y-4">
                    
                    <!-- RESULT CARD -->
                    <div class="glass-panel p-6 rounded-3xl text-center relative overflow-hidden transition-all duration-500" :class="penaltyActive ? 'border-red-500/50 shadow-red-900/20' : 'border-emerald-500/50 shadow-emerald-900/20'">
                        <div class="absolute inset-0 opacity-20 pointer-events-none transition-colors duration-500" :class="penaltyActive ? 'bg-gradient-to-br from-red-600 to-slate-900' : 'bg-gradient-to-br from-emerald-600 to-slate-900'"></div>
                        <div class="relative flex flex-col items-center justify-center gap-2">
                            <h3 class="text-slate-400 font-bold tracking-[0.2em] uppercase text-[10px]">Voto Finale</h3>
                            <div class="text-7xl font-black transition-all tracking-tighter" :class="penaltyActive ? 'text-red-500 shake-element' : 'text-white'" x-text="myFinalGrade"></div>
                            <div class="text-center mt-2">
                                <div class="text-sm font-bold mb-1" x-text="penaltyActive ? 'üíÄ Penalit√† Attiva' : '‚úÖ Esito Positivo'"></div>
                                <p class="text-xs text-slate-300 leading-snug" x-text="resultMessage"></p>
                            </div>
                        </div>
                    </div>

                    <!-- TENSION METER -->
                    <div class="glass-panel p-6 rounded-3xl">
                        <div class="flex justify-between items-end mb-3">
                            <h3 class="font-bold text-xs text-slate-300 uppercase tracking-widest flex items-center gap-2">
                                <span>Tension Meter</span>
                                <span class="bg-slate-800 text-slate-400 px-2 py-0.5 rounded text-[10px]" x-text="`${totalSusCount} Richieste Ambigue`"></span>
                            </h3>
                        </div>
                        <div class="h-12 w-full bg-slate-800/80 rounded-xl overflow-hidden relative shadow-inner border border-slate-700/50">
                            <div class="absolute top-0 bottom-0 w-0.5 bg-white z-20 shadow-[0_0_10px_rgba(255,255,255,0.5)] transition-all duration-300" :style="`left: ${(threshold / totalStudents) * 100}%`">
                                <div class="absolute top-0 -translate-x-1/2 bg-white text-slate-900 text-[9px] font-black px-1.5 py-0.5 rounded-b border border-slate-300 z-30">
                                    <span class="text-red-600" x-text="threshold"></span>
                                </div>
                            </div>
                            <div class="h-full transition-all duration-700 ease-out flex items-center justify-end pr-2" :style="`width: ${(totalSusCount / totalStudents) * 100}%`" :class="penaltyActive ? 'bg-gradient-to-r from-orange-500 via-red-500 to-red-600' : 'bg-gradient-to-r from-sky-500 via-teal-400 to-emerald-400'">
                                <span class="font-bold text-white text-xs drop-shadow-md" x-text="`${Math.round((totalSusCount / totalStudents) * 100)}%`"></span>
                            </div>
                        </div>
                        <div class="flex justify-between text-[9px] text-slate-500 mt-2 uppercase font-bold tracking-wider px-1">
                            <span>Safe Zone</span>
                            <span>Danger Zone</span>
                        </div>
                    </div>

                    <!-- CHART -->
                    <div class="glass-panel p-5 rounded-3xl">
                        <h3 class="font-bold text-sm text-white mb-1 flex items-center gap-2">üìà Analisi Payoff</h3>
                        <p class="text-[10px] text-slate-400 mb-3">Il tuo voto vs Numero di "furbi" totali.</p>
                        <div class="relative h-48 w-full"><canvas id="payoffChart"></canvas></div>
                    </div>
                </div>

                <!-- REGISTRO CLASSE (4/12) -->
                <div class="xl:col-span-4">
                    <div class="glass-panel p-5 rounded-3xl flex flex-col h-full max-h-[500px] xl:max-h-none">
                        <div class="flex justify-between items-center mb-4 sticky top-0 z-20">
                            <div>
                                <h3 class="font-bold text-sm text-white flex items-center gap-2">üìã Registro Classe</h3>
                                <p class="text-[10px] text-slate-400">Simulazione Studenti</p>
                            </div>
                            <button @click="randomizeClass" class="text-[10px] bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded-lg border border-slate-600 transition flex items-center gap-1 shadow-lg text-white">
                                <span>üé≤</span> Random
                            </button>
                        </div>
                        
                        <div class="w-full overflow-y-auto pr-1">
                            <table class="w-full text-left border-collapse">
                                <thead class="text-[10px] uppercase text-slate-400 font-bold border-b border-slate-700/50 sticky top-0 bg-neutral-900/90 backdrop-blur z-10">
                                    <tr>
                                        <th class="p-2">Studente</th>
                                        <th class="p-2 text-center">Merito</th>
                                        <th class="p-2 text-center">Richiesta</th>
                                        <th class="p-2 text-right">Esito</th>
                                    </tr>
                                </thead>
                                <tbody class="text-xs divide-y divide-slate-700/50">
                                    <!-- TU -->
                                    <tr class="bg-sky-900/20 border-l-2 border-sky-500">
                                        <td class="p-2 font-bold text-sky-300">
                                            TU <span class="text-[8px] text-sky-500/70 font-normal uppercase block">Player</span>
                                        </td>
                                        <td class="p-2 font-mono text-center" x-text="myPi"></td>
                                        <td class="p-2 font-mono font-bold text-center" x-text="myRi"></td>
                                        <td class="p-2 text-right font-bold text-sm" x-text="myFinalGrade"></td>
                                    </tr>
                                    <!-- SIMULATI -->
                                    <template x-for="(student, index) in simulatedStudents" :key="index">
                                        <tr class="hover:bg-slate-800/50 transition-colors" :class="student.ri > student.pi ? 'bg-amber-900/5' : ''">
                                            <td class="p-2 text-slate-400">
                                                <div class="flex flex-col">
                                                    <span x-text="`#${index + 1}`" class="font-bold text-slate-500"></span>
                                                    <span x-show="student.ri > student.pi" class="text-[8px] text-amber-500 uppercase font-bold">SUS</span>
                                                </div>
                                            </td>
                                            <td class="p-2 font-mono text-slate-300 text-center" x-text="student.pi"></td>
                                            <td class="p-2 text-center">
                                                <select x-model.number="student.ri" @change="updateSimStats" class="bg-slate-900 border border-slate-600 rounded px-1 py-0.5 text-xs focus:border-sky-500 outline-none w-10 text-center" :class="student.ri > student.pi ? 'text-amber-400 border-amber-500/50' : 'text-emerald-400 border-emerald-500/50'">
                                                    <template x-for="r in 10">
                                                        <option :value="r" x-text="r" :selected="r === student.ri" x-show="r >= student.pi"></option>
                                                    </template>
                                                </select>
                                            </td>
                                            <td class="p-2 text-right font-mono font-bold" :class="penaltyActive ? 'text-red-400' : 'text-emerald-400'" x-text="calculateStudentGrade(student)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS (TEORIA, MISSIONE, REGOLE) -->
    <!-- ... (Mantengo i modal originali ma con z-index 100 per stare sopra a tutto) ... -->
    <div x-show="showTheory" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md" x-transition.opacity style="display: none;">
        <div class="bg-neutral-900 border-2 border-teal-500/50 p-6 rounded-3xl max-w-4xl w-full shadow-2xl relative overflow-y-auto max-h-[85vh]" @click.away="showTheory = false">
            <button @click="showTheory = false" class="absolute top-4 right-4 text-slate-400 hover:text-white bg-neutral-800 rounded-full w-8 h-8 flex items-center justify-center transition">‚úï</button>
            <div class="text-center mb-6">
                <h2 class="text-2xl font-black text-white">Teoria & Cittadinanza</h2>
                <p class="text-sm text-slate-400 mt-1">Perch√© "barare" conviene al singolo ma distrugge la collettivit√†?</p>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h3 class="text-sm font-bold text-white border-b border-slate-700 pb-1">üß† Concetti Chiave</h3>
                    <div class="theory-card p-3 rounded-xl">
                        <h4 class="font-bold text-teal-400 text-sm">Equilibrio di Nash</h4>
                        <p class="text-xs text-slate-300 mt-1">Situazione in cui nessuno ha interesse a cambiare strategia da solo. Nel gioco: se tutti barano, essere onesti da soli non ti salva dalla penalit√†.</p>
                    </div>
                    <div class="theory-card p-3 rounded-xl">
                        <h4 class="font-bold text-teal-400 text-sm">Tragedia dei Beni Comuni</h4>
                        <p class="text-xs text-slate-300 mt-1">Lo sfruttamento eccessivo di una risorsa condivisa (il voto alto) porta al suo esaurimento per tutti (penalit√†).</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <h3 class="text-sm font-bold text-white border-b border-slate-700 pb-1">üåç Realt√†</h3>
                    <div class="theory-card p-3 rounded-xl border-l-2 border-l-indigo-500">
                        <h4 class="font-bold text-indigo-400 text-sm">Legalit√†</h4>
                        <p class="text-xs text-slate-300 mt-1">Il "furbetto" (free-rider) gode dei servizi senza pagare i costi. Se lo fanno in troppi, il sistema sociale crolla.</p>
                    </div>
                    <div class="theory-card p-3 rounded-xl border-l-2 border-l-emerald-500">
                        <h4 class="font-bold text-emerald-400 text-sm">Altruismo Razionale</h4>
                        <p class="text-xs text-slate-300 mt-1">Essere onesti √® intelligente a lungo termine perch√© costruisce fiducia e stabilit√†.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showMission" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md" x-transition.opacity style="display: none;">
        <div class="bg-neutral-900 border-2 border-indigo-500/50 p-6 rounded-3xl max-w-xl w-full relative overflow-y-auto max-h-[85vh]" @click.away="showMission = false">
            <button @click="showMission = false" class="absolute top-4 right-4 text-slate-400 hover:text-white">‚úï</button>
            <h2 class="text-2xl font-black text-white mb-4 text-center">Missione: Hack The System üéÆ</h2>
            <div class="space-y-4 text-slate-300 text-sm">
                <p><strong>Obiettivo:</strong> Ottenere il voto pi√π alto possibile.</p>
                <div class="p-3 bg-slate-800 rounded-lg">
                    <h4 class="font-bold text-white text-xs mb-1">1. Stat Base (Merito)</h4>
                    <p class="text-xs text-slate-400">Il tuo voto reale, onesto.</p>
                </div>
                <div class="p-3 bg-slate-800 rounded-lg">
                    <h4 class="font-bold text-white text-xs mb-1">2. Strategia (Richiesta)</h4>
                    <ul class="text-xs space-y-1">
                        <li><span class="text-emerald-400">Safe:</span> Chiedi il merito reale.</li>
                        <li><span class="text-amber-400">Greedy:</span> Chiedi di pi√π (Rischio!).</li>
                    </ul>
                </div>
                <div class="p-3 bg-red-900/20 border border-red-900/50 rounded-lg">
                    <h4 class="font-bold text-red-400 text-xs mb-1">3. Crash del Server</h4>
                    <p class="text-xs text-slate-300">Se troppi studenti (> 1/3) fanno i furbi, scatta la penalit√† globale: tutti i voti vengono dimezzati.</p>
                </div>
            </div>
            <button @click="showMission = false" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold text-sm">Capito, iniziamo!</button>
        </div>
    </div>

    <div x-show="showRules" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md" x-transition.opacity style="display: none;">
        <div class="bg-neutral-900 border border-neutral-700 p-6 rounded-3xl max-w-md w-full relative" @click.away="showRules = false">
            <button @click="showRules = false" class="absolute top-4 right-4 text-slate-500 hover:text-white">‚úï</button>
            <h2 class="text-xl font-bold mb-4 text-white">Regole Rapide</h2>
            <ul class="space-y-3 text-slate-300 text-sm list-disc list-inside">
                <li>Ogni studente ha un <strong>Merito (Pi)</strong>.</li>
                <li>Ogni studente fa una <strong>Richiesta (Ri)</strong>.</li>
                <li>Se \( Ri > Pi \), la richiesta √® <strong>Ambigua (SUS)</strong>.</li>
                <li>Se le richieste SUS superano 1/3 della classe, <strong>TUTTI</strong> prendono la met√† del merito.</li>
                <li>Altrimenti, chi ha chiesto di pi√π ottiene quello che ha chiesto (fino a 10).</li>
            </ul>
        </div>
    </div>

    <script>
        function gameLogic() {
            let chartInstance = null;
            return {
                totalStudents: 20,
                threshold: 0,
                myPi: 6, 
                myRi: 6, 
                simulatedStudents: [], 
                showRules: false,
                showMission: false,
                showTheory: false,

                get isMyRequestSus() { return this.myRi > this.myPi; },
                
                get totalSusCount() {
                    let count = this.isMyRequestSus ? 1 : 0;
                    this.simulatedStudents.forEach(s => { if (s.ri > s.pi) count++; });
                    return count;
                },

                get penaltyActive() { return this.totalSusCount > this.threshold; },

                get myFinalGrade() { return this.calculateGrade(this.myPi, this.myRi, this.totalSusCount); },

                get resultMessage() {
                    if (this.penaltyActive) return `Soglia superata (${this.totalSusCount} RA). Penalit√† attiva.`;
                    if (this.isMyRequestSus) return `Hai rischiato e vinto (${this.myRi}).`;
                    return `Hai giocato onestamente (${this.myPi}).`;
                },

                initSim() {
                    this.reinitClass();
                    this.$nextTick(() => {
                        renderMathInElement(document.body, { delimiters: [{left: '\\(', right: '\\)', display: false}], throwOnError: false });
                        this.initChart();
                    });
                },

                setPi(val) {
                    this.myPi = val;
                    if (this.myRi < val) this.myRi = val;
                    this.updateChart();
                },

                reinitClass() {
                    this.threshold = Math.floor(this.totalStudents / 3);
                    this.simulatedStudents = [];
                    for(let i=0; i < this.totalStudents - 1; i++) {
                        let pi = Math.floor(Math.random() * 9) + 1;
                        let isSus = Math.random() < 0.3;
                        let ri = isSus && pi < 9 ? Math.min(10, pi + Math.floor(Math.random()*3)+1) : pi;
                        this.simulatedStudents.push({ pi: pi, ri: ri });
                    }
                    this.updateChart();
                },

                randomizeClass() {
                    this.simulatedStudents.forEach(s => {
                        let isSus = Math.random() < 0.4; 
                        if (s.pi < 9 && isSus) {
                            s.ri = Math.min(10, s.pi + Math.floor(Math.random() * 3) + 1);
                        } else { s.ri = s.pi; }
                    });
                    this.updateChart();
                },

                calculateGrade(pi, ri, currentTotalSus) {
                    if (currentTotalSus > this.threshold) {
                        return Math.max(1, Number((pi * 0.5).toFixed(1)));
                    } else { return ri > pi ? Math.min(10, ri) : ri; }
                },

                calculateStudentGrade(student) { return this.calculateGrade(student.pi, student.ri, this.totalSusCount); },

                updateSimStats() { this.updateChart(); },

                initChart() {
                    const ctx = document.getElementById('payoffChart').getContext('2d');
                    Chart.defaults.color = '#94a3b8';
                    Chart.defaults.borderColor = '#334155';
                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                { label: 'Voto se BARI (RA)', borderColor: '#fbbf24', borderWidth: 2, data: [], tension: 0.1, pointRadius: 0 },
                                { label: 'Voto se ONESTO', borderColor: '#10b981', borderWidth: 2, data: [], tension: 0.1, pointRadius: 0 }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' },
                            plugins: {
                                legend: { labels: { color: '#cbd5e1', font: { size: 10 } } },
                                tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', titleColor: '#fff', bodyColor: '#cbd5e1', callbacks: { title: (items) => `Se ${items[0].label} persone totali barano:` } },
                                annotation: { annotations: { line1: { type: 'line', xMin: 0, xMax: 0, borderColor: 'rgba(239, 68, 68, 0.5)', borderWidth: 2, borderDash: [5, 5], label: { display: true, content: 'SOGLIA', position: 'start', color: '#ef4444', backgroundColor: 'rgba(0,0,0,0)', font: { size: 10 } } } } }
                            },
                            scales: {
                                x: { title: { display: true, text: 'Totale Studenti SUS (N_ra)', color: '#64748b', font: { size: 10 } }, grid: { color: '#334155' }, ticks: { color: '#94a3b8', font: { size: 10 } } },
                                y: { min: 0, max: 10, grid: { color: '#334155' }, ticks: { color: '#94a3b8', font: { size: 10 } } }
                            }
                        }
                    });
                    this.updateChart();
                },

                updateChart() {
                    if (!chartInstance) return;
                    const labels = Array.from({length: this.totalStudents + 1}, (_, i) => i);
                    const hypotheticalSusRi = this.myRi > this.myPi ? this.myRi : Math.min(10, this.myPi + 1);
                    const dataSus = labels.map(n_sus => n_sus > this.threshold ? Math.max(1, this.myPi * 0.5) : hypotheticalSusRi);
                    const dataHonest = labels.map(n_sus => n_sus > this.threshold ? Math.max(1, this.myPi * 0.5) : this.myPi);

                    chartInstance.data.labels = labels;
                    chartInstance.data.datasets[0].data = dataSus;
                    chartInstance.data.datasets[0].label = `Voto con richiesta ${hypotheticalSusRi}`;
                    chartInstance.data.datasets[1].data = dataHonest;
                    chartInstance.data.datasets[1].label = `Voto con richiesta ${this.myPi} (Onesto)`;
                    
                    // Aggiorna linea soglia annotazione
                    if (chartInstance.options.plugins.annotation.annotations.line1) {
                        chartInstance.options.plugins.annotation.annotations.line1.xMin = this.threshold;
                        chartInstance.options.plugins.annotation.annotations.line1.xMax = this.threshold;
                    }
                    
                    chartInstance.update();
                }
            }
        }
    </script>
</body>
</html>