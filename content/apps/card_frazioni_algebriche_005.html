<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!--<title>C.E. Match - Palestra Matematica</title>
    <!-- Shared Orfini Design System -->
    <link rel="stylesheet" href="../assets/style/orfini-shared.css">
    <script src="../assets/js/orfini-shared.js"></script>
 -->

 <meta name="description" content="Gioco Memory sul riconoscimento delle condizioni di esistenza di frazioni algebriche.">
 <meta name="keywords" content="Matematica, Algebra, Polinomi, Scomposizioni, Prodotti Notevoli, 1EL, 2EL, Mat:Calcolo, EU:ImparareImparare, Gamification">

    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configurazione Tailwind per Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: 'var(--bg-app)',
                        'on-background': 'var(--text-app)',
                        surface: 'var(--surface)',
                        'surface-container': 'var(--surface-container)',
                        'outline-variant': 'var(--border)',
                        primary: 'var(--primary)',
                        secondary: 'var(--secondary)',
                    },
                    fontFamily: {
                        sans: ['"Exo 2"', 'sans-serif'],
                        mono: ['"Fira Code"', 'monospace'],
                        math: ['Noto Serif', 'serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- KaTeX per la matematica -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@300;600;800&family=Fira+Code:wght@400&family=Noto+Serif:wght@700&display=swap');
        
        :root {
            /* Light Mode Defaults */
            --bg-app: #f8fafc;
            --text-app: #0f172a;
            --surface: #ffffff;
            --surface-container: #f1f5f9;
            --border: #cbd5e1;
            --primary: #00bcd4;
            --secondary: #ff4081;
        }

        :root[class~="dark"], .dark {
            /* Dark Mode - Index Match */
            --bg-app: #050510;
            --text-app: #ffffff;
            --surface: rgba(10, 20, 40, 0.6);
            --surface-container: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.15);
            --primary: #00bcd4;
            --secondary: #ff4081;
        }

        body { 
            font-family: 'Exo 2', sans-serif; 
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            background-color: var(--bg-app);
            color: var(--text-app);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- SCROLLBARS (Index Style) --- */
        * { 
            box-sizing: border-box; 
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.2) transparent;
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* --- 3D ENGINE --- */
        .perspective-1000 { perspective: 1000px; }
        
        .flipper {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            will-change: transform;
        }

        .flipper.flipped { transform: rotateY(180deg); }

        .face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        }

        .face-front { transform: rotateY(0deg); }
        .face-back { transform: rotateY(180deg); }

        /* Tipografia Matematica */
        .font-math { font-family: 'Noto Serif', serif; }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIGURAZIONE ---
        const RUSH_MEM_TIME = 15;
        const RUSH_PLAY_TIME = 90;

        const AVATARS = ['ðŸ‘¨â€ðŸš€', 'ðŸ‘©â€ðŸ”¬', 'ðŸ¥·', 'ðŸ§™â€â™‚ï¸', 'ðŸ§›â€â™€ï¸', 'ðŸ§œâ€â™‚ï¸', 'ðŸ§šâ€â™€ï¸', 'ðŸ§žâ€â™‚ï¸', 'ðŸ¦¸â€â™€ï¸', 'ðŸ¦¹â€â™‚ï¸', 'ðŸ•µï¸â€â™€ï¸', 'ðŸ§‘â€ðŸŽ¨'];

        // EMOJI AD ALTO CONTRASTO
        const EMOJI_POOL = [
            'ðŸš€','ðŸ’Ž','ðŸŒ¶ï¸','ðŸ„','ðŸŽ±','ðŸŽ¸','ðŸŒµ','ðŸ”¥','âš¡','ðŸŒˆ','ðŸª','ðŸ§©',
            'ðŸŽ²','ðŸŽ¯','ðŸŽ¨','ðŸŽ­','ðŸŽª','ðŸŽ¡','ðŸŽ¢','ðŸŽƒ','ðŸŽ„','ðŸŽˆ','ðŸŽ','ðŸ†',
            'ðŸ¥‡','âš½','ðŸ€','ðŸŽ¾','ðŸ©','ðŸ•','ðŸŸ','ðŸ”','ðŸ¦„','ðŸ¤–','ðŸ‘¾','ðŸ‘»'
        ];

        const PAIR_COLORS = [
            'bg-rose-50 text-rose-950 border-rose-300 dark:bg-rose-900/40 dark:text-rose-100 dark:border-rose-500',
            'bg-orange-50 text-orange-950 border-orange-300 dark:bg-orange-900/40 dark:text-orange-100 dark:border-orange-500',
            'bg-amber-50 text-amber-950 border-amber-300 dark:bg-amber-900/40 dark:text-amber-100 dark:border-amber-500',
            'bg-emerald-50 text-emerald-950 border-emerald-300 dark:bg-emerald-900/40 dark:text-emerald-100 dark:border-emerald-500',
            'bg-cyan-50 text-cyan-950 border-cyan-300 dark:bg-cyan-900/40 dark:text-cyan-100 dark:border-cyan-500',
            'bg-blue-50 text-blue-950 border-blue-300 dark:bg-blue-900/40 dark:text-blue-100 dark:border-blue-500',
            'bg-violet-50 text-violet-950 border-violet-300 dark:bg-violet-900/40 dark:text-violet-100 dark:border-violet-500',
            'bg-fuchsia-50 text-fuchsia-950 border-fuchsia-300 dark:bg-fuchsia-900/40 dark:text-fuchsia-100 dark:border-fuchsia-500',
        ];

        const LEVELS = [
            { id: 0, label: "Training", desc: "6 Carte (3 Coppie)", pairs: 3, points: 300, ghost: true },
            { id: 1, label: "Base", desc: "12 Carte (6 Coppie)", pairs: 6, points: 600, ghost: false },
            { id: 2, label: "Intermedio", desc: "16 Carte (8 Coppie)", pairs: 8, points: 1200, ghost: false },
            { id: 3, label: "Avanzato", desc: "20 Carte (10 Coppie)", pairs: 10, points: 2000, ghost: false }
        ];

        const EXPLANATIONS = {
            "trap": "Denominatore mai nullo (Somma di quadrati)",
            "simple": "Equazione lineare semplice",
            "diffSq": "Differenza di Quadrati: xÂ²-aÂ² â†’ x â‰  Â±a",
            "sqBin": "Quadrato di Binomio: (x-a)Â² â†’ x â‰  a",
            "trinom": "Trinomio Speciale: Scomponi e annulla",
            "common": "Raccoglimento a fattor comune x(x-a)",
        };

        const BRIEFING_ITEMS = [
            { title: "Denominatore Lineare", tex: "\\dfrac{1}{x-a} \\rightarrow x \\neq a", color: "border-outline-variant bg-surface dark:bg-white/5" },
            { title: "Raccoglimento Totale", tex: "\\dfrac{1}{x(x-a)} \\rightarrow x \\neq 0, a", color: "border-outline-variant bg-surface dark:bg-white/5" },
            { title: "Differenza di Quadrati", tex: "\\dfrac{1}{x^2-a^2} \\rightarrow x \\neq \\pm a", color: "border-outline-variant bg-surface dark:bg-white/5" },
            { title: "Quadrato di Binomio", tex: "\\dfrac{1}{(x-a)^2} \\rightarrow x \\neq a", color: "border-outline-variant bg-surface dark:bg-white/5" },
            { title: "Trinomio Speciale", tex: "\\dfrac{1}{x^2+Sx+P} \\rightarrow x \\neq -a, -b", color: "border-outline-variant bg-surface dark:bg-white/5" },
            { title: "Trappola (Irriducibile)", tex: "\\dfrac{1}{x^2+a^2} \\rightarrow \\forall x \\in \\mathbb{R}", color: "border-red-200 bg-red-50 text-red-900 dark:bg-red-900/20 dark:text-red-200 dark:border-red-800" },
        ];

        // --- ICONE SVG ---
        const Icon = ({ d, size=20, className="" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d}/></svg>
        );
        const Icons = {
            Trophy: <Icon d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6 M18 9h1.5a2.5 2.5 0 0 0 0-5H18 M4 22h16 M10 14.66V17 M14 14.66V17 M12 2v10 M12 17a5 5 0 0 0-5 4 M12 17a5 5 0 0 1 5 4" />,
            Check: <Icon d="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4 12 14.01 9 11.01" />,
            Play: <Icon d="M5 3l14 9-14 9V3z" />,
            Zap: <Icon d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />,
            Timer: <Icon d="M10 2h4 M12 14l3-3 M12 14v-4 M12 22a8 8 0 1 0 0-16 8 8 0 0 0 0 16z" />,
            Target: <Icon d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6z M12 8a4 4 0 1 0 4 4 4 4 0 0 0-4-4z" />,
            Book: <Icon d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />,
            Sun: <Icon d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />,
            Moon: <Icon d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
        };

        // --- LOGICA MATEMATICA ---
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const mkFrac = (den) => `\\dfrac{1}{${den}}`;

        const generators = {
            trap: () => {
                const k = getRandomInt(1, 4);
                return { poly: mkFrac(`x^2 + ${k*k}`), fact: `\\forall x \\in \\mathbb{R}`, type: "trap" };
            },
            simple: () => {
                const a = getRandomInt(1, 6);
                const sign = Math.random() > 0.5 ? '+' : '-';
                const val = sign === '+' ? -a : a;
                return { poly: mkFrac(`x ${sign} ${a}`), fact: `x \\neq ${val}`, type: "simple" };
            },
            common: () => {
                const a = getRandomInt(1, 6);
                return { poly: mkFrac(`x^2 - ${a}x`), fact: `x \\neq 0, ${a}`, type: "common" };
            },
            diffSq: () => {
                const a = getRandomInt(1, 5);
                return { poly: mkFrac(`x^2 - ${a*a}`), fact: `x \\neq \\pm ${a}`, type: "diffSq" };
            },
            sqBin: () => {
                const a = getRandomInt(1, 5);
                const s = Math.random() > 0.5 ? '+' : '-';
                const res = s === '+' ? -a : a;
                return { poly: mkFrac(`x^2 ${s} ${2*a}x + ${a*a}`), fact: `x \\neq ${res}`, type: "sqBin" };
            },
            trinom: () => {
                let a = getRandomInt(1, 4), b = getRandomInt(1, 4);
                if (a === b) b++;
                const sA = Math.random() > 0.5 ? 1 : -1;
                const sB = Math.random() > 0.5 ? 1 : -1;
                const sum = (a*sA) + (b*sB);
                const prod = (a*sA) * (b*sB);
                let termX = "";
                if (sum !== 0) termX = sum > 0 ? (sum === 1 ? "+x" : `+${sum}x`) : (sum === -1 ? "-x" : `${sum}x`);
                const termKnown = prod > 0 ? `+${prod}` : `${prod}`;
                const resA = -1 * a * sA;
                const resB = -1 * b * sB;
                return { poly: mkFrac(`x^2 ${termX} ${termKnown}`), fact: `x \\neq ${resA}, ${resB}`, type: "trinom" };
            }
        };

        const generateCards = (levelId) => {
            const levelConfig = LEVELS.find(l => l.id === levelId);
            const pairsCount = levelConfig.pairs;
            const pairs = [];
            const usedSignatures = new Set();
            
            // 1. INSERIMENTO OBBLIGATORIO (e UNICO) della TRAPPOLA
            const trapItem = generators.trap();
            pairs.push(trapItem);
            usedSignatures.add(trapItem.poly);

            // Rimuoviamo 'trap' dai generatori disponibili per le prossime carte
            const otherTypes = Object.keys(generators).filter(k => k !== 'trap');
            
            let attempts = 0;
            while(pairs.length < pairsCount && attempts < 500) {
                attempts++;
                const rndType = otherTypes[Math.floor(Math.random() * otherTypes.length)];
                const item = generators[rndType]();
                if (!usedSignatures.has(item.poly)) {
                    usedSignatures.add(item.poly);
                    pairs.push(item);
                }
            }

            // Filler di sicurezza
            while(pairs.length < pairsCount) {
                 const n = pairs.length + 2;
                 const filler = { poly: mkFrac(`x - ${n}`), fact: `x \\neq ${n}`, type: "simple" };
                 if(!usedSignatures.has(filler.poly)) {
                     usedSignatures.add(filler.poly);
                     pairs.push(filler);
                 }
            }
            
            const deck = [];
            const shuffledEmojis = [...EMOJI_POOL].sort(()=>Math.random()-0.5);
            
            pairs.forEach((p, i) => {
                const color = PAIR_COLORS[i % PAIR_COLORS.length];
                deck.push({ 
                    id: `p${i}a`, 
                    pairId: i, 
                    content: p.poly, 
                    cardType: 'fraction', 
                    emoji: shuffledEmojis[i * 2], 
                    color, 
                    ...p 
                });
                deck.push({ 
                    id: `p${i}b`, 
                    pairId: i, 
                    content: p.fact, 
                    cardType: 'condition', 
                    emoji: shuffledEmojis[i * 2 + 1], 
                    color, 
                    ...p 
                });
            });
            return deck.sort(() => Math.random() - 0.5).map(c => ({...c, isFlipped: false, isMatched: false, seen: false}));
        };

        // Math Rendering
        const MathText = ({ txt, className = "" }) => {
            const defaultCardSize = "text-xl md:text-3xl"; 
            const appliedClass = className || defaultCardSize;

            const html = useMemo(() => {
                try {
                    return window.katex ? window.katex.renderToString(txt, { throwOnError: false, displayMode: true }) : txt;
                } catch (e) { return txt; }
            }, [txt]);

            return (
                <div 
                    className={`font-math flex items-center justify-center w-full h-full p-1 leading-relaxed ${appliedClass}`} 
                    dangerouslySetInnerHTML={{__html: html}} 
                />
            );
        };

        const saveScore = (entry) => {
            const lb = JSON.parse(localStorage.getItem('ce_match_lb') || '[]');
            lb.push(entry);
            lb.sort((a, b) => b.score - a.score || a.moves - b.moves);
            localStorage.setItem('ce_match_lb', JSON.stringify(lb.slice(0, 50)));
            return lb.slice(0, 50);
        };

        // --- APP ---
        function App() {
            const [theme, setTheme] = useState(localStorage.getItem('ce_theme') || 'light');
            const [view, setView] = useState('menu');
            const [nick, setNick] = useState(localStorage.getItem('ce_nick') || '');
            const [userAvatar, setUserAvatar] = useState(localStorage.getItem('ce_avatar') || AVATARS[0]);
            const [lvl, setLvl] = useState(1);
            const [lb, setLb] = useState([]);
            // Scaffolding State
            const [scaffolding, setScaffolding] = useState(localStorage.getItem('ce_scaffolding') === 'true');

            const [cards, setCards] = useState([]);
            const [moves, setMoves] = useState(0);
            const [score, setScore] = useState(0);
            const [accumulatedScore, setAccumulatedScore] = useState(0); // Punti delle partite precedenti (Rush)
            
            const [flipped, setFlipped] = useState([]); 
            const [lock, setLock] = useState(false);
            const [matchMsg, setMatchMsg] = useState(null);
            const [isRush, setIsRush] = useState(false);
            const [rushPhase, setRushPhase] = useState(null);
            const [timeLeft, setTimeLeft] = useState(0);

            useEffect(() => {
                const root = document.documentElement;
                if (theme === 'dark') {
                    root.classList.add('dark');
                    root.setAttribute('data-theme', 'dark');
                } else {
                    root.classList.remove('dark');
                    root.setAttribute('data-theme', 'light');
                }
                localStorage.setItem('ce_theme', theme);
            }, [theme]);

            useEffect(() => {
                setLb(JSON.parse(localStorage.getItem('ce_match_lb') || '[]'));
                if (!localStorage.getItem('ce_avatar')) {
                    const rnd = AVATARS[Math.floor(Math.random() * AVATARS.length)];
                    setUserAvatar(rnd);
                    localStorage.setItem('ce_avatar', rnd);
                }
            }, [view]);

            // Persist Scaffolding
            useEffect(() => {
                localStorage.setItem('ce_scaffolding', scaffolding);
            }, [scaffolding]);

            // Calcolo Punteggio Dinamico
            useEffect(() => {
                if (view !== 'game') return;

                const levelData = LEVELS.find(l => l.id === lvl);
                const minMoves = levelData.pairs; // Minimo mosse teoriche (1 mossa = 1 coppia trovata)
                const maxPoints = levelData.points;
                
                const matchesFound = cards.filter(c => c.isMatched).length / 2;
                
                // Se non abbiamo fatto mosse, il fattore Ã¨ 1.
                // Se moves > minMoves, il fattore decresce.
                // moves qui conta i TENTATIVI (click su coppia), quindi minMoves Ã¨ corretto come base.
                const effectiveMoves = Math.max(minMoves, moves);
                const efficiencyFactor = minMoves / Math.max(minMoves, effectiveMoves || 1);
                
                // Punteggio proporzionale al completamento E all'efficienza
                const completionRatio = matchesFound / minMoves;
                
                // Formula: MaxPoints * %Completamento * %Efficienza
                const currentLevelScore = Math.floor(maxPoints * completionRatio * efficiencyFactor);
                
                setScore(accumulatedScore + currentLevelScore);

            }, [moves, cards, view, accumulatedScore, lvl]);

            useEffect(() => {
                let timer;
                if (isRush && rushPhase) {
                    if (timeLeft > 0) {
                        timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                    } else {
                        if (rushPhase === 'mem') {
                            setRushPhase('play');
                            setTimeLeft(RUSH_PLAY_TIME);
                            setCards(c => c.map(card => ({ ...card, isFlipped: false })));
                        } else {
                            handleRushEnd(false);
                        }
                    }
                }
                return () => clearInterval(timer);
            }, [isRush, rushPhase, timeLeft]);

            const toggleTheme = () => setTheme(t => t === 'light' ? 'dark' : 'light');

            const handleCardClick = (id) => {
                if (lock || (isRush && rushPhase === 'mem')) return;
                const card = cards.find(c => c.id === id);
                if (card.isFlipped || card.isMatched) return;
                setCards(prev => prev.map(c => c.id === id ? { ...c, isFlipped: true, seen: true } : c));
                const newFlipped = [...flipped, id];
                setFlipped(newFlipped);
                if (newFlipped.length === 2) {
                    setLock(true);
                    if (!isRush) setMoves(m => m + 1); 
                    setTimeout(() => checkForMatch(newFlipped), 500); 
                }
            };

            const checkForMatch = ([id1, id2]) => {
                setCards(currentCards => {
                    const c1 = currentCards.find(c => c.id === id1);
                    const c2 = currentCards.find(c => c.id === id2);
                    let nextCards = [...currentCards];
                    
                    if (c1.pairId === c2.pairId) {
                        nextCards = nextCards.map(c => (c.id === id1 || c.id === id2) ? { ...c, isMatched: true, isFlipped: true } : c);
                        
                        setMatchMsg({ text: "C.E. Individuata!", sub: EXPLANATIONS[c1.type] || "Ben fatto.", color: c1.color });
                        setTimeout(() => setMatchMsg(null), 3000);
                        setLock(false);
                        if (nextCards.filter(c => !c.isMatched).length === 0) {
                            if (isRush) handleRushEnd(true); else setTimeout(() => setView('win'), 1000);
                        }
                    } else {
                        setTimeout(() => {
                            setCards(prev => prev.map(c => (c.id === id1 || c.id === id2) ? { ...c, isFlipped: false } : c));
                            setLock(false);
                        }, 1200);
                    }
                    setFlipped([]);
                    return nextCards;
                });
            };

            const handleRushEnd = (won) => {
                setIsRush(false);
                setRushPhase(null);
                // Il raddoppio agisce sul punteggio finale calcolato
                // PoichÃ© setScore nel render dipende dall'effect, qui dobbiamo forzare lo stato finale
                if (won) {
                    setScore(s => s * 2);
                    setMatchMsg({ text: "RADDOPPIO RIUSCITO!", sub: "Punteggio duplicato.", color: "bg-yellow-100 text-yellow-900 dark:text-yellow-100 dark:bg-yellow-900" });
                } else {
                    setScore(s => Math.floor(s / 2)); 
                    setMatchMsg({ text: "TEMPO SCADUTO", sub: "Punteggio dimezzato.", color: "bg-red-100 text-red-900 dark:text-red-100 dark:bg-red-900" });
                }
                setTimeout(() => setView('final'), 2000);
            };

            const startGame = (rush = false) => {
                if (!rush) {
                    if (!nick.trim()) return alert("Inserisci un nome!");
                    localStorage.setItem('ce_nick', nick);
                    setAccumulatedScore(0);
                    setMoves(0);
                    setScore(0);
                } else {
                    // Inizio Rush: congelo il punteggio attuale come base
                    setAccumulatedScore(score);
                    setMoves(0);
                    // Il punteggio non si azzera visivamente, ma riparte il conteggio del livello rush
                }
                let newCards = generateCards(lvl);
                setCards(newCards);
                setFlipped([]);
                setLock(false);
                if (rush) {
                    setIsRush(true); setRushPhase('mem'); setTimeLeft(RUSH_MEM_TIME);
                    setCards(prev => prev.map(c => ({ ...c, isFlipped: true })));
                    setView('game');
                } else {
                    setIsRush(false); setView('game');
                }
            };

            const saveAndExit = () => {
                const currentLvl = LEVELS.find(l => l.id === lvl);
                saveScore({ name: nick, avatar: userAvatar, score: score, moves: moves, minMoves: currentLvl.pairs, lvl: currentLvl.label, date: new Date().toLocaleDateString() });
                setView('menu');
            };

            // --- RENDER UI ---
            if (view === 'menu') {
                return (
                    <div className="flex h-screen w-screen bg-background text-on-background">
                        <aside className="w-full md:w-1/3 max-w-md bg-surface border-r border-outline-variant flex flex-col shadow-xl z-20 h-full">
                            <div className="p-6 border-b border-outline-variant flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-black text-on-background tracking-tight">C.E. Match <span className="text-primary text-lg">v2</span></h1>
                                    <p className="text-xs text-outline-variant uppercase font-bold tracking-widest mt-1">Dominio Frazioni Algebriche</p>
                                </div>
                                <button onClick={toggleTheme} className="p-2 rounded-full bg-surface-container text-primary hover:bg-outline-variant transition-colors">
                                    {theme === 'light' ? Icons.Moon : Icons.Sun}
                                </button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-6 space-y-8 scroller">
                                <div className="space-y-2">
                                    <label className="text-xs font-bold uppercase text-outline-variant">IdentitÃ  Analista</label>
                                    <div className="flex gap-2">
                                        <button onClick={() => {
                                            const nextIdx = (AVATARS.indexOf(userAvatar) + 1) % AVATARS.length;
                                            setUserAvatar(AVATARS[nextIdx]);
                                            localStorage.setItem('ce_avatar', AVATARS[nextIdx]);
                                        }} className="bg-surface-container hover:bg-outline-variant cursor-pointer text-2xl w-12 h-12 flex items-center justify-center rounded-xl select-none transition-colors border border-outline-variant">
                                            {userAvatar}
                                        </button>
                                        <input value={nick} onChange={e => setNick(e.target.value)} placeholder="Il tuo nome..." className="w-full bg-surface-container rounded-xl px-4 font-bold text-on-background focus:ring-2 ring-primary outline-none transition-all border border-outline-variant"/>
                                    </div>
                                </div>

                                <div className="space-y-2">
                                    <div className="flex justify-between items-end">
                                        <label className="text-xs font-bold uppercase text-outline-variant">Configurazione</label>
                                        <button onClick={() => setScaffolding(!scaffolding)} className={`text-[10px] px-2 py-0.5 rounded-full border transition-all ${scaffolding ? 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800' : 'bg-surface-container text-outline-variant border-transparent'}`}>
                                            SCAFFOLDING {scaffolding ? 'ON' : 'OFF'}
                                        </button>
                                    </div>
                                    <div className="grid gap-2">
                                        {LEVELS.map(l => (
                                            <button key={l.id} onClick={() => setLvl(l.id)}
                                                className={`text-left p-3 rounded-xl border-2 transition-all flex justify-between items-center ${lvl === l.id ? 'border-primary bg-surface-container' : 'border-outline-variant hover:border-primary hover:bg-surface-container'}`}
                                            >
                                                <div>
                                                    <div className="font-bold text-sm text-on-background">{l.label}</div>
                                                    <div className="text-[10px] opacity-60 text-on-background">{l.desc}</div>
                                                </div>
                                                {lvl === l.id && <div className="text-primary">{Icons.Check}</div>}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="bg-background rounded-2xl border border-outline-variant p-4">
                                    <div className="flex items-center gap-2 mb-3 pb-2 border-b border-outline-variant">
                                        <div className="text-yellow-500">{Icons.Trophy}</div>
                                        <span className="font-bold text-xs uppercase tracking-wide text-outline-variant">Hall of Fame</span>
                                    </div>
                                    <div className="max-h-40 overflow-y-auto scroller space-y-2">
                                        {lb.length === 0 && <div className="text-xs text-center py-4 opacity-40 text-on-background">Nessun dato</div>}
                                        {lb.map((row, i) => (
                                            <div key={i} className="flex justify-between items-center text-xs p-2 bg-surface rounded-lg shadow-sm border border-outline-variant">
                                                <div className="flex gap-2 items-center">
                                                    <span className={`w-4 h-4 rounded-full flex items-center justify-center font-mono font-bold ${i<3 ? 'bg-yellow-100 text-yellow-700' : 'bg-surface-container text-outline-variant'}`}>{i+1}</span>
                                                    <span className="text-lg leading-none">{row.avatar || 'ðŸ‘¤'}</span>
                                                    <span className="font-bold text-on-background truncate max-w-[80px]">{row.name}</span>
                                                </div>
                                                <div className="flex flex-col items-end">
                                                    <div className="text-primary font-bold">{row.score}pt</div>
                                                    <div className="text-[9px] text-outline-variant font-mono">
                                                        {row.moves} / {row.minMoves || '-'}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="p-6 border-t border-outline-variant">
                                <button onClick={() => startGame(false)} className="w-full py-4 bg-primary hover:opacity-90 text-on-background rounded-xl font-bold shadow-xl active:scale-95 transition-all flex justify-center gap-2">
                                    INIZIA {Icons.Play}
                                </button>
                            </div>
                        </aside>

                        <main className="hidden md:flex flex-1 bg-background items-center justify-center relative overflow-hidden">
                             <div className="absolute inset-0 opacity-[0.03] bg-[url('https://www.transparenttextures.com/patterns/graphy.png')] dark:opacity-[0.05] dark:invert"></div>
                             <div className="w-full max-w-7xl p-4 md:p-8">
                                <div className="bg-surface p-6 md:p-10 rounded-3xl shadow-2xl border border-outline-variant h-full flex flex-col">
                                    <div className="flex items-center gap-4 mb-6 md:mb-8 shrink-0">
                                        <div className="p-4 bg-surface-container text-primary rounded-2xl">{Icons.Book}</div>
                                        <div>
                                            <h2 className="text-2xl md:text-3xl font-black text-on-background">BRIEFING C.E.</h2>
                                            <p className="text-outline-variant font-medium">Analisi delle singolaritÃ </p>
                                        </div>
                                    </div>
                                    <div className="space-y-6 flex-1 overflow-y-auto scroller pr-2">
                                        <div className="p-5 bg-amber-50 rounded-xl border border-amber-100 flex gap-4 items-start dark:bg-amber-900/20 dark:border-amber-800">
                                            <div className="text-amber-600 mt-1 shrink-0 dark:text-amber-400">{Icons.Target}</div>
                                            <div>
                                                <h3 className="font-bold text-amber-900 text-sm mb-1 uppercase tracking-widest dark:text-amber-200">Obiettivo Primario</h3>
                                                <p className="text-amber-800 text-sm leading-relaxed font-medium dark:text-amber-300">Associa ogni <strong>Frazione Algebrica</strong> alla sua <strong>Condizione di Esistenza</strong>.</p>
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <h3 className="font-bold text-outline-variant text-xs uppercase tracking-widest border-b border-outline-variant pb-2">Database Pattern</h3>
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                                {BRIEFING_ITEMS.map((item, idx) => (
                                                    <div key={idx} className={`p-3 rounded-xl border-2 transition-colors flex flex-col justify-center min-h-[120px] w-full ${item.color}`}>
                                                        <div className="text-[10px] font-bold opacity-50 mb-1 uppercase tracking-wider text-center text-on-background">{item.title}</div>
                                                        <div className="w-full flex justify-center flex-wrap">
                                                            <MathText txt={item.tex} className="text-base text-on-background"/>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                             </div>
                        </main>
                    </div>
                );
            }

            // RENDER GAME
            const isGameView = view === 'game' || view === 'win' || view === 'final';
            if (isGameView) {
                const n = cards.length;
                let gridClass = "";
                if (n === 6) gridClass = "grid-cols-3 grid-rows-2";
                else if (n === 12) gridClass = "grid-cols-4 grid-rows-3";
                else if (n === 16) gridClass = "grid-cols-4 grid-rows-4";
                else if (n === 20) gridClass = "grid-cols-5 grid-rows-4";
                else gridClass = "grid-cols-4"; 

                return (
                    <div className="h-screen w-screen flex flex-col bg-background overflow-hidden">
                        <header className="h-16 bg-surface shadow-sm flex items-center justify-between px-4 z-20 shrink-0 border-b border-outline-variant">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setView('menu')} className="text-xs font-bold text-outline-variant hover:text-red-500 uppercase tracking-wider transition-colors">ESCI</button>
                                {isRush && (
                                    <div className={`flex items-center gap-2 px-3 py-1 rounded-lg font-mono font-bold ${rushPhase==='mem'?'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-100':'bg-red-100 text-red-700 animate-pulse dark:bg-red-900 dark:text-red-100'}`}>
                                        {Icons.Timer} {timeLeft}s
                                    </div>
                                )}
                                {!isRush && (
                                    <div className="flex flex-col">
                                        <span className="text-[10px] font-bold text-outline-variant uppercase leading-none">Punti</span>
                                        <span className="text-xl font-mono font-bold text-primary leading-none">{score}</span>
                                    </div>
                                )}
                            </div>
                            {matchMsg && (
                                <div className={`absolute top-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl border-2 flex items-center gap-3 animate-bounce z-50 bg-surface ${matchMsg.color || 'border-indigo-100'} dark:bg-slate-800 dark:border-slate-600`}>
                                    <div className="bg-green-100 text-green-600 rounded-full p-1 dark:bg-green-900 dark:text-green-300">{Icons.Check}</div>
                                    <div className="text-left">
                                        <div className="font-black text-on-background text-sm">{matchMsg.text}</div>
                                        <div className="text-xs font-bold text-outline-variant uppercase">{matchMsg.sub}</div>
                                    </div>
                                </div>
                            )}
                        </header>
                        <main className="flex-1 p-2 md:p-6 overflow-hidden flex items-center justify-center bg-background">
                            <div className={`grid gap-3 w-full max-w-6xl h-full max-h-full ${gridClass}`}>
                                {cards.map(card => {
                                    // LOGICA SCAFFOLDING
                                    // Se scaffolding Ã¨ attivo, usiamo la proprietÃ  'ghost' del livello O forziamo true se vogliamo che sia sempre attivo col tasto.
                                    // Interpretazione richiesta: il tasto "scaffolding" attiva la modalitÃ  ghost (vedere le carte girate) 
                                    const showGhostContent = (card.seen && scaffolding); 
                                    const isFaceUp = card.isFlipped || card.isMatched;
                                    
                                    let flipperStyle = "bg-surface border-outline-variant"; 
                                    if (card.isMatched) {
                                        flipperStyle = `${card.color} border-solid`;
                                    } else if (card.cardType === 'fraction') {
                                        flipperStyle = "bg-surface border-slate-300 border-solid dark:border-slate-500";
                                    } else {
                                        flipperStyle = "bg-background border-slate-400 border-dashed dark:border-slate-500";
                                    }

                                    return (
                                        <div key={card.id} onClick={() => handleCardClick(card.id)} className="perspective-1000 relative cursor-pointer w-full h-full min-h-0 group">
                                            <div className={`flipper w-full h-full shadow-sm rounded-xl border-2 transition-all duration-500
                                                ${flipperStyle}
                                                ${isFaceUp ? 'flipped' : 'hover:border-primary hover:-translate-y-1'}
                                            `}>
                                                <div className="face face-front rounded-xl overflow-hidden flex items-center justify-center bg-transparent">
                                                    {showGhostContent ? (
                                                        <div className="opacity-60 w-full h-full flex items-center justify-center p-2 text-on-background">
                                                             <MathText txt={card.content} className="" />
                                                        </div>
                                                    ) : (
                                                        <span className="text-4xl md:text-5xl select-none transform transition-transform duration-300 group-hover:scale-110">
                                                            {card.emoji}
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="face face-back p-1 rounded-xl flex items-center justify-center bg-transparent">
                                                    <div className="w-full h-full flex items-center justify-center text-center text-on-background">
                                                        <MathText 
                                                            txt={card.content} 
                                                            className="font-black tracking-tight break-words w-full" 
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </main>
                        {view === 'win' && (
                            <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in">
                                <div className="bg-surface p-8 rounded-3xl shadow-2xl text-center max-w-md w-full relative overflow-hidden border border-outline-variant">
                                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary to-secondary"></div>
                                    <h2 className="text-4xl font-black text-on-background mb-2">OTTIMO LAVORO!</h2>
                                    <p className="text-outline-variant mb-8">C.E. Identificate. Punti: <strong className="text-primary">{score}</strong></p>
                                    <div className="space-y-3">
                                        <button onClick={() => startGame(true)} className="w-full py-4 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 rounded-2xl font-black shadow-lg hover:shadow-xl transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                                            {Icons.Zap} RADDOPPIA (RUSH)
                                        </button>
                                        <p className="text-xs text-outline-variant italic">Trova {cards.length/2} coppie in {isRush ? RUSH_MEM_TIME + RUSH_PLAY_TIME : 'tempo libero'}.</p>
                                        <div className="h-px bg-surface-container my-4"></div>
                                        <button onClick={saveAndExit} className="w-full py-3 bg-surface border-2 border-outline-variant text-on-background rounded-2xl font-bold hover:bg-surface-container transition-colors">
                                            SALVA E ESCI
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                         {view === 'final' && (
                            <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-in zoom-in-95">
                                <div className="text-center text-on-background">
                                    <div className="text-6xl mb-4">{score > 100 ? 'ðŸš€' : 'ðŸ“‰'}</div>
                                    <h2 className="text-5xl font-black mb-2">{score} PT</h2>
                                    <p className="text-xl opacity-70 mb-8 font-medium">RISULTATO FINALE</p>
                                    <button onClick={saveAndExit} className="px-8 py-3 bg-surface text-on-background rounded-full font-bold hover:scale-105 transition-transform">
                                        TORNA AL MENU
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
