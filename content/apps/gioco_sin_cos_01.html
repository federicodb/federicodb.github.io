<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    
    <!-- 1. META DATI PER CATALOGAZIONE -->
    <title>GonioMatch: Segnali Goniometrici</title>
    <!-- Shared Orfini Design System -->
    <link rel="stylesheet" href="../assets/style/orfini-shared.css">
    <script src="../assets/js/orfini-shared.js"></script>

    <meta name="description" content="Gioco Memory a tema Radar per memorizzare gli angoli notevoli di Seno, Coseno e Tangente.">
    <meta name="keywords" content="Matematica, Goniometria, Trigonometria, Funzioni, Angoli, 3MEC, 4EL, Mat:Analisi, Lab, Gamification">
    <meta name="date" content="2025-12-08">

    <!-- 2. FIX MOBILE -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <title>GonioMatch - Signal Processing</title>

    <!-- Shared Orfini Design System -->
    <link rel="stylesheet" href="../assets/style/orfini-shared.css">
    <script src="../assets/js/orfini-shared.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Configurazione Tailwind per Dark Mode e Font -->
    <script>
        tailwind.config = {
            darkMode: ['class', '[data-theme="dark"]'],
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        math: ['Noto Serif', 'serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    colors: {
                        background: 'var(--md-sys-color-background)',
                        'on-background': 'var(--md-sys-color-on-background)',
                        surface: 'var(--md-sys-color-surface)',
                        'surface-container': 'var(--md-sys-color-surface-container)',
                        'on-surface-variant': 'var(--md-sys-color-on-surface-variant)',
                        'outline-variant': 'var(--md-sys-color-outline-variant)',
                        primary: 'var(--md-sys-color-primary)',
                        'on-primary': 'var(--md-sys-color-on-primary)',
                        radar: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            900: '#14532d',
                            950: '#052e16',
                        }
                    }
                }
            }
        }
    </script>

    <!-- KaTeX per la matematica -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Serif:wght@700&family=Fira+Code:wght@500&display=swap');

        /* 3. CSS FULLSCREEN ROBUSTO */
        html, body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100dvh; /* Dynamic Viewport Height */
            position: fixed; /* Inchioda la pagina su iOS */
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            margin: 0; padding: 0;
        }

        /* --- 3D CARD ENGINE --- */
        .perspective-1000 {
            perspective: 1000px;
        }

        .flipper {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            will-change: transform;
        }

        .flipper.flipped {
            transform: rotateY(180deg);
        }

        .face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            overflow: hidden; /* Taglia contenuto extra */
        }

        .face-front {
            transform: rotateY(0deg);
        }

        .face-back {
            transform: rotateY(180deg);
        }

        /* Scrollbar Nascosta per Card Content */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Scrollbar Visibile per Liste */
        .scroller::-webkit-scrollbar {
            width: 4px;
        }

        .scroller::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark .scroller::-webkit-scrollbar-thumb {
            background: #475569;
        }

        /* Griglia CRT per sfondo */
        .bg-crt {
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
        }
    </style>
</head>

<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIGURAZIONE COSTANTI ---
        const RUSH_MEM_TIME = 10;
        const RUSH_PLAY_TIME = 120;

        const AVATARS = ['üì°', 'üî≠', 'üõ∞Ô∏è', 'üìª', 'üß¨', 'üî¨', 'ü•Ω', 'üíæ', 'üïπÔ∏è', 'üìü', 'üîã', 'üèóÔ∏è'];

        // EMOJI "RADAR/SIGNAL" THEME
        const EMOJI_POOL = [
            'üì°', 'üåä', 'üìª', 'üîä', 'üì∂', 'üîå', 'üîã', 'üíø', 'üíæ', 'üïπÔ∏è', 'üì∫', 'üß≠',
            '‚è≤Ô∏è', 'üß≤', 'üß¨', 'üå°Ô∏è', 'üìê', 'üìè', 'üìé', 'üìå', 'üìç', 'üî≠', 'üî¨', 'ü©∏',
            'ü¶†', 'üíä', 'ü©∫', 'üß™', 'üßπ', 'üîß', 'üî®', '‚õèÔ∏è', 'üî©', '‚öôÔ∏è', 'üß±', 'üõ¢Ô∏è'
        ];

        // COLORI PER COPPIE (Alto contrasto e distintivi)
        const PAIR_COLORS = [
            'bg-rose-50 text-rose-900 border-rose-400 dark:bg-rose-950/40 dark:text-rose-200 dark:border-rose-700',
            'bg-emerald-50 text-emerald-900 border-emerald-400 dark:bg-emerald-950/40 dark:text-emerald-200 dark:border-emerald-700',
            'bg-sky-50 text-sky-900 border-sky-400 dark:bg-sky-950/40 dark:text-sky-200 dark:border-sky-700',
            'bg-amber-50 text-amber-900 border-amber-400 dark:bg-amber-950/40 dark:text-amber-200 dark:border-amber-700',
            'bg-violet-50 text-violet-900 border-violet-400 dark:bg-violet-950/40 dark:text-violet-200 dark:border-violet-700',
            'bg-orange-50 text-orange-900 border-orange-400 dark:bg-orange-950/40 dark:text-orange-200 dark:border-orange-700',
            'bg-pink-50 text-pink-900 border-pink-400 dark:bg-pink-950/40 dark:text-pink-200 dark:border-pink-700',
            'bg-cyan-50 text-cyan-900 border-cyan-400 dark:bg-cyan-950/40 dark:text-cyan-200 dark:border-cyan-700',
            'bg-lime-50 text-lime-900 border-lime-400 dark:bg-lime-950/40 dark:text-lime-200 dark:border-lime-700',
            'bg-fuchsia-50 text-fuchsia-900 border-fuchsia-400 dark:bg-fuchsia-950/40 dark:text-fuchsia-200 dark:border-fuchsia-700',
        ];

        const LEVELS = [
            { id: 0, label: "Calibrazione", desc: "6 Carte (3 Coppie)", pairs: 3, points: 300, ghost: true },
            { id: 1, label: "Segnale Base", desc: "12 Carte (6 Coppie)", pairs: 6, points: 600, ghost: false },
            { id: 2, label: "Modulazione", desc: "16 Carte (8 Coppie)", pairs: 8, points: 1200, ghost: false },
            { id: 3, label: "Frequenza Alta", desc: "20 Carte (10 Coppie)", pairs: 10, points: 2000, ghost: false }
        ];

        const ANSWER_BUCKETS = [
            { id: 'zero', val: '0', qs: ['\\sin(0)', '\\sin(180^\\circ)', '\\sin(\\pi)', '\\cos(90^\\circ)', '\\cos(\\frac{\\pi}{2})', '\\tan(0)'] },
            { id: 'one', val: '1', qs: ['\\sin(90^\\circ)', '\\cos(0)', '\\cos(360^\\circ)', '\\tan(45^\\circ)', '\\sin^2(x)+\\cos^2(x)'] },
            { id: 'minus1', val: '-1', qs: ['\\sin(270^\\circ)', '\\cos(180^\\circ)', '\\cos(\\pi)', '\\sin(\\frac{3}{2}\\pi)'] },
            { id: 'half', val: '\\frac{1}{2}', qs: ['\\sin(30^\\circ)', '\\sin(\\frac{\\pi}{6})', '\\cos(60^\\circ)', '\\cos(\\frac{\\pi}{3})'] },
            { id: 'mhalf', val: '-\\frac{1}{2}', qs: ['\\sin(210^\\circ)', '\\cos(120^\\circ)', '\\cos(\\frac{2}{3}\\pi)', '\\sin(330^\\circ)'] },
            { id: 'sq2_2', val: '\\frac{\\sqrt{2}}{2}', qs: ['\\sin(45^\\circ)', '\\cos(45^\\circ)', '\\sin(\\frac{\\pi}{4})'] },
            { id: 'msq2_2', val: '-\\frac{\\sqrt{2}}{2}', qs: ['\\sin(225^\\circ)', '\\cos(135^\\circ)', '\\sin(\\frac{5}{4}\\pi)'] },
            { id: 'sq3_2', val: '\\frac{\\sqrt{3}}{2}', qs: ['\\sin(60^\\circ)', '\\cos(30^\\circ)', '\\sin(\\frac{\\pi}{3})'] },
            { id: 'msq3_2', val: '-\\frac{\\sqrt{3}}{2}', qs: ['\\sin(300^\\circ)', '\\cos(150^\\circ)', '\\cos(\\frac{5}{6}\\pi)'] },
            { id: 'sq3', val: '\\sqrt{3}', qs: ['\\tan(60^\\circ)', '\\tan(\\frac{\\pi}{3})', '\\cot(30^\\circ)'] },
            { id: 'invsq3', val: '\\frac{\\sqrt{3}}{3}', qs: ['\\tan(30^\\circ)', '\\tan(\\frac{\\pi}{6})', '\\cot(60^\\circ)'] },
            { id: 'minvsq3', val: '-\\frac{\\sqrt{3}}{3}', qs: ['\\tan(150^\\circ)', '\\tan(\\frac{5}{6}\\pi)'] }
        ];

        const TRAP_CARDS = [
            { q: '\\tan(90^\\circ)', a: '\\nexists', hint: 'Asintoto Verticale' },
            { q: '\\tan(\\frac{\\pi}{2})', a: '\\nexists', hint: 'Asintoto Verticale' },
            { q: '\\sin(x) = 2', a: '\\emptyset', hint: 'Fuori dal Codominio [-1, 1]' },
            { q: '\\cos(x) = -1.5', a: '\\emptyset', hint: 'Fuori dal Codominio [-1, 1]' },
            { q: '\\sqrt{-1}', a: '\\notin \\mathbb{R}', hint: 'Numero Immaginario' },
            { q: '\\frac{1}{\\sin(0)}', a: '\\nexists', hint: 'Divisione per Zero' }
        ];

        // Briefing Pedagogico
        const BRIEFING_ITEMS = [
            { title: "Identit√† Fondamentale", tex: "\\sin^2(x) + \\cos^2(x) = 1", color: "bg-emerald-50 border-emerald-200 text-emerald-900" },
            { title: "Angoli Notevoli (30¬∞)", tex: "\\begin{cases} \\sin(30^\\circ) = 1/2 \\\\ \\cos(30^\\circ) = \\sqrt{3}/2 \\end{cases}", color: "bg-sky-50 border-sky-200 text-sky-900" },
            { title: "Angoli Notevoli (45¬∞)", tex: "\\sin(45^\\circ) = \\cos(45^\\circ) = \\frac{\\sqrt{2}}{2}", color: "bg-violet-50 border-violet-200 text-violet-900" },
            { title: "La Trappola (Range)", tex: "-1 \\leq \\sin(x) \\leq 1", color: "bg-amber-50 border-amber-200 text-amber-900" },
            { title: "La Trappola (Tan)", tex: "\\tan(90^\\circ) \\rightarrow \\infty \\; (\\nexists)", color: "bg-red-50 border-red-200 text-red-900" }
        ];

        // --- ICONE SVG ---
        const Icon = ({ d, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>
        );
        const Icons = {
            Radar: <Icon d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0 M12 12m-5 0a5 5 0 1 0 10 0a5 5 0 1 0 -10 0 M12 12v-9 M12 12l4 4" />,
            Wave: <Icon d="M4 15l3 -6l3 6l3 -6l3 6l3 -6l3 6l3 -6l3 6" />,
            Warning: <Icon d="M12 9v2m0 4v.01M5.07 19H18.93a2 2 0 001.73-3L13.73 4a2 2 0 00-3.46 0L3.34 16a2 2 0 001.73 3z" />,
            Check: <Icon d="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4 12 14.01 9 11.01" />,
            Play: <Icon d="M5 3l14 9-14 9V3z" />,
            Timer: <Icon d="M10 2h4 M12 14l3-3 M12 14v-4 M12 22a8 8 0 1 0 0-16 8 8 0 0 0 0 16z" />,
            Trophy: <Icon d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6 M18 9h1.5a2.5 2.5 0 0 0 0-5H18 M4 22h16 M10 14.66V17 M14 14.66V17 M12 2v10 M12 17a5 5 0 0 0-5 4 M12 17a5 5 0 0 1 5 4" />,
            Sun: <Icon d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />,
            Moon: <Icon d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
        };

        // --- MATH ENGINE (Fix Overflow) ---
        const MathText = ({ txt, className = "" }) => {
            const defaultCardSize = "text-base md:text-xl lg:text-2xl"; // Font slightly adjusted
            const appliedClass = className || defaultCardSize;
            
            const html = useMemo(() => {
                try {
                    return window.katex ? window.katex.renderToString(txt, { throwOnError: false, displayMode: true }) : txt;
                } catch (e) { return txt; }
            }, [txt]);

            return (
                <div 
                    className={`font-math w-full h-full flex flex-col justify-center items-center p-2 leading-relaxed overflow-y-auto hide-scrollbar break-words ${appliedClass}`} 
                    dangerouslySetInnerHTML={{ __html: html }} 
                />
            );
        };

        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        const generateCards = (levelId) => {
            const levelConfig = LEVELS.find(l => l.id === levelId);
            const pairsCount = levelConfig.pairs;
            const pairs = [];

            // 1. SELECT ONE TRAP (MANDATORY)
            const trap = TRAP_CARDS[getRandomInt(0, TRAP_CARDS.length - 1)];
            pairs.push({
                q: trap.q,
                a: trap.a,
                type: 'trap',
                hint: trap.hint
            });

            // 2. SELECT UNIQUE ANSWER BUCKETS
            const shuffledBuckets = [...ANSWER_BUCKETS].sort(() => Math.random() - 0.5);

            for (let i = 0; i < pairsCount - 1; i++) {
                if (i < shuffledBuckets.length) {
                    const bucket = shuffledBuckets[i];
                    const rndQ = bucket.qs[getRandomInt(0, bucket.qs.length - 1)];
                    pairs.push({
                        q: rndQ,
                        a: bucket.val,
                        type: 'standard',
                        hint: 'Analisi Segnale'
                    });
                } else {
                    pairs.push({ q: 'ERROR', a: 'RETRY', type: 'error' });
                }
            }

            // 3. GENERATE DECK
            const deck = [];
            const shuffledEmojis = [...EMOJI_POOL].sort(() => Math.random() - 0.5);

            pairs.forEach((p, i) => {
                const color = PAIR_COLORS[i % PAIR_COLORS.length];
                deck.push({ id: `p${i}a`, pairId: i, content: p.q, cardType: 'q', emoji: shuffledEmojis[i * 2], color, ...p });
                deck.push({ id: `p${i}b`, pairId: i, content: p.a, cardType: 'a', emoji: shuffledEmojis[i * 2 + 1], color, ...p });
            });

            return deck.sort(() => Math.random() - 0.5).map(c => ({ ...c, isFlipped: false, isMatched: false, seen: false }));
        };

        const saveScore = (entry) => {
            const lb = JSON.parse(localStorage.getItem('gm_lb') || '[]');
            lb.push(entry);
            lb.sort((a, b) => b.score - a.score || a.moves - b.moves);
            localStorage.setItem('gm_lb', JSON.stringify(lb.slice(0, 50)));
            return lb.slice(0, 50);
        };

        // --- APP COMPONENT ---
        function App() {
            // Theme managed globally but forcing Light for readability
            const [view, setView] = useState('menu');
            const [nick, setNick] = useState(localStorage.getItem('gm_nick') || '');
            const [userAvatar, setUserAvatar] = useState(localStorage.getItem('gm_avatar') || AVATARS[0]);
            const [lvl, setLvl] = useState(1);
            const [scaffoldMode, setScaffoldMode] = useState(false); // NEW
            const [lb, setLb] = useState([]);

            const [cards, setCards] = useState([]);
            const [moves, setMoves] = useState(0);
            
            // Force Light Theme
            useEffect(() => {
                document.documentElement.setAttribute('data-theme', 'light');
                document.documentElement.classList.remove('dark');
            }, []);
            const [score, setScore] = useState(0);
            const [accumulatedScore, setAccumulatedScore] = useState(0);

            const [flipped, setFlipped] = useState([]);
            const [lock, setLock] = useState(false);
            const [matchMsg, setMatchMsg] = useState(null);
            const [isRush, setIsRush] = useState(false);
            const [rushPhase, setRushPhase] = useState(null);
            const [timeLeft, setTimeLeft] = useState(0);

            useEffect(() => {
                setLb(JSON.parse(localStorage.getItem('gm_lb') || '[]'));
                if (!localStorage.getItem('gm_avatar')) setUserAvatar(AVATARS[0]);
            }, [view]);

            useEffect(() => {
                if (view !== 'game') return;
                const levelData = LEVELS.find(l => l.id === lvl);
                const minMoves = levelData.pairs;
                const maxPoints = levelData.points;
                const matchesFound = cards.filter(c => c.isMatched).length / 2;
                const effectiveMoves = Math.max(minMoves, moves);
                const efficiencyFactor = minMoves / Math.max(minMoves, effectiveMoves || 1);
                const completionRatio = matchesFound / minMoves;
                setScore(accumulatedScore + Math.floor(maxPoints * completionRatio * efficiencyFactor));
            }, [moves, cards, view, accumulatedScore, lvl]);

            useEffect(() => {
                let timer;
                if (isRush && rushPhase) {
                    if (timeLeft > 0) timer = setInterval(() => setTimeLeft(t => t - 1), 1000);
                    else {
                        if (rushPhase === 'mem') {
                            setRushPhase('play'); setTimeLeft(RUSH_PLAY_TIME);
                            setCards(c => c.map(card => ({ ...card, isFlipped: false })));
                        } else handleRushEnd(false);
                    }
                }
                return () => clearInterval(timer);
            }, [isRush, rushPhase, timeLeft]);


            const handleCardClick = (id) => {
                if (lock || (isRush && rushPhase === 'mem')) return;
                const card = cards.find(c => c.id === id);
                if (card.isFlipped || card.isMatched) return;

                setCards(prev => prev.map(c => c.id === id ? { ...c, isFlipped: true, seen: true } : c));
                const newFlipped = [...flipped, id];
                setFlipped(newFlipped);

                if (newFlipped.length === 2) {
                    setLock(true);
                    if (!isRush) setMoves(m => m + 1);
                    setTimeout(() => checkForMatch(newFlipped), 500);
                }
            };

            const checkForMatch = ([id1, id2]) => {
                setCards(currentCards => {
                    const c1 = currentCards.find(c => c.id === id1);
                    const c2 = currentCards.find(c => c.id === id2);
                    let nextCards = [...currentCards];

                    if (c1.pairId === c2.pairId) {
                        nextCards = nextCards.map(c => (c.id === id1 || c.id === id2) ? { ...c, isMatched: true, isFlipped: true } : c);
                        let msgText = "Segnale Agganciato";
                        if (c1.type === 'trap') msgText = "Anomalia Identificata!";
                        setMatchMsg({ text: msgText, sub: c1.hint, color: c1.color });
                        setTimeout(() => setMatchMsg(null), 2500);
                        setLock(false);
                        if (nextCards.filter(c => !c.isMatched).length === 0) {
                            if (isRush) handleRushEnd(true); else setTimeout(() => setView('win'), 1000);
                        }
                    } else {
                        setTimeout(() => {
                            setCards(prev => prev.map(c => (c.id === id1 || c.id === id2) ? { ...c, isFlipped: false } : c));
                            setLock(false);
                        }, 1200);
                    }
                    setFlipped([]);
                    return nextCards;
                });
            };

            const handleRushEnd = (won) => {
                setIsRush(false); setRushPhase(null);
                if (won) {
                    setScore(s => s * 2);
                    setMatchMsg({ text: "OVERCLOCK RIUSCITO", sub: "Punti x2", color: "bg-yellow-400 text-on-background border-yellow-600" });
                } else {
                    setScore(s => Math.floor(s / 2));
                    setMatchMsg({ text: "SEGNALE PERSO", sub: "Punti / 2", color: "bg-red-500 text-on-background border-red-700" });
                }
                setTimeout(() => setView('final'), 2000);
            };

            const startGame = (rush = false) => {
                if (!rush) {
                    if (!nick.trim()) return alert("Identificativo Operatore Richiesto");
                    localStorage.setItem('gm_nick', nick);
                    setAccumulatedScore(0); setMoves(0); setScore(0);
                } else {
                    setAccumulatedScore(score); setMoves(0);
                }
                let newCards = generateCards(lvl);
                setCards(newCards); setFlipped([]); setLock(false);
                if (rush) {
                    setIsRush(true); setRushPhase('mem'); setTimeLeft(RUSH_MEM_TIME);
                    setCards(prev => prev.map(c => ({ ...c, isFlipped: true })));
                    setView('game');
                } else {
                    setIsRush(false); setView('game');
                }
            };

            const saveAndExit = () => {
                const currentLvl = LEVELS.find(l => l.id === lvl);
                saveScore({ name: nick, avatar: userAvatar, score: score, moves: moves, minMoves: currentLvl.pairs, lvl: currentLvl.label, date: new Date().toLocaleDateString() });
                setView('menu');
            };

            // --- UI RENDERERS ---
            if (view === 'menu') {
                return (
                    <div className="flex h-full w-full bg-background text-on-background font-mono transition-colors duration-500">
                        <aside className="w-full md:w-1/3 max-w-md bg-surface border-r border-outline-variant flex flex-col shadow-xl z-20 h-full">
                            <div className="p-6 border-b border-outline-variant flex justify-between items-center bg-background">
                                <div><h1 className="text-2xl font-black text-on-background tracking-tighter flex items-center gap-2"><span className="text-3xl">{Icons.Radar}</span> GonioMatch</h1><p className="text-[10px] text-on-surface-variant uppercase font-bold tracking-widest mt-1">Signal Processing Unit v3.0</p></div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-6 space-y-8 scroller">
                                <div className="space-y-2"><label className="text-[10px] font-bold uppercase text-on-surface-variant tracking-widest">ID Operatore</label><div className="flex gap-2"><button onClick={() => { const nextIdx = (AVATARS.indexOf(userAvatar) + 1) % AVATARS.length; setUserAvatar(AVATARS[nextIdx]); localStorage.setItem('gm_avatar', AVATARS[nextIdx]); }} className="bg-surface-container hover:bg-outline-variant cursor-pointer text-2xl w-14 h-14 flex items-center justify-center rounded-lg border-2 border-outline-variant transition-all active:scale-95">{userAvatar}</button><input value={nick} onChange={e => setNick(e.target.value)} placeholder="NOME IN CODICE..." className="w-full bg-surface-container rounded-lg px-4 font-bold text-on-background border-2 border-transparent focus:border-radar-500 focus:bg-surface outline-none transition-all uppercase placeholder-on-surface-variant" /></div></div>
                                
                                {/* SCAFFOLDING TOGGLE (Radar Style) */}
                                <button onClick={() => setScaffoldMode(!scaffoldMode)} className={`w-full flex items-center justify-between p-3 rounded-lg border-2 transition-all ${scaffoldMode ? 'border-radar-500 bg-radar-50 dark:bg-radar-900/20' : 'border-outline-variant bg-surface'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className={`text-xl ${scaffoldMode ? 'text-radar-600' : 'text-on-surface-variant'}`}>üëª</div>
                                        <div className="text-left">
                                            <div className="font-bold text-xs uppercase tracking-widest text-on-background">Ghost Signal</div>
                                            <div className="text-[9px] font-mono text-on-surface-variant">Trace Persistence</div>
                                        </div>
                                    </div>
                                    <div className={`w-3 h-3 rounded-full border ${scaffoldMode ? 'bg-radar-500 border-radar-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'border-outline-variant'}`} />
                                </button>

                                <div className="space-y-2"><label className="text-[10px] font-bold uppercase text-on-surface-variant tracking-widest">Protocollo</label><div className="grid gap-2">{LEVELS.map(l => (<button key={l.id} onClick={() => setLvl(l.id)} className={`text-left p-3 rounded-lg border-2 transition-all flex justify-between items-center group ${lvl === l.id ? 'border-radar-500 bg-radar-50 dark:bg-radar-900/30 dark:border-radar-500' : 'border-outline-variant hover:border-radar-500/50 bg-surface'}`}><div><div className={`font-bold text-sm ${lvl === l.id ? 'text-primary' : 'text-on-surface-variant'}`}>{l.label}</div><div className="text-[10px] opacity-60 font-mono">{l.desc}</div></div>{lvl === l.id && <div className="text-primary animate-pulse">{Icons.Check}</div>}</button>))}</div></div>
                                <div className="bg-surface-container rounded-xl border border-outline-variant p-4"><div className="flex items-center gap-2 mb-3 pb-2 border-b border-outline-variant"><div className="text-yellow-500">{Icons.Trophy}</div><span className="font-bold text-[10px] uppercase tracking-widest text-on-surface-variant">Top Signals</span></div><div className="max-h-48 overflow-y-auto scroller space-y-2 font-sans">{lb.length === 0 && <div className="text-xs text-center py-4 opacity-40 font-mono">NO DATA LOGGED</div>}{lb.map((row, i) => (<div key={i} className="flex justify-between items-center text-xs p-2 bg-surface rounded border border-outline-variant shadow-sm"><div className="flex gap-2 items-center"><span className={`w-5 h-5 rounded flex items-center justify-center font-mono font-bold text-[10px] ${i < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-surface-container text-on-surface-variant'}`}>{i + 1}</span><span className="text-base leading-none">{row.avatar || 'üë§'}</span><span className="font-bold text-on-background truncate max-w-[80px] uppercase">{row.name}</span></div><div className="text-right"><div className="text-primary font-bold">{row.score}</div><div className="text-[9px] text-on-surface-variant font-mono">{row.moves}mv</div></div></div>))}</div></div>
                            </div>
                            <div className="p-6 border-t border-outline-variant bg-background"><button onClick={() => startGame(false)} className="w-full py-4 bg-primary hover:opacity-90 text-on-primary rounded-lg font-bold shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2 tracking-widest text-sm uppercase">Avvia Scansione {Icons.Play}</button></div>
                        </aside>
                        <main className="hidden md:flex flex-1 bg-crt items-center justify-center relative overflow-hidden bg-background">
                            <div className="w-full max-w-5xl p-8">
                                <div className="bg-surface/90 backdrop-blur p-10 rounded-2xl shadow-2xl border border-outline-variant h-full flex flex-col">
                                    <div className="flex items-center gap-6 mb-8 pb-6 border-b border-outline-variant"><div className="p-4 bg-primary/10 text-primary rounded-xl">{Icons.Wave}</div><div><h2 className="text-3xl font-black text-on-background tracking-tight">MANUALE DI CAMPO</h2><p className="text-on-surface-variant font-mono text-sm mt-1">Riferimenti Goniometrici Essenziali</p></div></div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 overflow-y-auto scroller pr-2">
                                        <div className="space-y-4"><div className="flex items-start gap-3 p-4 bg-background rounded-lg border-l-4 border-radar-500"><div className="text-primary mt-1">{Icons.Warning}</div><div><h3 className="font-bold text-on-background text-sm uppercase tracking-wide">Direttiva Primaria</h3><p className="text-on-surface-variant text-sm mt-1 leading-relaxed">Il sistema genera onde uniche. Associa ogni <strong>Funzione (Bordo Tratteggiato)</strong> al suo <strong>Valore Numerico (Bordo Continuo)</strong>. Attenzione alle trappole di segnale (valori impossibili).</p></div></div></div>
                                        <div className="space-y-3"><h3 className="font-bold text-on-surface-variant text-[10px] uppercase tracking-widest mb-2">Pattern Riconosciuti</h3>{BRIEFING_ITEMS.map((item, idx) => (<div key={idx} className={`p-3 rounded border flex flex-col justify-center min-h-[80px] ${item.color} bg-opacity-10 border-opacity-30`}><div className="text-[9px] font-bold opacity-70 mb-1 uppercase tracking-wider">{item.title}</div><div className="w-full overflow-x-auto no-scrollbar"><MathText txt={item.tex} className="text-sm text-left justify-start" /></div></div>))}</div>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            const isGameView = view === 'game' || view === 'win' || view === 'final';
            if (isGameView) {
                const n = cards.length;
                let gridClass = n === 6 ? "grid-cols-3 grid-rows-2" : n === 12 ? "grid-cols-4 grid-rows-3" : n === 16 ? "grid-cols-4 grid-rows-4" : "grid-cols-5 grid-rows-4";

                return (
                    <div className="h-full w-full flex flex-col bg-background overflow-hidden font-mono bg-crt">
                        <header className="h-16 bg-surface/80 backdrop-blur shadow-sm flex items-center justify-between px-6 z-30 shrink-0 border-b border-outline-variant">
                            <div className="flex items-center gap-6">
                                <button onClick={() => setView('menu')} className="text-[10px] font-bold text-on-surface-variant hover:text-red-500 uppercase tracking-widest border border-outline-variant rounded px-2 py-1 hover:border-red-400 transition-all">Abort Mission</button>
                                {isRush ? (<div className={`flex items-center gap-2 px-4 py-1.5 rounded-full font-bold text-sm border ${rushPhase === 'mem' ? 'bg-yellow-100 text-yellow-800 border-yellow-200' : 'bg-red-100 text-red-800 border-red-200 animate-pulse'}`}>{Icons.Timer} {timeLeft}s</div>) : (<div className="flex flex-col"><span className="text-[9px] font-bold text-on-surface-variant uppercase leading-none tracking-widest">Signal Strenght</span><span className="text-xl font-bold text-radar-600 leading-none mt-1 dark:text-radar-400">{score} dB</span></div>)}
                            </div>
                            {matchMsg && (<div className={`absolute top-20 left-1/2 -translate-x-1/2 px-8 py-4 rounded shadow-2xl border-l-4 flex items-center gap-4 animate-bounce z-50 bg-surface ${matchMsg.color || 'border-l-radar-500 border-outline-variant'}`}><div className="text-2xl">{matchMsg.text.includes('!') ? '‚ö†Ô∏è' : '‚úÖ'}</div><div><div className="font-black text-on-background text-base uppercase tracking-tight">{matchMsg.text}</div><div className="text-xs font-medium text-on-surface-variant uppercase font-sans">{matchMsg.sub}</div></div></div>)}
                        </header>
                        <main className="flex-1 p-2 md:p-6 overflow-hidden flex items-center justify-center relative">
                            <div className={`grid gap-3 md:gap-4 w-full max-w-6xl h-full max-h-full ${gridClass}`}>
                                {cards.map(card => {
                                    // LOGICA GHOST / SCAFFOLDING
                                    const isTrainingGhost = LEVELS.find(l => l.id === lvl).ghost;
                                    const showGhostContent = (isTrainingGhost || scaffoldMode) && card.seen;
                                    
                                    const isFaceUp = card.isFlipped || card.isMatched;
                                    let borderStyle = card.cardType === 'q' ? 'border-dashed' : 'border-solid';
                                    let flipperStyle = `bg-surface border-outline-variant ${borderStyle}`;
                                    let backContentStyle = "text-on-background";
                                    if (card.isMatched) flipperStyle = `${card.color} border-solid border-transparent shadow-none opacity-50`;
                                    else if (card.type === 'trap' && isFaceUp) { flipperStyle = "bg-red-50 border-solid border-red-500 dark:bg-red-900/50 dark:border-red-500"; backContentStyle = "text-red-700 dark:text-red-200"; }

                                    return (
                                        <div key={card.id} onClick={() => handleCardClick(card.id)} className="perspective-1000 relative cursor-pointer w-full h-full min-h-0 group select-none">
                                            <div className={`flipper w-full h-full shadow-md rounded-lg border-2 transition-all duration-300 ${flipperStyle} ${isFaceUp ? 'flipped' : 'hover:border-radar-400 hover:shadow-lg hover:-translate-y-0.5'}`}>
                                                <div className="face face-front rounded-lg overflow-hidden bg-surface">
                                                    {showGhostContent ? (
                                                        <div className="opacity-50 w-full h-full flex items-center justify-center p-1 blur-[0.5px]">
                                                            <MathText txt={card.content} className="text-xs md:text-sm text-on-surface-variant font-bold" />
                                                        </div>
                                                    ) : (
                                                        <div className="flex flex-col items-center justify-center opacity-80 group-hover:opacity-100 transition-opacity">
                                                            <span className="text-3xl md:text-5xl filter grayscale group-hover:grayscale-0 transition-all duration-300">{card.emoji}</span>
                                                            <div className="mt-2 w-8 h-1 bg-surface-container rounded-full group-hover:bg-radar-200 dark:group-hover:bg-radar-800 transition-colors"></div>
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="face face-back p-2 rounded-lg bg-surface/50 backdrop-blur-sm">
                                                    <div className={`w-full h-full flex items-center justify-center text-center ${backContentStyle}`}><MathText txt={card.content} className={`font-bold tracking-tight break-words w-full ${card.content.length > 10 ? 'text-lg' : 'text-2xl md:text-3xl'}`} /></div>
                                                    <div className="absolute top-1 right-2 text-[8px] font-bold uppercase opacity-30 tracking-widest">{card.cardType === 'q' ? 'INPUT' : 'VAL'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </main>
                        {view === 'win' && (
                            <div className="fixed inset-0 bg-background/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in">
                                <div className="bg-surface p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full relative overflow-hidden border border-outline-variant">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-radar-400 to-emerald-400"></div>
                                    <h2 className="text-3xl font-black text-on-background mb-1 tracking-tight">ANALISI COMPLETA</h2>
                                    <p className="text-on-surface-variant mb-8 text-sm font-mono uppercase tracking-wide">Integrit√† Dati: 100%</p>
                                    <div className="flex justify-center items-end gap-2 mb-8"><span className="text-5xl font-black text-radar-600 dark:text-radar-400">{score}</span><span className="text-sm font-bold text-on-surface-variant mb-2 uppercase">Punti</span></div>
                                    <div className="space-y-3"><button onClick={() => startGame(true)} className="w-full py-4 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 rounded-lg font-bold shadow-lg transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2 uppercase tracking-wide text-sm">{Icons.Zap} Overclock (Rush Mode)</button><button onClick={saveAndExit} className="w-full py-3 bg-surface border-2 border-outline-variant text-on-surface-variant rounded-lg font-bold hover:bg-surface-container transition-colors uppercase tracking-wide text-xs">Salva nel Log</button></div>
                                </div>
                            </div>
                        )}
                        {view === 'final' && (
                            <div className="fixed inset-0 bg-black/95 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-in zoom-in-95 font-mono">
                                <div className="text-center text-on-background border border-outline-variant p-10 rounded-3xl bg-surface">
                                    <div className="text-6xl mb-6">{score > 1000 ? 'üì°' : 'üìâ'}</div>
                                    <h2 className="text-6xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-b from-white to-slate-400">{score}</h2>
                                    <p className="text-sm text-radar-400 mb-8 font-bold uppercase tracking-[0.3em]">Risultato Finale</p>
                                    <button onClick={saveAndExit} className="px-10 py-4 bg-surface text-on-background rounded-full font-bold hover:scale-110 transition-transform shadow-[0_0_20px_rgba(255,255,255,0.3)]">RIAVVIA SISTEMA</button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>