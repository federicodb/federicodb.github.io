<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mercatore Lab - Debug Version</title>
    <!-- Shared Orfini Design System -->
    <link rel="stylesheet" href="../assets/style/orfini-shared.css">
    <script src="../assets/js/orfini-shared.js"></script>

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Laboratorio Proiezioni">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configurazione Sicura
        tailwind.config = {
            darkMode: ["class", "[data-theme='dark']"],
            theme: { extend: { colors: { background: '#0f172a' } } }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">

    <style>
        html, body { margin: 0; padding: 0; }
        
        #map-container {
            width: 100%; height: 100%; position: relative;
            background-color: #cbd5e1; display: flex; justify-content: center; align-items: center;
        }
        
        /* Loader e Error Box */
        #status-box {
            position: absolute; z-index: 50;
            background: rgba(0,0,0,0.8); color: white;
            padding: 15px 25px; border-radius: 8px;
            font-family: monospace; text-align: center;
        }
        .error { color: #f87171 !important; border: 1px solid #f87171; }

        .country { fill: #f8fafc; stroke: #475569; stroke-width: 0.5px; cursor: grab; }
        .country:hover { fill: #e2e8f0; }
        .selected-country { fill: #f43f5e; stroke: #881337; }
        
        #ui-layer { position: absolute; bottom: 20px; width: 100%; pointer-events: none; display: flex; justify-content: center; }
        .panel { background: rgba(15, 23, 42, 0.9); padding: 20px; border-radius: 16px; pointer-events: auto; max-width: 90%; }
    </style>
</head>
<body>

    <div id="map-container">
        <div id="status-box">Caricamento Mappa...</div>
        <svg id="world-map"></svg>
        
        <div id="ui-layer">
            <div class="panel">
                <h2 class="text-sm font-bold uppercase text-slate-400 mb-2 text-center">Mercatore Lab</h2>
                <div id="stats" class="text-center font-mono font-bold text-xl mb-2">Trascina una nazione</div>
                <button onclick="location.reload()" class="bg-blue-600 text-on-background px-4 py-2 rounded text-xs">Ricarica</button>
                <a href="../index.html" class="block mt-2 text-xs text-slate-500 underline text-center">Torna alla Home</a>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>

    <script>
        window.addEventListener('load', function() {
            const statusBox = document.getElementById('status-box');
            const container = document.getElementById('map-container');
            
            // 1. Controllo Dimensioni
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            if (!width || !height) {
                statusBox.innerText = "Errore: Container dimensione 0";
                statusBox.className = "error";
                return;
            }

            try {
                // 2. Setup SVG
                const svg = d3.select("#world-map")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("viewBox", `0 0 ${width} ${height}`);

                const projection = d3.geoMercator()
                    .scale((width / 6.3)) // Scala adattiva
                    .translate([width / 2, height / 1.5]); // Sposta leggermente in basso

                const path = d3.geoPath().projection(projection);
                
                // 3. Caricamento Dati
                d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json")
                    .then(data => {
                        const countries = topojson.feature(data, data.objects.countries).features;
                        
                        svg.selectAll(".country")
                            .data(countries)
                            .enter().append("path")
                            .attr("class", "country")
                            .attr("d", path)
                            .on("click", function(event, d) {
                                // Logica semplificata per test
                                alert("Hai cliccato: " + (d.properties.name || "Nazione"));
                            });

                        statusBox.style.display = 'none'; // Tutto OK
                    })
                    .catch(err => {
                        statusBox.innerHTML = "❌ Errore caricamento JSON:<br>" + err.message;
                        statusBox.className = "error";
                        console.error(err);
                    });

            } catch (e) {
                statusBox.innerHTML = "❌ Errore Script:<br>" + e.message;
                statusBox.className = "error";
            }
        });
    </script>
</body>
</html>