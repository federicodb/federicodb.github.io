<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Parabola Challenge: Disequazioni</title>
    <!-- Shared Orfini Design System -->
    <link rel="stylesheet" href="../assets/style/orfini-shared.css">
    <script src="../assets/js/orfini-shared.js"></script>

    <meta name="description" content="Videogioco didattico a livelli sulle disequazioni di secondo grado. Scaffolding progressivo fino all'input testuale libero.">
    <meta name="keywords" content="Matematica, Algebra, Disequazioni, Parabola, Scaffolding, 3EL, 4EL, Mat:Analisi, Mat:ProblemSolving, Gamification">
    <meta name="date" content="2025-12-08">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: ['class', '[data-theme="dark"]'],
            theme: {
                extend: {
                    colors: {
                        background: 'var(--md-sys-color-background)',
                        'on-background': 'var(--md-sys-color-on-background)',
                        surface: 'var(--md-sys-color-surface)',
                        'surface-container': 'var(--md-sys-color-surface-container)',
                        'on-surface-variant': 'var(--md-sys-color-on-surface-variant)',
                        'outline-variant': 'var(--md-sys-color-outline-variant)',
                        primary: 'var(--md-sys-color-primary)',
                        'on-primary': 'var(--md-sys-color-on-primary)',
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS FULLSCREEN */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }

        #app-wrapper { display: flex; flex-direction: column; height: 100%; width: 100%; }

        @media (min-width: 1024px) {
            #app-wrapper { flex-direction: row; }
            #sidebar { width: 340px; border-right: 1px solid var(--md-sys-color-outline-variant); border-bottom: none; }
            #main-content { flex: 1; }
        }

        #sidebar {
            background: var(--md-sys-color-surface); padding: 1rem; border-bottom: 1px solid var(--md-sys-color-outline-variant);
            display: flex; flex-direction: column; gap: 1rem; z-index: 20;
            flex-shrink: 0;
        }

        #main-content {
            position: relative; overflow-y: auto; overflow-x: hidden; padding: 1rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--md-sys-color-background);
        }

        .glass-panel {
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); border-radius: 1rem;
        }

        .lvl-btn {
            flex: 1; padding: 0.5rem; border-radius: 0.5rem;
            font-size: 0.75rem; font-weight: 800; text-transform: uppercase;
            border: 2px solid var(--md-sys-color-outline-variant); 
            background: var(--md-sys-color-surface); 
            color: var(--md-sys-color-on-surface-variant);
            transition: all 0.2s;
        }
        .lvl-btn.active { border-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); background: var(--md-sys-color-primary); }

        /* Wrapper Grafico */
        .graph-wrapper {
            width: 100%; max-width: 700px; aspect-ratio: 16/9;
            border-radius: 1rem; overflow: hidden;
            border: 2px solid var(--md-sys-color-outline-variant); position: relative; 
            background: var(--md-sys-color-surface-container); /* Placeholder prima del canvas */
        }
        @media (min-width: 1024px) { .graph-wrapper { aspect-ratio: 4/3; height: 100%; max-height: 400px; } }

        input:focus, button:focus { outline: none; box-shadow: 0 0 0 2px var(--md-sys-color-primary); }

        /* Streak Styles */
        .streak-bar-container { height: 6px; background: var(--md-sys-color-surface-container); border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .streak-bar { height: 100%; background: #fbbf24; width: 0%; transition: width 0.3s ease; }
        .fire-mode .streak-bar { background: linear-gradient(90deg, #f59e0b, #ef4444); box-shadow: 0 0 10px #f59e0b; }
        
        .avatar-select { 
            cursor: pointer; transition: all 0.2s; border: 2px solid transparent; 
            width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background-color: var(--md-sys-color-surface-container); font-size: 1.5rem;
        }
        .avatar-select:hover { transform: scale(1.1); background-color: var(--md-sys-color-outline-variant); }
        .avatar-select.selected { border-color: var(--md-sys-color-primary); background-color: var(--md-sys-color-surface); transform: scale(1.1); box-shadow: 0 0 15px rgba(0,0,0,0.1); }

        #fire-effect { transition: opacity 0.5s; opacity: 0; }
        #fire-effect.active { opacity: 1; }
    </style>

    <!-- Configurazione Tailwind con Colori Semantici -->
    <script>
        tailwind.config = {
            darkMode: ["class", "[data-theme="dark"]"],
            theme: {
                extend: {
                    colors: {
                        background: 'var(--md-sys-color-background)',
                        'on-background': 'var(--md-sys-color-on-background)',
                        surface: 'var(--md-sys-color-surface)',
                        'surface-container': 'var(--md-sys-color-surface-container)',
                        'on-surface-variant': 'var(--md-sys-color-on-surface-variant)',
                        'outline-variant': 'var(--md-sys-color-outline-variant)',
                        primary: 'var(--md-sys-color-primary)',
                        'on-primary': 'var(--md-sys-color-on-primary)',
                    }
                }
            }
        }
    </script>

</head>
<body>

    <!-- START SCREEN -->
    <div id="start-screen" class="absolute inset-0 z-50 bg-background flex flex-col items-center justify-center p-6 transition-opacity duration-500">
        <div class="glass-panel p-8 max-w-md w-full text-center space-y-6">
            <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">PARABOLA<br>CHALLENGE</h1>
            
            <div class="text-left bg-surface-container p-4 rounded-xl text-sm space-y-3 border border-outline-variant">
                <p class="text-on-surface-variant text-center font-bold uppercase tracking-widest text-xs mb-2">Seleziona Avatar</p>
                <div class="flex justify-center gap-3 mb-4">
                    <div class="avatar-select selected" onclick="selectAvatar(this, 'ü¶ä')">ü¶ä</div>
                    <div class="avatar-select" onclick="selectAvatar(this, 'üöÄ')">üöÄ</div>
                    <div class="avatar-select" onclick="selectAvatar(this, 'ü§ñ')">ü§ñ</div>
                    <div class="avatar-select" onclick="selectAvatar(this, 'üß†')">üß†</div>
                    <div class="avatar-select" onclick="selectAvatar(this, 'üëæ')">üëæ</div>
                </div>
                
                <div class="h-px bg-outline-variant my-2"></div>
                
                <div class="text-xs space-y-1 text-on-surface-variant">
                    <p><span class="text-green-400 font-bold">BASE:</span> Colori guida.</p>
                    <p><span class="text-yellow-400 font-bold">INTERMEDIO:</span> Griglia cartesiana.</p>
                    <p><span class="text-red-400 font-bold">PRO:</span> Input testuale libero.</p>
                </div>
            </div>

            <input type="text" id="player-name" placeholder="NOME GIOCATORE" class="w-full bg-surface border-2 border-outline-variant rounded-xl p-3 text-center font-bold text-on-background focus:border-cyan-500 outline-none uppercase tracking-widest placeholder-on-surface-variant">
            
            <div class="flex gap-2">
                <button class="lvl-btn active" onclick="selectLevel(1)">Base</button>
                <button class="lvl-btn" onclick="selectLevel(2)">Media</button>
                <button class="lvl-btn" onclick="selectLevel(3)">Pro</button>
            </div>

            <button onclick="startGame()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-black py-4 rounded-xl shadow-lg transition transform active:scale-95">START MISSION</button>
        </div>
    </div>

    <!-- GAME OVER SCREEN -->
    <div id="end-screen" class="hidden absolute inset-0 z-50 bg-background/95 flex flex-col items-center justify-center p-6 backdrop-blur-md">
        <div class="glass-panel p-8 max-w-md w-full text-center space-y-6 border-t-4 border-cyan-500">
            <div class="text-6xl animate-bounce" id="end-avatar">üèÜ</div>
            <h2 class="text-3xl font-black text-on-background">MISSIONE COMPIUTA</h2>
            
            <div class="grid grid-cols-2 gap-4 py-4">
                <div class="bg-surface p-3 rounded-lg border border-outline-variant">
                    <div class="text-xs text-on-surface-variant uppercase">Punteggio</div>
                    <div class="text-2xl font-bold text-cyan-400" id="final-score">0</div>
                </div>
                <div class="bg-surface p-3 rounded-lg border border-outline-variant">
                    <div class="text-xs text-on-surface-variant uppercase">Tempo Netto</div>
                    <div class="text-2xl font-mono text-on-background" id="final-time">00:00</div>
                </div>
            </div>

            <button onclick="location.reload()" class="w-full bg-surface-container hover:bg-outline-variant text-on-background font-bold py-3 rounded-xl transition border border-outline-variant">
                TORNA AL MENU
            </button>
        </div>
    </div>

    <!-- APP WRAPPER -->
    <div id="app-wrapper" class="hidden opacity-0 transition-opacity duration-500">
        
        <!-- SIDEBAR -->
        <div id="sidebar">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold text-on-background tracking-tight">STATUS</h2>
                <!-- Back button injected via JS, but keep exit as backup/alt -->
                <a href="../index.html" class="text-[10px] text-on-surface-variant hover:text-on-background border border-outline-variant px-2 py-1 rounded">ESCI</a>
            </div>
            
            <!-- Player Info -->
            <div class="bg-surface-container p-4 rounded-xl border border-outline-variant flex items-center gap-4">
                <div id="hud-avatar" class="w-12 h-12 rounded-full bg-gradient-to-tr from-cyan-500 to-blue-600 flex items-center justify-center text-2xl shadow-lg">ü¶ä</div>
                <div class="flex-1">
                    <div id="hud-name" class="text-sm font-bold text-on-background uppercase tracking-wide">Giocatore</div>
                    <div class="text-xs text-on-surface-variant" id="hud-level">Livello Base</div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 gap-2">
                <div class="bg-surface-container p-3 rounded-lg border border-outline-variant">
                    <div class="text-[10px] text-on-surface-variant uppercase font-bold">Score</div>
                    <div id="hud-score" class="text-xl font-black text-cyan-400">0</div>
                </div>
                <div class="bg-surface-container p-3 rounded-lg border border-outline-variant">
                    <div class="text-[10px] text-on-surface-variant uppercase font-bold">Record</div>
                    <div id="high-score" class="text-xl font-black text-amber-400">0</div>
                </div>
            </div>

            <!-- Streak Panel -->
            <div class="bg-surface-container p-3 rounded-lg border border-outline-variant transition-colors duration-300" id="streak-panel">
                <div class="flex justify-between items-end mb-1">
                    <div class="text-[10px] text-on-surface-variant uppercase font-bold">Streak (Serie)</div>
                    <div id="hud-streak-val" class="text-xs font-bold text-on-background">0</div>
                </div>
                <div class="streak-bar-container">
                    <div id="streak-bar" class="streak-bar"></div>
                </div>
                <div class="text-[9px] text-on-surface-variant mt-2 text-center italic" id="streak-msg">Raggiungi 3 per Fire Mode! üî•</div>
            </div>

            <!-- Time -->
             <div class="bg-surface-container p-3 rounded-lg border border-outline-variant text-center">
                <div class="text-[10px] text-on-surface-variant uppercase font-bold">Tempo Netto</div>
                <div id="hud-time" class="text-xl font-mono text-on-background tracking-widest">00:00</div>
            </div>
            
            <div class="flex-grow hidden lg:block relative">
                 <div class="absolute inset-0 bg-surface/50 rounded-lg border border-outline-variant p-3 overflow-y-auto font-mono text-[10px] text-on-surface-variant leading-relaxed" id="game-log">
                     <div>> Sistema pronto...</div>
                 </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div id="main-content">
            <div class="w-full max-w-4xl space-y-4 md:space-y-6">
                
                <!-- PROBLEMA -->
                <div class="glass-panel p-4 text-center border-l-4 border-l-cyan-500 relative overflow-hidden transition-colors duration-300" id="problem-panel">
                    <!-- Fire Effect Overlay -->
                    <div id="fire-effect" class="absolute inset-0 bg-gradient-to-r from-orange-500/0 via-orange-500/10 to-red-500/0 pointer-events-none"></div>
                    
                    <div id="problem-display" class="text-3xl md:text-5xl font-bold font-mono tracking-tight my-2 relative z-10 text-on-background"></div>
                    <div class="absolute top-2 right-2 text-[10px] text-on-surface-variant font-bold" id="question-counter">1/10</div>
                </div>

                <!-- GRAFICO -->
                <div class="flex justify-center">
                    <div class="graph-wrapper relative">
                        <div id="graph-container" class="absolute inset-0 w-full h-full"></div>
                        <!-- Feedback Message Overlay -->
                        <div id="feedback-overlay" class="absolute inset-0 z-10 flex items-center justify-center bg-background/80 backdrop-blur-sm hidden transition-opacity pointer-events-none">
                            <div id="feedback-msg" class="text-4xl font-black uppercase text-on-background transform scale-0 transition-transform duration-300"></div>
                        </div>
                    </div>
                </div>

                <!-- RISPOSTE -->
                <div id="answers-area" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                
                <!-- INPUT PRO (Lv 3) -->
                <div id="pro-input-area" class="hidden flex-col gap-3">
                    <div class="flex gap-2">
                        <input type="text" id="pro-answer-input" placeholder="Es: -3 < x < 2  oppure  x < -1 U x > 5" 
                               class="flex-1 bg-surface-container border-2 border-outline-variant rounded-xl p-4 text-lg font-mono text-on-background focus:border-cyan-500 outline-none uppercase placeholder-on-surface-variant" autocomplete="off">
                        <button onclick="checkProAnswer()" class="bg-cyan-600 hover:bg-cyan-500 text-on-primary font-bold px-6 rounded-xl shadow-lg transition active:scale-95">INVIA</button>
                    </div>
                    <p class="text-xs text-on-surface-variant text-center">Usa "U" o "or" per unire. "sempre" o "mai" per casi speciali.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GAME ENGINE ---
        const Game = {
            state: {
                level: 1,
                score: 0,
                streak: 0,
                startTime: 0,
                accumulatedTime: 0, // Tempo netto
                timerInterval: null,
                player: 'Guest',
                avatar: 'ü¶ä',
                currentQ: null,
                qCount: 0,
                maxQ: 10,
                history: new Set()
            },
            levels: {
                1: { name: 'BASE', mult: 1, color: '#4ade80' },
                2: { name: 'INTERMEDIO', mult: 1.5, color: '#facc15' },
                3: { name: 'PRO', mult: 2.5, color: '#f87171' }
            },

            init() {
                // Binding bottoni livello
                document.querySelectorAll('.lvl-btn').forEach((btn, idx) => {
                    btn.onclick = () => {
                        document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.state.level = idx + 1;
                    };
                });
                
                // Avatar Selection
                window.selectAvatar = (el, icon) => {
                    document.querySelectorAll('.avatar-select').forEach(a => a.classList.remove('selected', 'box-shadow'));
                    el.classList.add('selected');
                    this.state.avatar = icon;
                };

                // Enter key for Pro input
                document.getElementById('pro-answer-input').addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') checkProAnswer();
                });
                
                updateHighScoreDisplay();
            },

            start() {
                const nameInput = document.getElementById('player-name').value.trim();
                if(nameInput) this.state.player = nameInput;
                
                // UI Switch
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('app-wrapper').classList.remove('hidden');
                setTimeout(() => document.getElementById('app-wrapper').classList.remove('opacity-0'), 50);

                // Setup HUD
                document.getElementById('hud-name').innerText = this.state.player;
                document.getElementById('hud-avatar').innerText = this.state.avatar;
                document.getElementById('hud-level').innerText = this.levels[this.state.level].name;
                document.getElementById('hud-level').style.color = this.levels[this.state.level].color;

                this.state.history.clear();
                
                // Setup Input Mode
                if(this.state.level === 3) {
                    document.getElementById('answers-area').classList.add('hidden');
                    document.getElementById('pro-input-area').classList.remove('hidden');
                    document.getElementById('pro-input-area').classList.add('flex');
                } else {
                    document.getElementById('answers-area').classList.remove('hidden');
                    document.getElementById('pro-input-area').classList.add('hidden');
                    document.getElementById('pro-input-area').classList.remove('flex');
                }

                if(window.p5Sketch) window.p5Sketch.windowResized();
                this.nextQuestion();
                this.log(`Missione avviata. Livello ${this.state.level}.`);
            },

            startTimer() {
                if(this.state.timerInterval) clearInterval(this.state.timerInterval);
                this.state.startTime = Date.now();
                this.state.timerInterval = setInterval(() => {
                    const currentDelta = Math.floor((Date.now() - this.state.startTime) / 1000);
                    const total = this.state.accumulatedTime + currentDelta;
                    const hudTime = document.getElementById('hud-time');
                    if(hudTime) {
                        hudTime.innerText = 
                        `${Math.floor(total/60).toString().padStart(2,'0')}:${(total%60).toString().padStart(2,'0')}`;
                    }
                }, 1000);
            },

            stopTimer() {
                if(this.state.timerInterval) {
                    clearInterval(this.state.timerInterval);
                    this.state.accumulatedTime += Math.floor((Date.now() - this.state.startTime) / 1000);
                }
            },

            log(msg) {
                const div = document.createElement('div');
                div.innerText = `> ${msg}`;
                const log = document.getElementById('game-log');
                if(log) {
                    log.prepend(div);
                    if(log.children.length > 6) log.lastChild.remove();
                }
            },

            nextQuestion() {
                if(this.state.qCount >= this.state.maxQ) return this.endGame();
                
                this.startTimer(); // Riparte il timer netto
                
                this.state.qCount++;
                document.getElementById('feedback-overlay').classList.add('hidden');
                document.getElementById('question-counter').innerText = `${this.state.qCount}/${this.state.maxQ}`;
                
                // Pulisci input pro
                const proInput = document.getElementById('pro-answer-input');
                proInput.value = '';
                if(this.state.level === 3) proInput.focus();

                // Generazione Problema Unico
                let q, hash;
                let safety = 0;
                do {
                    q = this.generateProblem();
                    hash = `${q.a}_${q.b}_${q.c}_${q.op}`;
                    safety++;
                } while(this.state.history.has(hash) && safety < 20);
                
                this.state.history.add(hash);
                this.state.currentQ = q;
                
                this.renderProblemDOM(q);
                
                if(this.state.level < 3) this.renderAnswersDOM(q);
                
                if(window.p5Sketch) window.p5Sketch.update(q, this.state.level);
            },

            generateProblem() {
                const a = [-2, -1, 1, 2][Math.floor(Math.random()*4)];
                
                // 30% Delta Negativo (pi√π probabile in Pro)
                const isDeltaNeg = Math.random() < (this.state.level === 3 ? 0.4 : 0.2);

                if(isDeltaNeg) {
                    const vx = Math.floor(Math.random()*6)-3; 
                    const vy = (a>0) ? Math.floor(Math.random()*3)+2 : -(Math.floor(Math.random()*3)+2);
                    return {
                        a, b: -2*a*vx, c: a*vx*vx + vy,
                        type: 'imaginary', vx, vy,
                        op: ['>','<','‚â•','‚â§'][Math.floor(Math.random()*4)]
                    };
                } else {
                    let x1 = Math.floor(Math.random()*10)-5; 
                    let x2;
                    do { x2 = Math.floor(Math.random()*10)-5; } while(x2 === x1);
                    if(x1 > x2) [x1, x2] = [x2, x1];

                    return {
                        a, b: -a*(x1+x2), c: a*x1*x2,
                        type: 'real', x1, x2,
                        op: ['>','<','‚â•','‚â§'][Math.floor(Math.random()*4)]
                    };
                }
            },

            solveProblem(q) {
                const isPos = q.op.includes('>') || q.op.includes('‚â•');
                if(q.type === 'real') {
                    return (q.a > 0) === isPos ? 'external' : 'internal';
                } else {
                    return (q.a > 0) === isPos ? 'all_real' : 'never';
                }
            },

            // PARSER PRO
            checkProAnswer() {
                const input = document.getElementById('pro-answer-input').value.toLowerCase().replace(/\s/g, '');
                const q = this.state.currentQ;
                const type = this.solveProblem(q);
                let isCorrect = false;

                if (type === 'all_real') {
                    if(['sempre', 'perogni', 'tutti', 'reali', 'r', 'vxer', 'perognix'].some(k => input.includes(k))) isCorrect = true;
                } else if (type === 'never') {
                    if(['mai', 'impossibile', 'nessun', 'vuoto', 'insieme', 'nessuna'].some(k => input.includes(k))) isCorrect = true;
                } else if (type === 'internal') {
                    // Pattern: num < x < num
                    const regex = /(-?\d+)[<‚â§]x[<‚â§](-?\d+)/;
                    const match = input.match(regex);
                    if(match) {
                        const v1 = parseInt(match[1]);
                        const v2 = parseInt(match[2]);
                        if(Math.min(v1, v2) === q.x1 && Math.max(v1, v2) === q.x2) isCorrect = true;
                    }
                } else if (type === 'external') {
                    // Pattern: x < num U x > num
                    // Split flessibile
                    const parts = input.split(/or|vel|u|v|,|;/);
                    if(parts.length >= 2) {
                        const p1 = parts[0]; 
                        const p2 = parts[parts.length-1];
                        
                        const r1 = p1.match(/x[<‚â§](-?\d+)/) || p1.match(/(-?\d+)[>‚â•]x/);
                        const r2 = p2.match(/x[>‚â•](-?\d+)/) || p2.match(/(-?\d+)[<‚â§]x/);
                        
                        if(r1 && r2) {
                            if(parseInt(r1[1]) === q.x1 && parseInt(r2[1]) === q.x2) isCorrect = true;
                        }
                    }
                }
                
                this.triggerFeedback(isCorrect);
            },

            triggerFeedback(isCorrect, btnElement = null) {
                this.stopTimer(); // Ferma tempo netto

                const overlay = document.getElementById('feedback-overlay');
                const msg = document.getElementById('feedback-msg');
                const fireEffect = document.getElementById('fire-effect');
                
                if(overlay && msg) {
                    overlay.classList.remove('hidden');
                    msg.style.transform = 'scale(1)';
                    
                    if(isCorrect) {
                        // STREAK LOGIC
                        this.state.streak++;
                        const streakThreshold = 3;
                        
                        // Calcolo Punti
                        const basePoints = 100;
                        const levelMult = this.levels[this.state.level].mult;
                        const streakBonus = this.state.streak >= streakThreshold ? 1.5 : 1;
                        const points = Math.floor(basePoints * levelMult * streakBonus);
                        
                        this.state.score += points;
                        
                        if (this.state.streak >= streakThreshold) {
                            msg.innerText = "FIRE MODE! üî•";
                            msg.className = "text-5xl font-black text-amber-500 animate-pulse";
                            if(fireEffect) fireEffect.classList.add('active');
                            document.getElementById('streak-panel').classList.add('border-amber-500');
                        } else {
                            msg.innerText = "ECCELLENTE";
                            msg.className = "text-5xl font-black text-green-500 animate-bounce";
                        }
                        
                        if(btnElement) btnElement.classList.add('border-green-500', 'bg-green-900/30');
                        this.log(`Corretto! +${points}pt (Serie: ${this.state.streak})`);

                    } else {
                        // Reset Streak
                        this.state.streak = 0;
                        if(fireEffect) fireEffect.classList.remove('active');
                        document.getElementById('streak-panel').classList.remove('border-amber-500');

                        msg.innerText = "ERRORE";
                        msg.className = "text-5xl font-black text-red-500 shake-element";
                        if(btnElement) btnElement.classList.add('border-red-500', 'bg-red-900/30');
                        this.log("Errore. Serie azzerata.");
                    }
                }

                // Update HUD (safe check)
                const scoreEl = document.getElementById('hud-score');
                const streakVal = document.getElementById('hud-streak-val');
                const streakBar = document.getElementById('streak-bar');
                
                if(scoreEl) scoreEl.innerText = this.state.score;
                if(streakVal) streakVal.innerText = this.state.streak;
                if(streakBar) streakBar.style.width = Math.min(100, this.state.streak * 33) + '%'; // 3 step per 100%

                if(window.p5Sketch && typeof window.p5Sketch.reveal === 'function') {
                    window.p5Sketch.reveal(this.state.currentQ, isCorrect);
                }

                setTimeout(() => {
                    if(msg) msg.style.transform = 'scale(0)';
                    this.nextQuestion();
                }, 2000);
            },

            renderProblemDOM(q) {
                let s = (q.a==1?'':q.a==-1?'-':q.a) + 'x¬≤';
                if(q.b!=0) s += (q.b>0?'+':'-') + Math.abs(q.b) + 'x';
                if(q.c!=0) s += (q.c>0?'+':'-') + Math.abs(q.c);
                const col = (q.op.includes('>')) ? 'text-green-400' : 'text-rose-400';
                const opSafe = q.op.replace('>=','&ge;').replace('<=','&le;');
                document.getElementById('problem-display').innerHTML = `${s} <span class="${col}">${opSafe}</span> 0`;
            },

            renderAnswersDOM(q) {
                const c = document.getElementById('answers-area');
                c.innerHTML = '';
                q.correctType = this.solveProblem(q);

                const opts = [];
                const eq = q.op.includes('=') ? '=' : '';

                if(q.type === 'real') {
                    opts.push({ type: 'internal', t: `${q.x1} <${eq} x <${eq} ${q.x2}` });
                    opts.push({ type: 'external', t: `x <${eq} ${q.x1} ‚à® x >${eq} ${q.x2}` });
                    opts.push({ type: 'fake1', t: `x >${eq} ${q.x1}` }); 
                    opts.push({ type: 'fake2', t: `${-q.x2} <${eq} x <${eq} ${-q.x1}` });
                } else {
                    opts.push({ type: 'all_real', t: 'Per ogni x (‚àÄx)' });
                    opts.push({ type: 'never', t: 'Impossibile (‚àÑx)' });
                    opts.push({ type: 'fake1', t: `x > 0` });
                    opts.push({ type: 'fake2', t: `x < 0` });
                }

                opts.sort(()=>Math.random()-0.5);

                opts.forEach(o => {
                    const b = document.createElement('button');
                    b.className = "p-4 rounded-xl bg-surface-container border-2 border-outline-variant hover:border-cyan-500 text-left font-mono text-sm md:text-base text-on-background transition-all active:scale-95";
                    b.innerHTML = o.t;
                    b.onclick = () => this.triggerFeedback(o.type === q.correctType, b);
                    c.appendChild(b);
                });
            },

            endGame() {
                this.stopTimer();
                const finalTimeStr = document.getElementById('hud-time').innerText;
                
                // Save Highscore
                if(this.state.score > highScoreData.score) {
                    setHighScore({ name: this.state.player, score: this.state.score, time: this.state.accumulatedTime });
                    updateHighScoreDisplay();
                }

                document.getElementById('app-wrapper').classList.add('hidden');
                document.getElementById('end-screen').classList.remove('hidden');
                document.getElementById('end-avatar').innerText = this.state.avatar;
                document.getElementById('final-score').innerText = this.state.score;
                document.getElementById('final-time').innerText = finalTimeStr;
            }
        };

        // --- GLOBAL HELPERS ---
        // FIX: Highscore Handling
        let highScoreData = { name: 'Nessuno', score: 0, time: 999999 };
        function getHighScore() { 
            try {
                return JSON.parse(localStorage.getItem('pc_highscore')) || { name: 'Nessuno', score: 0, time: 999999 };
            } catch(e) { return { name: 'Nessuno', score: 0, time: 999999 }; }
        }
        function setHighScore(d) { localStorage.setItem('pc_highscore', JSON.stringify(d)); }
        function updateHighScoreDisplay() { 
            highScoreData = getHighScore(); 
            const el = document.getElementById('high-score');
            if(el) el.innerText = highScoreData.score; 
        }

        // Bridge Globali
        window.selectLevel = (l) => {
            document.querySelectorAll('.lvl-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.lvl-btn')[l-1].classList.add('active');
            Game.state.level = l;
        };
        window.startGame = () => Game.start();
        window.checkProAnswer = () => Game.checkProAnswer();
        window.checkAnswer = (t, b) => Game.triggerFeedback(t === Game.state.currentQ.correctType, b);
        window.selectAvatar = (el, icon) => {
             document.querySelectorAll('.avatar-select').forEach(a => a.classList.remove('selected', 'box-shadow'));
             el.classList.add('selected');
             Game.state.avatar = icon; 
        };
        window.Game = Game;

        Game.init();

        // --- P5.JS SKETCH ---
        const sketch = (p) => {
            let data = null;
            let level = 1;
            let revealed = false;
            let isCorrect = false;

            p.setup = () => {
                const c = document.getElementById('graph-container');
                const canvas = p.createCanvas(1, 1);
                canvas.parent('graph-container');
                p.noLoop();
            };

            p.windowResized = () => {
                 const container = document.getElementById('graph-container');
                 if(container) {
                    p.resizeCanvas(container.offsetWidth, container.offsetHeight);
                    p.redraw();
                 }
            };

            p.update = (d, l) => { data = d; level = l; revealed = false; p.redraw(); };
            p.reveal = (d, ok) => { revealed = true; isCorrect = ok; p.redraw(); };

            p.draw = () => {
                p.clear(); 
                
                if(!data) return;

                // Calcolo Viewport
                let vx, vy;
                if(data.type === 'real') { 
                    vx = (data.x1+data.x2)/2; 
                    vy = data.a*vx*vx + data.b*vx + data.c; 
                } else { 
                    vx = data.vx; vy = data.vy; 
                }
                
                const rangeX = 12; 
                const rangeY = Math.max(Math.abs(vy) + 10, 25);
                
                const mx = v => p.map(v, vx-rangeX, vx+rangeX, 0, p.width);
                const my = v => p.map(v, -rangeY, rangeY, p.height, 0);

                // --- LIVELLO 2+: GRIGLIA CARTESIANA PRECISA ---
                if(level >= 2 || revealed) {
                    p.stroke(100); p.strokeWeight(1);
                    
                    const startX = Math.floor(vx-rangeX);
                    const endX = Math.ceil(vx+rangeX);
                    for(let i=startX; i<=endX; i++) {
                        const x = mx(i);
                        p.line(x, 0, x, p.height);
                    }
                    
                    const startY = Math.floor(-rangeY/5)*5;
                    const endY = Math.ceil(rangeY/5)*5;
                    for(let i=startY; i<=endY; i+=5) {
                        const y = my(i);
                        p.line(0, y, p.width, y);
                    }

                    p.stroke(150); p.strokeWeight(2);
                    p.line(0, my(0), p.width, my(0)); // X
                    p.line(mx(0), 0, mx(0), p.height); // Y
                    
                    if(level === 2 && !revealed) {
                        p.fill(150); p.noStroke(); p.textSize(10); p.textAlign(p.CENTER, p.TOP);
                        for(let i=startX; i<=endX; i+=1) { 
                            if(i !== 0 && Math.abs(i) % 2 === 0) p.text(i, mx(i), my(0)+4);
                        }
                    }
                } else {
                    p.stroke(150); p.strokeWeight(2);
                    p.line(0, my(0), p.width, my(0));
                }

                // --- PARABOLA ---
                p.noFill(); p.strokeWeight(3);
                
                if (level === 1) {
                    const step = 0.1;
                    for (let x = vx-rangeX; x <= vx+rangeX; x+=step) {
                        const y1 = data.a*x*x + data.b*x + data.c;
                        const y2 = data.a*(x+step)**2 + data.b*(x+step) + data.c;
                        p.stroke(y1 >= 0 ? [74, 222, 128] : [248, 113, 113]);
                        p.line(mx(x), my(y1), mx(x+step), my(y2));
                    }
                } else {
                    p.stroke(200);
                    p.beginShape();
                    for(let x = vx-rangeX; x <= vx+rangeX; x+=0.1) {
                        p.vertex(mx(x), my(data.a*x*x + data.b*x + data.c));
                    }
                    p.endShape();
                }

                // --- PUNTI NOTEVOLI ---
                if (data.type === 'real' && (level < 3 || revealed)) {
                    p.noStroke(); p.fill(255, 255, 0);
                    p.circle(mx(data.x1), my(0), 8);
                    p.circle(mx(data.x2), my(0), 8);
                    
                    if(level === 1) {
                        p.fill(255); p.textAlign(p.CENTER, p.TOP); p.textSize(12);
                        p.text(data.x1, mx(data.x1), my(0)+12);
                        p.text(data.x2, mx(data.x2), my(0)+12);
                    }
                }

                // --- SOLUZIONE ---
                if (revealed) {
                    p.noStroke();
                    const c = isCorrect ? p.color(34, 197, 94, 80) : p.color(239, 68, 68, 80);
                    p.fill(c);

                    if (data.correctType === 'internal') {
                        p.rect(mx(data.x1), 0, mx(data.x2)-mx(data.x1), p.height);
                    } else if (data.correctType === 'external') {
                        p.rect(0, 0, mx(data.x1), p.height);
                        p.rect(mx(data.x2), 0, p.width-mx(data.x2), p.height);
                    } else if (data.correctType === 'all_real') {
                        p.rect(0,0,p.width,p.height);
                    }
                }
            };
        };

        window.p5Sketch = new p5(sketch);
    </script>
</body>
</html>