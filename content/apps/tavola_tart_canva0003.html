<!doctype html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    
    <!-- 1. META DATI PER CATALOGAZIONE -->
    <title>Esploratore Numerico: Pitagora & Tartaglia</title>
    <!-- Shared Orfini Design System -->
    <link rel="stylesheet" href="../assets/style/orfini-shared.css">
    <script src="../assets/js/orfini-shared.js"></script>

    <meta name="description" content="Laboratorio interattivo per scoprire i pattern dei numeri: Tavola Pitagorica (Primi, Quadrati), Triangolo di Tartaglia (Combinatoria) e regole di divisibilit√†.">
    <meta name="keywords" content="Matematica, Aritmetica, Numeri, Pitagora, Tartaglia, Divisibilit√†, 1EL, 2EL, 4EL, Mat:Calcolo, Mat:Modellizzazione, Mat:Dati, Lab">
    <meta name="date" content="2025-12-08">

    <!-- 2. FIX MOBILE -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Caricamento di Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* =========================================
           SISTEMA TEMI E VARIABILI (CSS VARS)
           ========================================= */
        :root {
            /* TEMA SCURO (Default) */
            --bg-body: #0f172a;      /* slate-950 */
            --bg-card: #1e293b;      /* slate-800 */
            --bg-inner: #334155;     /* slate-700 */
            --border-color: #475569; /* slate-600 */
            
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --text-accent: #facc15;  /* yellow-400 */
            
            --input-bg: #020617;
            --input-border: #475569;
            --input-text: #f1f5f9;

            --highlight-hover: #475569;
            --grid-border: #334155;

            /* Dimensioni Dinamiche */
            --cell-size: 2.5rem;  
            --font-size: 0.85rem; 
            --pascal-cell-size: 2.2rem;
            --pascal-font-size: 0.75rem;
        }

        /* TEMA CHIARO (Override) */
        body.light {
            --bg-body: #f8fafc;      /* slate-50 */
            --bg-card: #ffffff;      /* white */
            --bg-inner: #f1f5f9;     /* slate-100 */
            --border-color: #cbd5e1; /* slate-300 */
            
            --text-primary: #0f172a; /* slate-900 */
            --text-secondary: #64748b; /* slate-500 */
            --text-accent: #d97706;  /* amber-600 */
            
            --input-bg: #ffffff;
            --input-border: #cbd5e1;
            --input-text: #0f172a;

            --highlight-hover: #e2e8f0;
            --grid-border: #e2e8f0;
        }

        html, body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            width: 100vw;
            min-height: 100dvh; /* Altezza dinamica mobile */
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        /* Utility Classes mappate sulle variabili */
        .themed-bg-card { background-color: var(--bg-card); }
        .themed-bg-inner { background-color: var(--bg-inner); }
        .themed-border { border-color: var(--border-color); }
        .themed-text-primary { color: var(--text-primary); }
        .themed-text-secondary { color: var(--text-secondary); }
        .themed-text-accent { color: var(--text-accent); }

        /* Inputs */
        input[type="number"], input[type="text"] {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--input-text);
            transition: border-color 0.2s;
        }
        input:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.2);
        }

        /* =========================================
           STILI GRIGLIE E LABORATORIO
           ========================================= */
        
        /* Pitagora Grid */
        .number-grid { 
            border-collapse: separate; 
            border-spacing: 2px;
            margin: 0 auto;
        }
        .number-grid th,
        .number-grid td {
            border: 1px solid var(--grid-border);
            width: var(--cell-size);
            min-width: 36px; /* Minimo touch target */
            height: var(--cell-size);
            font-size: var(--font-size);
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            position: relative;
            border-radius: 4px;
            color: var(--text-primary);
            background-color: var(--bg-card);
            user-select: none;
        }
        
        .number-grid td:hover, .number-grid th:hover { background-color: var(--highlight-hover) !important; z-index: 2; }
        .corner { background-color: var(--bg-inner) !important; cursor: default; }
        .header { background-color: var(--bg-inner); font-weight: 700; }

        /* Classi Logiche */
        .highlight-prime { background-color: #be123c !important; color: white !important; border-color: #fda4af; }
        .highlight-square { background-color: #7c3aed !important; color: white !important; border-color: #c4b5fd; }
        .highlight-cube { background-color: #2563eb !important; color: white !important; border-color: #93c5fd; }
        
        .selected { 
            background-color: var(--text-accent) !important; 
            color: #0f172a !important; font-weight: 800; 
            transform: scale(1.15); z-index: 10; 
            box-shadow: 0 4px 15px rgba(0,0,0, 0.3); 
            border: 2px solid white;
        }
        .highlight-factor { background-color: #15803d !important; color: white !important; }

        /* Toggle Buttons */
        .toggle-label { 
            display: flex; align-items: center; cursor: pointer; 
            padding: 0.5rem 0.75rem; border-radius: 0.5rem; 
            border: 2px solid transparent; 
            background-color: var(--bg-inner);
            color: var(--text-primary);
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
            user-select: none; transition: transform 0.1s;
        }
        .toggle-label:active { transform: scale(0.98); }
        .toggle-label input { display: none; }
        
        .toggle-label[data-type="prime"] { border-color: #be123c; }
        .toggle-label[data-type="square"] { border-color: #7c3aed; }
        .toggle-label[data-type="cube"] { border-color: #2563eb; }
        
        .toggle-label.active { color: #0f172a; }
        .toggle-label[data-type="prime"].active { background-color: #fda4af; }
        .toggle-label[data-type="square"].active { background-color: #c4b5fd; }
        .toggle-label[data-type="cube"].active { background-color: #93c5fd; }

        .multiple-toggle { font-family: monospace; font-weight: 700; border-width: 2px; }
        .multiple-toggle.active { color: #0f172a !important; }

        /* Pascal Triangle Styles */
        #pascal-wrapper { 
            position: relative; width: 100%; 
            overflow: auto; 
            -webkit-overflow-scrolling: touch;
            min-height: 450px;
        }
        
        #pascalTriangleContainer { 
            display: flex; flex-direction: column; align-items: center; 
            width: max-content; margin: 0 auto; padding: 2rem 4rem; /* Padding laterale per wrappers */
        }
        
        .pascal-row { display: flex; justify-content: center; align-items: center; margin-bottom: 4px; }
        
        .pascal-cell-square {
            display: inline-flex; align-items: center; justify-content: center;
            width: var(--pascal-cell-size); height: var(--pascal-cell-size); 
            font-size: var(--pascal-font-size);
            margin: 2px; 
            background-color: var(--bg-inner); color: var(--text-secondary);
            font-family: monospace; font-weight: bold;
            cursor: pointer; border: 1px solid var(--border-color);
            border-radius: 6px; flex-shrink: 0; user-select: none;
        }

        /* Wrappers laterali assoluti */
        #pascal-sum-wrapper, #pascal-fib-sum-wrapper, #pascal-pow11-wrapper {
            position: absolute; top: 2rem; display: flex; flex-direction: column; gap: 6px; z-index: 10; pointer-events: none;
        }
        #pascal-sum-wrapper { right: 1rem; align-items: flex-start; }
        #pascal-fib-sum-wrapper { left: 1rem; align-items: flex-end; }
        #pascal-pow11-wrapper { left: 1rem; align-items: flex-end; }

        .pascal-info-square {
            display: inline-flex; align-items: center; justify-content: center;
            height: var(--pascal-cell-size); font-size: 0.7rem;
            font-weight: 700; font-family: monospace; 
            border-radius: 4px; flex-shrink: 0; padding: 0 0.5rem;
            margin-bottom: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .bg-pow2 { background-color: #422006; color: #fde047; border: 1px solid #ca8a04; }
        .bg-fib { background-color: #4a2c0d; color: #fdba74; border: 1px solid #f97316; }
        .bg-pow11 { background-color: #400a45; color: #f0abfc; border: 1px solid #c026d3; }
        
        .highlight-odd { background-color: #4f46e5 !important; color: white !important; }
        .highlight-even { background-color: #312e81 !important; color: #a5b4fc !important; }
        
        .highlight-hockey-stick { background-color: #047857 !important; color: white !important; transform: scale(1.05); z-index: 5; }
        .highlight-hockey-puck { background-color: #a3e635 !important; color: #0f172a !important; font-weight: 800; transform: scale(1.2); z-index: 15; border: 2px solid white; }

        body.light .highlight-even { background-color: #e0e7ff !important; color: #312e81 !important; }
        
        /* Switch Tema */
        .theme-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .theme-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-inner); border: 1px solid var(--border-color);
            transition: .3s; border-radius: 24px;
        }
        .theme-slider:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 2px; bottom: 2px; background-color: var(--text-secondary);
            transition: .3s; border-radius: 50%;
        }
        input:checked + .theme-slider:before { transform: translateX(20px); background-color: var(--text-accent); }

        /* Tabs */
        .tab-btn {
            padding: 1rem 1.2rem; color: var(--text-secondary);
            border-bottom: 3px solid transparent; font-weight: 600; font-size: 0.9rem;
            transition: all 0.2s; white-space: nowrap;
        }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active { color: var(--text-accent); border-bottom-color: var(--text-accent); }
        
        /* Content Sections */
        .content-section { display: none; animation: fadeIn 0.4s ease; padding-bottom: 80px; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Scrollbar nascosta per menu orizzontale */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <!-- Configurazione Tailwind con Colori Semantici -->
    <script>
        tailwind.config = {
            darkMode: ["class", "[data-theme="dark"]"],
            theme: {
                extend: {
                    colors: {
                        background: 'var(--md-sys-color-background)',
                        'on-background': 'var(--md-sys-color-on-background)',
                        surface: 'var(--md-sys-color-surface)',
                        'surface-container': 'var(--md-sys-color-surface-container)',
                        'on-surface-variant': 'var(--md-sys-color-on-surface-variant)',
                        'outline-variant': 'var(--md-sys-color-outline-variant)',
                        primary: 'var(--md-sys-color-primary)',
                        'on-primary': 'var(--md-sys-color-on-primary)',
                    }
                }
            }
        }
    </script>

</head>
<body>

    <div class="container mx-auto min-h-screen flex flex-col">
        
        <!-- Header -->
        <div class="themed-bg-card shadow-lg sticky top-0 z-50 border-b themed-border px-4 py-3 flex justify-between items-center backdrop-blur-md bg-opacity-95">
            <div>
                <h1 class="text-xl md:text-2xl font-black tracking-tight themed-text-accent">Esploratore Numerico</h1>
                <p class="text-xs md:text-sm themed-text-secondary">Laboratorio Matematico 1EL-2EL</p>
            </div>
            <div class="flex items-center gap-3 bg-white/5 p-1.5 rounded-full border border-white/10">
                <span class="text-xs opacity-60">üåô</span>
                <label class="theme-switch">
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                    <span class="theme-slider"></span>
                </label>
                <span class="text-xs opacity-60">‚òÄÔ∏è</span>
            </div>
        </div>

        <!-- Navigation Tabs (Scrollable on Mobile) -->
        <div class="themed-bg-card border-b themed-border sticky top-[65px] z-40 flex overflow-x-auto no-scrollbar shadow-sm">
            <button class="tab-btn active" onclick="showSection('multiplication', event)">Tavola Pitagorica</button>
            <button class="tab-btn" onclick="showSection('pascal', event)">Triangolo Tartaglia</button>
            <button class="tab-btn" onclick="showSection('divisibility', event)">Divisibilit√†</button>
            <button class="tab-btn" onclick="showSection('quiz', event)">Quiz</button>
            <button class="tab-btn" onclick="showSection('matching', event)">Abbinamenti</button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-grow p-4 md:p-6">

            <!-- SEZIONE 1: TAVOLA PITAGORICA -->
            <div id="multiplication" class="content-section active">
                <div class="flex flex-col lg:flex-row gap-6 items-start">
                    
                    <!-- Sidebar Controlli (Mobile First: Collapsible or Top) -->
                    <div class="w-full lg:w-72 flex-none space-y-4">
                        <div class="themed-bg-card p-4 rounded-xl shadow border themed-border">
                            <h3 class="font-bold text-xs uppercase themed-text-secondary mb-3 tracking-wider">Configurazione</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="number" id="gridSize" value="10" min="5" max="30" class="w-full p-2 rounded text-center font-bold font-mono">
                                <button id="generateGridBtn" class="bg-yellow-500 hover:bg-yellow-400 text-on-background font-bold px-4 rounded transition shadow-lg">VAI</button>
                            </div>
                            
                            <div class="space-y-2">
                                <label id="togglePrimes" class="toggle-label" data-type="prime"><input type="checkbox"><span>Numeri Primi</span></label>
                                <label id="toggleSquares" class="toggle-label" data-type="square"><input type="checkbox"><span>Quadrati Perfetti</span></label>
                                <label id="toggleCubes" class="toggle-label" data-type="cube"><input type="checkbox"><span>Cubi Perfetti</span></label>
                            </div>
                        </div>

                        <div class="themed-bg-card p-4 rounded-xl shadow border themed-border">
                            <h3 class="font-bold text-xs uppercase themed-text-secondary mb-3 tracking-wider">Filtro Multipli</h3>
                            <div class="flex gap-4 mb-3 text-xs font-bold">
                                <label class="flex items-center gap-1 cursor-pointer themed-text-primary"><input type="radio" name="filterLogic_py" value="AND" checked class="accent-yellow-500"> AND (Tutti)</label>
                                <label class="flex items-center gap-1 cursor-pointer themed-text-primary"><input type="radio" name="filterLogic_py" value="OR" class="accent-yellow-500"> OR (Almeno uno)</label>
                            </div>
                            <div id="multiple-toggles-container-pythagoras" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>

                    <!-- Area Griglia -->
                    <div class="flex-1 w-full overflow-hidden" id="grid-wrapper">
                        <div class="themed-bg-card p-2 md:p-4 rounded-xl shadow border themed-border overflow-auto relative" style="max-height: 80vh;">
                            <table id="numberGrid" class="number-grid"></table>
                        </div>
                    </div>

                    <!-- Inspector -->
                    <div class="w-full lg:w-72 flex-none">
                        <div class="themed-bg-card p-5 rounded-xl shadow border themed-border lg:sticky lg:top-24">
                            <h3 class="text-lg font-bold themed-text-accent mb-4 border-b themed-border pb-2">Analisi Numero</h3>
                            <div id="inspectorContent" class="space-y-4 min-h-[150px]">
                                <p class="themed-text-secondary text-center text-sm italic py-8 opacity-60">Seleziona una cella per analizzarla.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEZIONE 2: PASCAL -->
            <div id="pascal" class="content-section">
                <div class="flex flex-col lg:flex-row gap-6 items-start">
                    
                    <div class="w-full lg:w-72 flex-none space-y-4">
                        <div class="themed-bg-card p-4 rounded-xl shadow border themed-border">
                            <h3 class="font-bold text-xs uppercase themed-text-secondary mb-3 tracking-wider">Righe</h3>
                            <div class="flex gap-2">
                                <input type="number" id="pascalRows" value="10" min="3" max="25" class="w-full p-2 rounded text-center font-bold font-mono">
                                <button id="generatePascalBtn" class="bg-yellow-500 hover:bg-yellow-400 text-on-background font-bold px-4 rounded transition shadow-lg">VAI</button>
                            </div>
                        </div>
                        <div class="themed-bg-card p-4 rounded-xl shadow border themed-border">
                            <h3 class="font-bold text-xs uppercase themed-text-secondary mb-3 tracking-wider">Visualizza</h3>
                            <div class="space-y-2">
                                <label id="togglePascalOddEven" class="toggle-label" data-type="odd-even"><input type="checkbox"><span>Pari/Dispari</span></label>
                                <label id="togglePascalPow2" class="toggle-label" data-type="pow2"><input type="checkbox"><span>Somma Righe (2‚Åø)</span></label>
                                <label id="togglePascalFibonacci" class="toggle-label" data-type="fibonacci"><input type="checkbox"><span>Fibonacci</span></label>
                                <label id="togglePascalPow11" class="toggle-label" data-type="pow11"><input type="checkbox"><span>Potenze di 11</span></label>
                            </div>
                        </div>
                         <div class="themed-bg-card p-4 rounded-xl shadow border themed-border">
                            <h3 class="font-bold text-xs uppercase themed-text-secondary mb-3 tracking-wider">Diagonali</h3>
                            <div class="flex flex-wrap gap-2">
                                <label id="togglePascalNatural" class="toggle-label" data-type="natural"><input type="checkbox"><span>Naturali</span></label>
                                <label id="togglePascalTriangular" class="toggle-label" data-type="triangular"><input type="checkbox"><span>Triangolari</span></label>
                                <label id="togglePascalTetrahedral" class="toggle-label" data-type="tetrahedral"><input type="checkbox"><span>Tetraedrici</span></label>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 w-full overflow-hidden relative" id="pascal-wrapper">
                        <div class="themed-bg-card p-4 rounded-xl shadow border themed-border overflow-auto relative min-h-[500px]">
                            <div id="pascalTriangleContainer"></div>
                            <div id="pascal-fib-sum-wrapper"></div>
                            <div id="pascal-pow11-wrapper"></div>
                            <div id="pascal-sum-wrapper"></div>
                        </div>
                    </div>

                    <div class="w-full lg:w-72 flex-none">
                        <div class="themed-bg-card p-5 rounded-xl shadow border themed-border lg:sticky lg:top-24">
                            <h3 class="text-lg font-bold themed-text-accent mb-4 border-b themed-border pb-2">Analisi Combinatoria</h3>
                            <div id="pascalInspectorContent" class="space-y-4 min-h-[150px]">
                                <p class="themed-text-secondary text-center text-sm italic py-8 opacity-60">Clicca su una cella per i dettagli.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEZIONE 3: DIVISIBILIT√Ä -->
            <div id="divisibility" class="content-section">
                <div class="max-w-4xl mx-auto">
                    <div class="themed-bg-card p-8 rounded-2xl shadow-xl border themed-border mb-8 text-center">
                        <h2 class="text-2xl font-bold mb-6 themed-text-accent">Macchina della Divisibilit√†</h2>
                        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                            <input type="number" id="numberCheck" placeholder="Inserisci numero..." class="text-3xl p-4 rounded-xl w-full sm:w-64 text-center font-bold border-2 border-transparent focus:border-yellow-400 shadow-inner">
                            <button class="bg-yellow-500 hover:bg-yellow-400 text-on-background font-bold text-lg px-8 py-4 rounded-xl shadow-lg transition transform hover:scale-105 active:scale-95 w-full sm:w-auto" onclick="checkDivisibility()">ANALIZZA</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4" id="divisibilityResults"></div>
                </div>
            </div>

            <!-- SEZIONE 4: QUIZ -->
            <div id="quiz" class="content-section">
                <div class="max-w-3xl mx-auto">
                    <div class="themed-bg-card p-6 md:p-10 rounded-2xl shadow-xl border themed-border">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-2xl font-bold themed-text-accent" id="quizTitle">Quiz di Teoria</h2>
                            <span class="bg-indigo-600 text-on-background px-4 py-2 rounded-lg font-mono font-bold shadow-lg" id="quizScore">0/0</span>
                        </div>
                        
                        <div class="min-h-[100px] flex items-center justify-center mb-8 bg-black/20 p-6 rounded-xl border themed-border">
                            <h3 id="quizQuestion" class="text-lg md:text-xl font-medium text-center themed-text-primary leading-relaxed">Caricamento...</h3>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3 mb-8" id="quizOptions"></div>
                        
                        <div class="text-center h-14">
                             <button id="nextQuizBtn" class="hidden mx-auto bg-blue-600 hover:bg-blue-500 text-on-background font-bold px-8 py-3 rounded-full transition shadow-lg transform hover:scale-105" onclick="nextQuizQuestion()">Prossima Domanda ‚ûú</button>
                        </div>
                        <div id="quizFeedback" class="mt-2 text-center text-lg font-bold min-h-[30px]"></div>
                    </div>
                </div>
            </div>

            <!-- SEZIONE 5: ABBINAMENTI -->
            <div id="matching" class="content-section">
                 <div class="max-w-5xl mx-auto">
                    <div class="themed-bg-card p-6 md:p-8 rounded-2xl shadow-xl border themed-border">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl md:text-2xl font-bold themed-text-accent">Collega Regole e Divisori</h2>
                            <div class="themed-bg-inner px-4 py-2 rounded-lg font-bold themed-text-primary border themed-border">Punti: <span id="matchScore" class="text-yellow-400">0</span>/7</div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-12">
                            <div class="themed-bg-inner p-4 rounded-xl border themed-border">
                                <h3 class="text-center font-bold mb-4 themed-text-secondary uppercase text-xs tracking-widest">Seleziona Divisore</h3>
                                <div id="divisorsColumn" class="space-y-3"></div>
                            </div>
                            <div class="themed-bg-inner p-4 rounded-xl border themed-border">
                                <h3 class="text-center font-bold mb-4 themed-text-secondary uppercase text-xs tracking-widest">Seleziona Regola</h3>
                                <div id="rulesColumn" class="space-y-3"></div>
                            </div>
                        </div>
                        
                        <div class="flex flex-col items-center mt-8 gap-4">
                            <div id="matchingFeedback" class="text-center h-8 font-bold text-lg"></div>
                            <button class="text-sm text-gray-500 hover:text-white underline" onclick="resetMatching()">Riavvia Partita</button>
                        </div>
                    </div>
                 </div>
            </div>

        </div>
    </div>

    <script>
        // ... (LOGICA JAVASCRIPT INVARIATA - MANTENUTA DAL PRECEDENTE) ...
        // Incollo qui la logica JS per completezza, identica a quella funzionante ma incapsulata
        
        let currentGridSize = 10;
        let currentPascalRows = 10;
        let currentQuizQuestion = 0;
        let quizScore = 0;
        let shuffledQuestions = [];
        let selectedDivisor = null;
        let selectedRule = null;
        let matchScore = 0;

        const quizQuestions = [
            { question: "Un numero √® divisibile per 2 se:", options: ["√à pari", "√à dispari", "Finisce per 5", "√à maggiore di 10"], correct: 0 },
            { question: "Un numero √® divisibile per 3 se:", options: ["Finisce per 3", "La somma delle cifre √® divisibile per 3", "√à multiplo di 6", "Ha 3 cifre"], correct: 1 },
            { question: "Un numero √® divisibile per 5 se:", options: ["√à multiplo di 10", "Finisce per 0 o 5", "√à maggiore di 5", "Ha 5 cifre"], correct: 1 },
            { question: "Un numero √® divisibile per 4 se:", options: ["Finisce per 4", "√à pari", "Le ultime due cifre formano un numero divisibile per 4", "√à multiplo di 2"], correct: 2 },
            { question: "Un numero √® divisibile per 9 se:", options: ["Finisce per 9", "√à multiplo di 3", "La somma delle cifre √® divisibile per 9", "Ha 9 cifre"], correct: 2 },
            { question: "Un numero √® divisibile per 6 se:", options: ["√à divisibile per 2 e per 3", "Finisce per 6", "√à maggiore di 6", "√à multiplo di 12"], correct: 0 },
            { question: "Un numero √® divisibile per 10 se:", options: ["√à pari", "√à multiplo di 5", "Finisce per 0", "Ha almeno 2 cifre"], correct: 2 },
            { question: "Il numero 144 √® divisibile per:", options: ["2, 3, 4", "2, 3, 4, 6, 8, 9", "Solo 2 e 4", "Tutti i numeri da 1 a 9"], correct: 1 },
            { question: "Un numero √® divisibile per 8 se:", options: ["√à pari", "Le ultime tre cifre formano un numero divisibile per 8", "√à multiplo di 4", "Finisce per 8"], correct: 1 },
            { question: "Il numero 1001 √® divisibile per:", options: ["7, 11, 13", "Solo numeri primi", "3, 7, 11", "Nessun numero oltre 1"], correct: 0 }
        ];

        const matchingPairs = {
            "2": "Il numero √® pari",
            "3": "Somma cifre divisibile per 3",
            "4": "Ultime 2 cifre divisibili per 4",
            "5": "Finisce per 0 o 5",
            "6": "Divisibile per 2 e 3",
            "9": "Somma cifre divisibile per 9",
            "10": "Finisce per 0"
        };

        const BASE_COLORS = { 2:[220,38,38], 3:[22,163,74], 5:[37,99,235], 7:[202,138,4], 11:[8,145,178], 13:[192,38,211], 17:[234,88,12], 19:[147,51,234] };
        const MULTIPLE_BASES = Object.keys(BASE_COLORS).map(Number);
        const memoPrime = new Map();

        function isPrime(n) { if(n<=1)return false; if(n<=3)return true; if(memoPrime.has(n))return memoPrime.get(n); if(n%2===0||n%3===0){memoPrime.set(n,false);return false;} for(let i=5;i*i<=n;i+=6)if(n%i===0||n%(i+2)===0){memoPrime.set(n,false);return false;} memoPrime.set(n,true);return true; }
        function isSquare(n){return n>0&&Math.sqrt(n)%1===0;}
        function isCube(n){return n>0&&Math.cbrt(n)%1===0;}
        function getDivisors(n){let a=[];for(let i=1;i*i<=n;i++){if(n%i===0){a.push(i);if(i*i!==n)a.push(n/i);}}return a.sort((x,y)=>x-y);}
        function getPrimeFactorization(n){if(n<=1)return"";let t=n,f={};for(let i=2;i*i<=t;i++){while(t%i===0){f[i]=(f[i]||0)+1;t/=i;}}if(t>1)f[t]=(f[t]||0)+1;return Object.entries(f).map(([b,e])=>e>1?`${b}<sup>${e}</sup>`:b).join(' √ó ');}

        function toggleTheme(){document.body.classList.toggle('light');localStorage.setItem('theme',document.body.classList.contains('light')?'light':'dark'); if(document.getElementById('multiplication').classList.contains('active'))applyGlobalHighlightsPythagoras(); if(document.getElementById('pascal').classList.contains('active'))applyGlobalHighlightsPascal();}
        function loadTheme(){if(localStorage.getItem('theme')==='light'){document.body.classList.add('light');document.getElementById('themeToggle').checked=true;}else{document.body.classList.remove('light');document.getElementById('themeToggle').checked=false;}}
        
        function showSection(id,e){document.querySelectorAll('.content-section').forEach(el=>el.classList.remove('active'));document.getElementById(id).classList.add('active');document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));if(e)e.target.classList.add('active');if(id==='multiplication'||id==='pascal')setTimeout(updateSizingCSS,50);}
        
        function updateSizingCSS(){
            const r=document.documentElement;
            const gw=document.getElementById('grid-wrapper');
            if(gw&&gw.offsetParent){let s=Math.floor((gw.clientWidth-32)/(currentGridSize+1));s=Math.max(24,Math.min(s,60));r.style.setProperty('--cell-size',`${s}px`);r.style.setProperty('--font-size',`${Math.max(10,s*0.35)}px`);}
            const pw=document.getElementById('pascal-wrapper');
            if(pw&&pw.offsetParent){let s=Math.floor((pw.clientWidth-80)/(currentPascalRows+1));s=Math.max(20,Math.min(s,50));r.style.setProperty('--pascal-cell-size',`${s}px`);r.style.setProperty('--pascal-font-size',`${Math.max(10,s*0.35)}px`);}
        }

        function generateGrid(N){currentGridSize=N;const c=document.getElementById('numberGrid');c.innerHTML='';memoPrime.clear();updateSizingCSS();const trH=document.createElement('tr');trH.innerHTML='<th class="corner">√ó</th>';for(let i=1;i<=N;i++)trH.innerHTML+=`<th class="header col-header" data-n="${i}" onclick="selectHeader(${i},'col')">${i}</th>`;c.appendChild(trH);for(let r=1;r<=N;r++){const tr=document.createElement('tr');let h=`<th class="header row-header" data-n="${r}" onclick="selectHeader(${r},'row')">${r}</th>`;for(let co=1;co<=N;co++){const v=r*co;let cl=[];if(isPrime(v))cl.push('prime');if(isSquare(v))cl.push('square');if(isCube(v))cl.push('cube');h+=`<td class="${cl.join(' ')}" data-val="${v}" data-r="${r}" data-c="${co}" onclick="selectCell(this,${v},${r},${co})">${v}</td>`;}tr.innerHTML=h;c.appendChild(tr);}applyGlobalHighlightsPythagoras();}
        function selectCell(el,v,r,c){document.querySelectorAll('.selected,.highlight-factor').forEach(e=>e.classList.remove('selected','highlight-factor'));el.classList.add('selected');document.querySelector(`.row-header[data-n="${r}"]`).classList.add('highlight-factor');document.querySelector(`.col-header[data-n="${c}"]`).classList.add('highlight-factor');updateInspector(v,`${r} √ó ${c}`);}
        function selectHeader(n,t){document.querySelectorAll('.selected,.highlight-factor').forEach(e=>e.classList.remove('selected','highlight-factor'));const h=document.querySelector(`.${t}-header[data-n="${n}"]`);if(h)h.classList.add('selected');const sel=t==='row'?`td[data-r="${n}"]`:`td[data-c="${n}"]`;document.querySelectorAll(sel).forEach(td=>td.classList.add('highlight-factor'));updateInspector(n);}
        function updateInspector(n,l=null){document.getElementById('inspectorContent').innerHTML=`<div class="text-center"><div class="text-5xl font-bold mb-2 themed-text-accent">${n}</div>${l?`<div class="text-sm themed-text-secondary">${l}</div>`:''}</div><div class="grid grid-cols-2 gap-2 text-sm mt-4"><div class="themed-bg-inner p-2 rounded">Primo: <b>${isPrime(n)?'S√å':'NO'}</b></div><div class="themed-bg-inner p-2 rounded">Quadrato: <b>${isSquare(n)?'S√å':'NO'}</b></div><div class="themed-bg-inner p-2 rounded">Cubo: <b>${isCube(n)?'S√å':'NO'}</b></div></div><div class="mt-4"><div class="text-xs themed-text-secondary uppercase font-bold">Fattorizzazione</div><div class="font-mono text-lg">${getPrimeFactorization(n)}</div></div><div class="mt-4"><div class="text-xs themed-text-secondary uppercase font-bold">Divisori</div><div class="flex flex-wrap gap-1 mt-1">${getDivisors(n).map(d=>`<span class="divisor-span">${d}</span>`).join('')}</div></div>`;}
        function applyGlobalHighlightsPythagoras(){
            const sp=document.querySelector('#togglePrimes input').checked, ss=document.querySelector('#toggleSquares input').checked, sc=document.querySelector('#toggleCubes input').checked;
            document.getElementById('togglePrimes').classList.toggle('active',sp);document.getElementById('toggleSquares').classList.toggle('active',ss);document.getElementById('toggleCubes').classList.toggle('active',sc);
            const ab=Array.from(document.querySelectorAll('#multiple-toggles-container-pythagoras input:checked')).map(e=>parseInt(e.parentNode.dataset.base));
            const isOr=document.querySelector('input[name="filterLogic_py"]:checked').value==='OR';
            document.querySelectorAll('#numberGrid td').forEach(td=>{
                const v=parseInt(td.dataset.val); td.style.backgroundColor=''; td.style.color=''; td.classList.remove('highlight-prime','highlight-square','highlight-cube');
                if(ab.length>0){const m=ab.filter(b=>v%b===0);if((isOr&&m.length>0)||(!isOr&&m.length===ab.length)){let rt=0,gt=0,bt=0;m.forEach(b=>{const[r,g,bl]=BASE_COLORS[b];rt+=r;gt+=g;bt+=bl;});if(m.length){const c=m.length;td.style.backgroundColor=`rgba(${Math.round(rt/c)},${Math.round(gt/c)},${Math.round(bt/c)},0.9)`;td.style.color='#fff';}}}
                if(sp&&td.classList.contains('prime'))td.classList.add('highlight-prime');if(ss&&td.classList.contains('square'))td.classList.add('highlight-square');if(sc&&td.classList.contains('cube'))td.classList.add('highlight-cube');
            });
        }

        const pascalMemo=[];function getPascal(n,k){if(k<0||k>n)return 0;if(k===0||k===n)return 1;if(!pascalMemo[n])pascalMemo[n]=[];if(pascalMemo[n][k])return pascalMemo[n][k];return pascalMemo[n][k]=getPascal(n-1,k-1)+getPascal(n-1,k);}
        function generatePascal(rows){currentPascalRows=rows;updateSizingCSS();const c=document.getElementById('pascalTriangleContainer'),sw=document.getElementById('pascal-sum-wrapper'),fw=document.getElementById('pascal-fib-sum-wrapper'),pw=document.getElementById('pascal-pow11-wrapper');c.innerHTML='';sw.innerHTML='';fw.innerHTML='';pw.innerHTML='';pascalMemo.length=0;for(let n=0;n<rows;n++){const rd=document.createElement('div');rd.className='pascal-row';let rs=0;for(let k=0;k<=n;k++){const v=getPascal(n,k);rs+=v;const cel=document.createElement('div');cel.className='pascal-cell-square';cel.textContent=v;cel.dataset.val=v;cel.dataset.n=n;cel.dataset.k=k;if(k===1)cel.classList.add('d-nat');if(k===2)cel.classList.add('d-tri');if(k===3)cel.classList.add('d-tet');cel.onclick=()=>{document.querySelectorAll('.pascal-cell-square.selected').forEach(c=>c.classList.remove('selected'));document.querySelectorAll('.highlight-hockey-stick,.highlight-hockey-puck').forEach(c=>c.classList.remove('highlight-hockey-stick','highlight-hockey-puck'));cel.classList.add('selected');if(k>0&&n>k){cel.classList.add('highlight-hockey-puck');for(let r=k-1;r<n;r++){const s=document.querySelector(`.pascal-cell-square[data-n="${r}"][data-k="${k-1}"]`);if(s)s.classList.add('highlight-hockey-stick');}}updatePascalInspector(v,n,k);};rd.appendChild(cel);}c.appendChild(rd);const sb=document.createElement('div');sb.className='pascal-info-square bg-pow2';sb.textContent=rs;sw.appendChild(sb);let fs=0;for(let i=0;i<=Math.floor(n/2);i++)fs+=getPascal(n-i,i);const fb=document.createElement('div');fb.className='pascal-info-square bg-fib';fb.textContent=fs;fw.appendChild(fb);const pb=document.createElement('div');pb.className='pascal-info-square bg-pow11';pb.textContent=n<6?Math.pow(11,n):"11^"+n;pw.appendChild(pb);}applyGlobalHighlightsPascal();}
        function updatePascalInspector(v,n,k){document.getElementById('pascalInspectorContent').innerHTML=`<div class="text-center"><div class="text-5xl font-bold mb-2 themed-text-accent">${v}</div><div class="text-sm themed-text-secondary font-mono">C(${n}, ${k})</div></div><div class="grid grid-cols-2 gap-2 text-sm mt-4"><div class="themed-bg-inner p-2 rounded">Primo: <b>${isPrime(v)?'S√å':'NO'}</b></div><div class="themed-bg-inner p-2 rounded">Pari: <b>${v%2===0?'S√å':'NO'}</b></div></div><div class="mt-4 text-sm"><p>Modi per scegliere <b>${k}</b> elementi da <b>${n}</b>.</p>${k>0&&n>k?'<div class="themed-bg-inner p-2 rounded mt-2 border-l-4 border-green-500 text-xs">üèè <b>Mazza da Hockey:</b><br>Somma della diagonale evidenziata.</div>':''}</div>`;}
        function applyGlobalHighlightsPascal(){
            const els={oddEven:document.getElementById('togglePascalOddEven'),pow2:document.getElementById('togglePascalPow2'),fib:document.getElementById('togglePascalFibonacci'),pow11:document.getElementById('togglePascalPow11'),nat:document.getElementById('togglePascalNatural'),tri:document.getElementById('togglePascalTriangular'),tet:document.getElementById('togglePascalTetrahedral')};
            for(let k in els)els[k].classList.toggle('active',els[k].querySelector('input').checked);
            const ab=Array.from(document.querySelectorAll('#multiple-toggles-container-pascal input:checked')).map(e=>parseInt(e.parentNode.dataset.base));
            document.getElementById('pascal-sum-wrapper').style.display=els.pow2.classList.contains('active')?'flex':'none';document.getElementById('pascal-fib-sum-wrapper').style.display=els.fib.classList.contains('active')?'flex':'none';document.getElementById('pascal-pow11-wrapper').style.display=els.pow11.classList.contains('active')?'flex':'none';
            document.querySelectorAll('.pascal-cell-square').forEach(cell=>{const v=parseInt(cell.dataset.val);cell.classList.remove('highlight-odd','highlight-even','highlight-factor');cell.style.backgroundColor='';cell.style.color='';
            if(ab.length>0){const m=ab.filter(b=>v>0&&v%b===0);if(m.length>0){let rt=0,gt=0,bt=0;m.forEach(b=>{const[r,g,bl]=BASE_COLORS[b];rt+=r;gt+=g;bt+=bl;});const c=m.length;cell.style.backgroundColor=`rgba(${Math.round(rt/c)},${Math.round(gt/c)},${Math.round(bt/c)},0.9)`;cell.style.color='#fff';}}
            if(els.nat.classList.contains('active')&&cell.classList.contains('d-nat'))cell.style.backgroundColor='#0d9488';if(els.tri.classList.contains('active')&&cell.classList.contains('d-tri'))cell.style.backgroundColor='#d97706';if(els.tet.classList.contains('active')&&cell.classList.contains('d-tet'))cell.style.backgroundColor='#65a30d';
            if(els.oddEven.classList.contains('active'))cell.classList.add(v%2!==0?'highlight-odd':'highlight-even');});
        }

        function checkDivisibility(){const n=parseInt(document.getElementById('numberCheck').value);const d=document.getElementById('divisibilityResults');d.innerHTML='';if(!n||n<0)return;for(let i=2;i<=10;i++){const ok=(n%i===0);const c=document.createElement('div');c.className=`p-4 rounded-lg border-2 flex flex-col items-center justify-center ${ok?'bg-green-900/20 border-green-500 text-green-500':'bg-red-900/20 border-red-500 text-red-500'}`;c.innerHTML=`<span class="text-2xl font-bold mb-1">√∑ ${i}</span><span class="text-xl">${ok?'S√å':'NO'}</span>`;d.appendChild(c);}}

        function nextQuizQuestion(){if(currentQuizQuestion>=shuffledQuestions.length){currentQuizQuestion=0;quizScore=0;startQuiz();return;}const q=shuffledQuestions[currentQuizQuestion];document.getElementById('quizQuestion').innerText=q.question;document.getElementById('quizScore').innerText=`${quizScore}/${shuffledQuestions.length}`;const o=document.getElementById('quizOptions');o.innerHTML='';q.options.forEach((opt,i)=>{const b=document.createElement('button');b.className="w-full text-left p-4 rounded-lg border themed-border hover:bg-gray-700/50 transition";b.innerText=opt;b.onclick=()=>{Array.from(o.children).forEach(k=>k.disabled=true);if(i===q.correct){b.classList.add('bg-green-600','text-white','border-green-600');quizScore++;document.getElementById('quizFeedback').innerHTML=`<span class="text-green-500">Corretto! üéâ</span>`;}else{b.classList.add('bg-red-600','text-white','border-red-600');o.children[q.correct].classList.add('bg-green-600','text-white');document.getElementById('quizFeedback').innerHTML=`<span class="text-red-500">Sbagliato!</span>`;}document.getElementById('nextQuizBtn').classList.remove('hidden');currentQuizQuestion++;document.getElementById('nextQuizBtn').innerText=currentQuizQuestion>=shuffledQuestions.length?"Ricomincia":"Prossima";};o.appendChild(b);});document.getElementById('nextQuizBtn').classList.add('hidden');document.getElementById('quizFeedback').innerHTML='';}
        function startQuiz(){shuffledQuestions=[...quizQuestions].sort(()=>Math.random()-0.5);currentQuizQuestion=0;quizScore=0;nextQuizQuestion();}

        function resetMatching(){matchScore=0;document.getElementById('matchScore').innerText="0/7";document.getElementById('matchingFeedback').innerText="";const d=document.getElementById('divisorsColumn'),r=document.getElementById('rulesColumn');d.innerHTML='';r.innerHTML='';const k=Object.keys(matchingPairs),v=Object.values(matchingPairs),sv=[...v].sort(()=>Math.random()-0.5);k.forEach(key=>{const div=document.createElement('div');div.className="p-3 border themed-border rounded cursor-pointer hover:border-yellow-400 transition font-mono font-bold text-center";div.innerText="√∑ "+key;div.onclick=()=>{document.querySelectorAll('#divisorsColumn .border-yellow-400').forEach(e=>e.classList.remove('border-yellow-400'));if(!div.classList.contains('opacity-50')){div.classList.add('border-yellow-400');selectedDivisor=key;checkMatchLink(div,null);}};d.appendChild(div);});sv.forEach(val=>{const div=document.createElement('div');div.className="p-3 border themed-border rounded cursor-pointer hover:border-yellow-400 transition text-sm text-center";div.innerText=val;div.onclick=()=>{document.querySelectorAll('#rulesColumn .border-yellow-400').forEach(e=>e.classList.remove('border-yellow-400'));if(!div.classList.contains('opacity-50')){div.classList.add('border-yellow-400');selectedRule=val;checkMatchLink(null,div);}};r.appendChild(div);});}
        function checkMatchLink(){if(selectedDivisor&&selectedRule){if(matchingPairs[selectedDivisor]===selectedRule){document.getElementById('matchingFeedback').innerHTML="<span class='text-green-500'>Corretto!</span>";matchScore++;document.getElementById('matchScore').innerText=matchScore+"/7";document.querySelectorAll('#divisorsColumn div').forEach(e=>{if(e.innerText.includes("√∑ "+selectedDivisor)){e.classList.add('opacity-50','bg-green-900/20');e.classList.remove('border-yellow-400');}});document.querySelectorAll('#rulesColumn div').forEach(e=>{if(e.innerText===selectedRule){e.classList.add('opacity-50','bg-green-900/20');e.classList.remove('border-yellow-400');}});selectedDivisor=null;selectedRule=null;}else{document.getElementById('matchingFeedback').innerHTML="<span class='text-red-500'>Riprova...</span>";setTimeout(()=>{document.querySelectorAll('.border-yellow-400').forEach(e=>e.classList.remove('border-yellow-400'));selectedDivisor=null;selectedRule=null;document.getElementById('matchingFeedback').innerHTML="";},1000);}}}

        function buildMultipleToggles(id){const c=document.getElementById(id);if(!c)return;c.innerHTML='';MULTIPLE_BASES.forEach(b=>{const[r,g,bl]=BASE_COLORS[b];const l=document.createElement('label');l.className="toggle-label multiple-toggle text-xs";l.dataset.base=b;l.style.borderColor=`rgb(${r},${g},${bl})`;l.innerHTML=`<input type="checkbox"><span>${b}</span>`;l.querySelector('input').addEventListener('change',(e)=>{l.style.backgroundColor=e.target.checked?`rgba(${r},${g},${bl},0.3)`:'';l.style.color=e.target.checked?(document.body.classList.contains('light')?'black':'white'):'';if(id.includes('pythagoras'))applyGlobalHighlightsPythagoras();else applyGlobalHighlightsPascal();});c.appendChild(l);});}

        document.addEventListener('DOMContentLoaded',()=>{
            loadTheme();
            buildMultipleToggles('multiple-toggles-container-pythagoras');generateGrid(10);document.getElementById('generateGridBtn').onclick=()=>generateGrid(parseInt(document.getElementById('gridSize').value));['togglePrimes','toggleSquares','toggleCubes'].forEach(id=>document.getElementById(id).addEventListener('click',()=>setTimeout(applyGlobalHighlightsPythagoras,10)));document.querySelectorAll('input[name="filterLogic_py"]').forEach(i=>i.addEventListener('change',applyGlobalHighlightsPythagoras));
            buildMultipleToggles('multiple-toggles-container-pascal');generatePascal(10);document.getElementById('generatePascalBtn').onclick=()=>generatePascal(parseInt(document.getElementById('pascalRows').value));['togglePascalOddEven','togglePascalPow2','togglePascalFibonacci','togglePascalPow11','togglePascalNatural','togglePascalTriangular','togglePascalTetrahedral'].forEach(id=>document.getElementById(id).addEventListener('click',()=>setTimeout(applyGlobalHighlightsPascal,10)));
            startQuiz();resetMatching();
            window.addEventListener('resize',updateSizingCSS);
        });
    </script>
</body>
</html>