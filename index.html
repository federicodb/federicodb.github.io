<!DOCTYPE html>
<html lang="it" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Laboratorio Matematico Orfini | Immersive Hub</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Amatic+SC:wght@700&family=Caveat:wght@700&family=Cinzel:wght@700&family=Oswald:wght@500&family=Permanent+Marker&family=Playfair+Display:ital,wght@1,600&family=Press+Start+2P&family=Righteous&family=Space+Mono:ital,wght@0,700;1,700&family=Inter:wght@400;700&family=Syne:wght@700;800&display=swap"
        rel="stylesheet">

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script>
        window.addEventListener('load', () => {
            if (typeof katex === 'undefined') {
                console.error("[MathEngine] CRITICAL: KaTeX library failed to load from CDN.");
            } else {
                console.log("[MathEngine] KaTeX Ready.");
            }
        });
    </script>
    <script src="database.js"></script>

    <style>
        :root {
            --primary: #00bcd4;
            --secondary: #ff4081;
            --bg-dark: #050510;
            --glass: rgba(10, 20, 40, 0.75);
            --glass-solid: rgba(10, 20, 40, 0.95);
            --border: rgba(255, 255, 255, 0.1);
            --font-ui: 'Inter', sans-serif;
        }

        /* --- 3D TAG FONTS --- */
        .font-1 {
            font-family: 'Caveat', cursive !important;
            font-size: 1.3em;
        }

        .font-2 {
            font-family: 'Space Mono', monospace !important;
            letter-spacing: -0.05em;
            font-weight: 700;
        }

        .font-3 {
            font-family: 'Abril Fatface', serif !important;
        }

        .font-4 {
            font-family: 'Permanent Marker', cursive !important;
            transform: rotate(-2deg);
        }

        .font-5 {
            font-family: 'Righteous', cursive !important;
        }

        .font-6 {
            font-family: 'Cinzel', serif !important;
            font-weight: 700;
        }

        .font-7 {
            font-family: 'Amatic SC', cursive !important;
            font-size: 1.5em;
            font-weight: 700;
        }

        .font-8 {
            font-family: 'Oswald', sans-serif !important;
            text-transform: uppercase;
        }

        .font-9 {
            font-family: 'Press Start 2P', cursive !important;
            font-size: 0.7em;
            color: #0f0;
        }

        .font-10 {
            font-family: 'Playfair Display', serif !important;
            font-style: italic;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: var(--bg-dark);
            font-family: var(--font-ui);
            color: white;
            width: 100vw;
            height: 100dvh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        #scene-container {
            position: fixed;
            inset: 0;
            z-index: 0;
            outline: none;
            touch-action: none;
        }

        /* --- HUD --- */
        #ui-hud {
            position: absolute;
            inset: 0;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1.5rem;
        }

        .hud-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: auto;
        }

        .hud-actions {
            display: flex;
            gap: 0.8rem;
            align-items: center;
        }

        .brand-orfini {
            font-family: 'Syne', sans-serif;
            font-size: clamp(1.5rem, 5vw, 3rem);
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 0.8;
            color: #fff;
            text-transform: uppercase;
        }

        .brand-sub {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--primary);
            letter-spacing: 0.3em;
            margin-top: 0.4rem;
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: white;
            width: 42px;
            height: 44px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            pointer-events: auto;
        }

        .btn-icon:hover {
            background: var(--primary);
            color: black;
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .btn-icon svg {
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
        }

        #btn-tags {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 50;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--secondary);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            font-size: 1.4rem;
            pointer-events: auto;
            box-shadow: 0 4px 15px rgba(255, 64, 129, 0.4);
        }

        /* --- OVERLAYS --- */
        .overlay-full {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(5, 5, 15, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s ease;
            overflow-y: auto;
            padding: 2rem;
        }

        .overlay-full.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-card {
            background: var(--glass-solid);
            border: 1px solid var(--border);
            width: 95%;
            max-width: 900px;
            margin: auto;
            border-radius: 32px;
            padding: 3rem;
            position: relative;
            transform: scale(0.9) translateY(30px);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .overlay-full.active .modal-card {
            transform: scale(1) translateY(0);
        }

        .manifesto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .manifesto-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .manifesto-item h4 {
            color: var(--primary);
            margin: 0 0 0.5rem 0;
            font-family: 'Syne', sans-serif;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .manifesto-item p {
            font-size: 0.85rem;
            line-height: 1.5;
            color: #aaa;
            margin: 0;
        }

        /* --- SEARCH GRID --- */
        .list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding-bottom: 5rem;
        }

        #content-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            background: var(--glass-solid);
            border: 1px solid var(--border);
            border-radius: 32px;
            z-index: 60;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s;
        }

        #content-panel.active {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .panel-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* CARDS */
        .project-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 320px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .project-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.06);
        }

        .card-bg {
            position: absolute;
            inset: 0;
            z-index: 0;
            filter: blur(10px) saturate(0);
            opacity: 0.3;
            background-size: cover;
            background-position: center;
        }

        .card-content-wrap {
            position: relative;
            z-index: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .project-card h3 {
            font-family: 'Syne', sans-serif;
            font-size: 1.6rem;
            margin: 0.5rem 0;
            color: #fff;
        }

        .project-card p {
            font-size: 1rem;
            line-height: 1.6;
            color: #bbb;
            flex-grow: 1;
        }

        .mini-tag {
            font-family: 'Space Mono';
            font-size: 0.7rem;
            padding: 6px 12px;
            background: rgba(0, 188, 212, 0.1);
            color: var(--primary);
            border-radius: 50px;
            margin: 0 6px 6px 0;
            display: inline-block;
        }

        /* Tag Content for 3D Nodes */
        .tag-content {
            display: inline-block;
            font-weight: 700;
            color: white;
            padding: 4px 8px;
            white-space: nowrap;
            cursor: pointer;
            pointer-events: auto;
            will-change: transform, opacity;
            transition: color 0.2s;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            backface-visibility: hidden;
        }

        /* .tag-content:hover managed by GalaxyScene.js for synced zoom/glow */

        /* --- MATH DEBRIS TRANSITION STYLES --- */
        /* --- MATH DEBRIS HIGH FIDELITY --- */
        .math-debris {
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            will-change: transform, opacity;
            contain: layout style;
        }

        .debris-hex {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
        }

        .debris-sym {
            position: relative;
            z-index: 1;
            color: #fff;
            white-space: nowrap;
            transition: opacity 0.3s;
            text-shadow: 0 0 8px rgba(0, 188, 212, 0.4);
            font-family: 'KaTeX_Main', serif;
            will-change: opacity, transform;
        }

        @media (max-width: 600px) {
            .list-grid {
                grid-template-columns: 1fr;
            }

            .modal-card {
                padding: 1.5rem;
            }
        }
    </style>
</head>

<body>

    <div id="scene-container"></div>

    <div id="ui-hud">
        <div class="hud-header">
            <div class="brand-container">
                <div class="brand-orfini">ORFINI</div>
                <div class="brand-sub">MATH GALAXY</div>
            </div>
            <div class="hud-actions">
                <button class="btn-icon" id="btn-about" title="Manifesto Didattico">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="4 17 10 11 4 5"></polyline>
                        <line x1="12" y1="19" x2="20" y2="19"></line>
                    </svg>
                </button>
                <button class="btn-icon" id="btn-search" title="Cerca Argomenti">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </button>
                <button class="btn-icon" id="btn-reset" title="Reset Camera">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"></path>
                        <path d="M3 3v9h9"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <button id="btn-tags" title="Mappa Tag">#</button>

    <!-- MANIFESTO MODAL -->
    <div id="about-overlay" class="overlay-full">
        <div class="modal-card">
            <button class="close-btn" id="btn-close-about"
                style="position: absolute; top: 1.5rem; right: 1.5rem;">√ó</button>

            <header style="text-align: center; margin-bottom: 3rem;">
                <div
                    style="width:100px; height:100px; background:linear-gradient(135deg, var(--primary), var(--secondary)); border-radius:24px; margin:0 auto 1.5rem; display:flex; align-items:center; justify-content:center; font-size:2.5rem; box-shadow: 0 10px 30px rgba(0,188,212,0.3);">
                    üë®‚ÄçüöÄ</div>
                <h2 style="margin:0; font-family:'Syne'; font-size:2.5rem; font-weight:800;">Prof. Federico DB</h2>
                <div
                    style="font-family:'Space Mono'; color:var(--primary); font-size:0.9rem; text-transform:uppercase; letter-spacing:3px;">
                    Creative Coder & Designer Didattico</div>
            </header>

            <div style="line-height:1.8; color:#eee;">
                <p
                    style="font-size:1.2rem; color:#fff; font-weight:600; margin-bottom:2rem; border-left:4px solid var(--secondary); padding-left:1.5rem;">
                    "Trasformare il caos creativo in strumenti concreti, accessibili ed esteticamente coerenti."
                </p>

                <p>Benvenuti nell'hub del <strong>Laboratorio Matematico Orfini</strong>. Un ecosistema basato sulla
                    didattica laboratoriale e l'integrazione tecnologica.</p>

                <div class="manifesto-grid">
                    <div class="manifesto-item">
                        <h4>Gamification</h4>
                        <p>Meccaniche di gioco, punti e feedback per potenziare la memoria di lavoro attraverso esercizi
                            brevi e ripetizione spaziata.</p>
                    </div>
                    <div class="manifesto-item">
                        <h4>Problem Based Learning</h4>
                        <p>Matematica applicata a casi studio reali e progetti guidati (PBL) per sviluppare il pensiero
                            critico.</p>
                    </div>
                    <div class="manifesto-item">
                        <h4>Visualizzazione 3D</h4>
                        <p>Grafici interattivi, animazioni e modelli 3D parametrici per rendere tangibili concetti
                            astratti.</p>
                    </div>
                    <div class="manifesto-item">
                        <h4>Didattica Inclusiva</h4>
                        <p>Supporti multisensoriali e strumenti digitali personalizzati per studenti con DSA/ADHD.</p>
                    </div>
                    <div class="manifesto-item">
                        <h4>Pensiero Computazionale</h4>
                        <p>Algoritmi, pseudocodice e logica di programmazione integrati in UDA moderne e
                            multidisciplinari.</p>
                    </div>
                    <div class="manifesto-item">
                        <h4>AI Generativa</h4>
                        <p>Utilizzo strategico dell'AI per la creazione di contenuti e il perfezionamento dei processi
                            iterativi.</p>
                    </div>
                    <div class="manifesto-item">
                        <h4>Cultura Locale</h4>
                        <p>Unione tra riferimenti globali tecnologici e radici del territorio umbro in un linguaggio
                            esteticamente coerente.</p>
                    </div>
                    <div class="manifesto-item">
                        <h4>Metacognizione</h4>
                        <p>Approccio ironico e riflessivo per stimolare l'autovalutazione e la consapevolezza del
                            proprio apprendimento.</p>
                    </div>
                </div>
            </div>

            <footer
                style="margin-top: 3rem; text-align: center; padding-top: 2rem; border-top: 1px solid var(--border);">
                <a href="https://instagram.com/meltingmath" target="_blank" class="btn-icon"
                    style="display:inline-flex; width:auto; padding:0 20px; border-radius:12px; text-decoration:none; gap:10px;">
                    <span>üì∏</span> Segui @meltingmath
                </a>
            </footer>
        </div>
    </div>

    <!-- SEARCH OVERLAY -->
    <div id="list-overlay" class="overlay-full">
        <div style="width:100%; max-width:800px; margin-bottom:2rem; display:flex; gap:1rem;">
            <input type="text" id="search-input" placeholder="Cerca algoritmi o concetti..."
                style="flex:1; background:rgba(255,255,255,0.05); border:1px solid var(--border); color:white; padding:1.2rem; border-radius:16px; outline:none; font-size:1.2rem;">
            <button class="btn-icon" id="btn-close-search" style="width:60px; height:60px;">√ó</button>
        </div>
        <div class="list-grid" id="full-list-grid"></div>
    </div>

    <aside id="content-panel">
        <div class="panel-header">
            <div id="panel-title-text"
                style="font-size:1.8rem; font-weight:800; font-family:'Syne'; color:var(--primary);">Tag</div>
            <button class="close-btn" id="btn-close-panel">√ó</button>
        </div>
        <div class="panel-scroll" id="results-container"></div>
    </aside>

    <div id="media-modal" class="overlay-full">
        <div id="modal-box" style="width:95%; max-width:1100px;"></div>
    </div>

    <script type="module">
        import { GalaxyScene } from './content/assets/js/modules/GalaxyScene.js';
        import { UIManager } from './content/assets/js/modules/UIManager.js';

        function getUniqueTags(data) {
            const counts = {};
            data.forEach(item => item.tags.forEach(tag => counts[tag] = (counts[tag] || 0) + 1));
            return Object.keys(counts).map(tag => ({ text: tag, count: counts[tag] }));
        }

        window.addEventListener('load', () => {
            const initApp = () => {
                try {
                    const galaxyData = getUniqueTags(db);
                    const app3D = new GalaxyScene('scene-container', galaxyData, db, (nodeData) => ui.openPanel(nodeData.text));
                    const ui = new UIManager(db, app3D);

                    document.getElementById('btn-search').onclick = () => ui.toggleSearch();
                    document.getElementById('btn-close-search').onclick = () => ui.closeSearch();
                    document.getElementById('btn-reset').onclick = () => app3D.resetCamera();
                    document.getElementById('btn-close-panel').onclick = () => ui.closePanel();

                    const aboutEl = document.getElementById('about-overlay');
                    document.getElementById('btn-about').onclick = () => aboutEl.classList.add('active');
                    document.getElementById('btn-close-about').onclick = () => aboutEl.classList.remove('active');

                    document.getElementById('btn-tags').onclick = () => {
                        const allTags = getUniqueTags(db).sort((a, b) => b.count - a.count);
                        const container = document.getElementById('results-container');
                        container.innerHTML = '';
                        document.getElementById('panel-title-text').innerText = 'Esplora Mappa';
                        const cloud = document.createElement('div');
                        Object.assign(cloud.style, { display: 'flex', flexWrap: 'wrap', gap: '10px' });
                        allTags.forEach(t => {
                            const btn = document.createElement('button');
                            btn.className = 'mini-tag';
                            Object.assign(btn.style, { cursor: 'pointer', border: '1px solid var(--border)', padding: '10px 20px', borderRadius: '12px', fontSize: '0.9rem', background: 'rgba(255,255,255,0.05)', color: '#fff' });
                            btn.innerHTML = `#${t.text} <small style="opacity:0.5; margin-left:5px;">${t.count}</small>`;
                            btn.onclick = () => ui.openPanel(t.text);
                            cloud.appendChild(btn);
                        });
                        container.appendChild(cloud);
                        document.getElementById('content-panel').classList.add('active');
                    };

                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            ui.closeSearch(); ui.closePanel(); ui.closeModal();
                            aboutEl.classList.remove('active');
                        }
                    });

                    document.getElementById('media-modal').onclick = () => ui.closeModal();
                    document.getElementById('modal-box').onclick = (e) => e.stopPropagation();
                } catch (err) {
                    console.error("Hub Init Failure:", err);
                }
            };

            // Check for KaTeX before starting
            if (typeof katex === 'undefined') {
                const checkKatex = setInterval(() => {
                    if (typeof katex !== 'undefined') {
                        clearInterval(checkKatex);
                        initApp();
                    }
                }, 50);
            } else {
                initApp();
            }
        });
    </script>
</body>

</html>